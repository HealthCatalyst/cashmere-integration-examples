/**
 * @fileoverview added by tsickle
 * Generated from: lib/modal/modal.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ModalWindowComponent } from './modal-window.component';
import { ModalOverlayComponent } from './modal-overlay.component';
import { HcModal } from './modal';
import { ApplicationRef, ComponentFactoryResolver, Injectable, Injector, RendererFactory2, TemplateRef } from '@angular/core';
import { ActiveModal } from './active-modal';
var ModalService = /** @class */ (function () {
    function ModalService(_componentFactory, _injector, _applicationRef, _rendererFactory) {
        this._componentFactory = _componentFactory;
        this._injector = _injector;
        this._applicationRef = _applicationRef;
        /**
         * Defaults to false. Restricts multiple modals from being opened on top of each other
         * (an error will be thrown if attempted). It's generally considered bad practice to open multiple
         * models at once, so only change this with good reason.
         */
        this.allowMultiple = false;
        // start at 2000 (reserved range for modals, see _variables.scss)
        this._zIndexCounter = 2000;
        this._modalsOpen = 0;
        this._renderer = _rendererFactory.createRenderer(null, null);
    }
    /** Opens a new modal either from a Component or a TemplateRef with the options specified in ModalOptions
     * In order to use a component, it must be specified in your module's EntryComponents.
     */
    /**
     * Opens a new modal either from a Component or a TemplateRef with the options specified in ModalOptions
     * In order to use a component, it must be specified in your module's EntryComponents.
     * @template T
     * @param {?} modalContent
     * @param {?=} modalOptions
     * @return {?}
     */
    ModalService.prototype.open = /**
     * Opens a new modal either from a Component or a TemplateRef with the options specified in ModalOptions
     * In order to use a component, it must be specified in your module's EntryComponents.
     * @template T
     * @param {?} modalContent
     * @param {?=} modalOptions
     * @return {?}
     */
    function (modalContent, modalOptions) {
        var _this = this;
        if (!this.allowMultiple && this._modalsOpen !== 0) {
            throw new Error("Multiple modals may not be opened at the same time\n                when the allowMultiple property on ModalService is set to false.");
        }
        /** @type {?} */
        var container = (/** @type {?} */ (document.querySelector('body')));
        /** @type {?} */
        var defaultOptions = {
            container: container,
            data: {},
            ignoreEscapeKey: false,
            size: 'auto',
            ignoreOverlayClick: false
        };
        /** @type {?} */
        var options = tslib_1.__assign({}, defaultOptions, modalOptions);
        if (options.container) {
            container = options.container;
        }
        if (!container) {
            throw new Error('Modal requires that a container be set in the modal options');
        }
        // TODO: HcModal and ActiveModal essentially are the same object with HcModal having refs. Might as well merge them to simplify
        /** @type {?} */
        var modal = new HcModal();
        /** @type {?} */
        var activeModalRef = new ActiveModal();
        modal.data = options.data;
        activeModalRef.data = options.data;
        /** @type {?} */
        var modalInjector = Injector.create({
            providers: [{ provide: ActiveModal, useValue: activeModalRef }],
            parent: this._injector
        });
        // disable scrolling when overlay is present
        this._renderer.addClass(container, 'hc-modal-open');
        modal._removeOpenClass = (/**
         * @return {?}
         */
        function () { return _this._renderer.removeClass(container, 'hc-modal-open'); });
        // Create, attach, and append overlay to container
        /** @type {?} */
        var overlay = this._componentFactory.resolveComponentFactory(ModalOverlayComponent).create(modalInjector);
        this._renderer.setStyle(overlay.location.nativeElement, 'z-index', this._zIndexCounter);
        overlay.instance._ignoreEscapeKey = options.ignoreEscapeKey;
        this._applicationRef.attachView(overlay.hostView);
        container.appendChild(overlay.location.nativeElement);
        modal.overlay = overlay;
        // Create and attach content views; prepare nodes to be
        // transcluded with the window ComponentRef
        /** @type {?} */
        var projectableNodes;
        if (modalContent instanceof TemplateRef) {
            /** @type {?} */
            var embeddedViewRef = modalContent.createEmbeddedView(activeModalRef);
            this._applicationRef.attachView(embeddedViewRef);
            projectableNodes = [embeddedViewRef.rootNodes];
        }
        else {
            /** @type {?} */
            var componentRef = this._componentFactory.resolveComponentFactory(modalContent).create(modalInjector);
            // Set host component style to 100% to allow collapsing of body but not header/footer
            this._renderer.addClass(componentRef.location.nativeElement, 'hc-modal-center-component');
            this._applicationRef.attachView(componentRef.hostView);
            modal.componentRef = (/** @type {?} */ (componentRef));
            projectableNodes = [[componentRef.location.nativeElement]];
        }
        // Create, attach, and append Window to container
        // Apply options
        /** @type {?} */
        var window = this._componentFactory.resolveComponentFactory(ModalWindowComponent).create(modalInjector, projectableNodes);
        this._renderer.setStyle(window.location.nativeElement, 'z-index', this._zIndexCounter + 1);
        window.instance._size = (/** @type {?} */ (options.size));
        window.instance._ignoreOverlayClick = options.ignoreOverlayClick;
        this._applicationRef.attachView(window.hostView);
        container.appendChild(window.location.nativeElement);
        modal.window = window;
        activeModalRef.close = (/**
         * @param {?} result
         * @return {?}
         */
        function (result) {
            modal.close(result);
        });
        activeModalRef.dismiss = (/**
         * @return {?}
         */
        function () { return modal.dismiss(); });
        this._modalsOpen++;
        modal._modalClose.subscribe((/**
         * @return {?}
         */
        function () {
            _this._modalsOpen--;
            modal._modalClose.unsubscribe();
        }));
        this._zIndexCounter += 2;
        return modal;
    };
    ModalService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ModalService.ctorParameters = function () { return [
        { type: ComponentFactoryResolver },
        { type: Injector },
        { type: ApplicationRef },
        { type: RendererFactory2 }
    ]; };
    return ModalService;
}());
export { ModalService };
if (false) {
    /**
     * Defaults to false. Restricts multiple modals from being opened on top of each other
     * (an error will be thrown if attempted). It's generally considered bad practice to open multiple
     * models at once, so only change this with good reason.
     * @type {?}
     */
    ModalService.prototype.allowMultiple;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._zIndexCounter;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._renderer;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._modalsOpen;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._componentFactory;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._injector;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._applicationRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kYWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BoZWFsdGhjYXRhbHlzdC9jYXNobWVyZS8iLCJzb3VyY2VzIjpbImxpYi9tb2RhbC9tb2RhbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBQzlELE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBQ2hFLE9BQU8sRUFBQyxPQUFPLEVBQUMsTUFBTSxTQUFTLENBQUM7QUFDaEMsT0FBTyxFQUNILGNBQWMsRUFDZCx3QkFBd0IsRUFFeEIsVUFBVSxFQUNWLFFBQVEsRUFFUixnQkFBZ0IsRUFDaEIsV0FBVyxFQUVkLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUkzQztJQWFJLHNCQUNZLGlCQUEyQyxFQUMzQyxTQUFtQixFQUNuQixlQUErQixFQUN2QyxnQkFBa0M7UUFIMUIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQUMzQyxjQUFTLEdBQVQsU0FBUyxDQUFVO1FBQ25CLG9CQUFlLEdBQWYsZUFBZSxDQUFnQjs7Ozs7O1FBVjNDLGtCQUFhLEdBQVksS0FBSyxDQUFDOztRQUd2QixtQkFBYyxHQUFHLElBQUksQ0FBQztRQUV0QixnQkFBVyxHQUFXLENBQUMsQ0FBQztRQVE1QixJQUFJLENBQUMsU0FBUyxHQUFHLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVEOztPQUVHOzs7Ozs7Ozs7SUFDSCwyQkFBSTs7Ozs7Ozs7SUFBSixVQUFRLFlBQThCLEVBQUUsWUFBMkI7UUFBbkUsaUJBMEZDO1FBekZHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssQ0FBQyxFQUFFO1lBQy9DLE1BQU0sSUFB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QUM7UUFFSCxJQUFJLENBQUMsY0FBYyxJQUFJLENBQUMsQ0FBQztRQUN6QixPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDOztnQkFuSEosVUFBVTs7OztnQkFkUCx3QkFBd0I7Z0JBR3hCLFFBQVE7Z0JBSlIsY0FBYztnQkFNZCxnQkFBZ0I7O0lBNkhwQixtQkFBQztDQUFBLEFBcEhELElBb0hDO1NBbkhZLFlBQVk7Ozs7Ozs7O0lBS3JCLHFDQUErQjs7Ozs7SUFHL0Isc0NBQThCOzs7OztJQUM5QixpQ0FBNkI7Ozs7O0lBQzdCLG1DQUFnQzs7Ozs7SUFHNUIseUNBQW1EOzs7OztJQUNuRCxpQ0FBMkI7Ozs7O0lBQzNCLHVDQUF1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7TW9kYWxXaW5kb3dDb21wb25lbnR9IGZyb20gJy4vbW9kYWwtd2luZG93LmNvbXBvbmVudCc7XG5pbXBvcnQge01vZGFsT3ZlcmxheUNvbXBvbmVudH0gZnJvbSAnLi9tb2RhbC1vdmVybGF5LmNvbXBvbmVudCc7XG5pbXBvcnQge0hjTW9kYWx9IGZyb20gJy4vbW9kYWwnO1xuaW1wb3J0IHtcbiAgICBBcHBsaWNhdGlvblJlZixcbiAgICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgQ29tcG9uZW50UmVmLFxuICAgIEluamVjdGFibGUsXG4gICAgSW5qZWN0b3IsXG4gICAgUmVuZGVyZXIyLFxuICAgIFJlbmRlcmVyRmFjdG9yeTIsXG4gICAgVGVtcGxhdGVSZWYsXG4gICAgVHlwZVxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7TW9kYWxPcHRpb25zLCBNb2RhbFNpemV9IGZyb20gJy4vbW9kYWwtb3B0aW9ucyc7XG5pbXBvcnQge0FjdGl2ZU1vZGFsfSBmcm9tICcuL2FjdGl2ZS1tb2RhbCc7XG5cbmV4cG9ydCB0eXBlIE1vZGFsQ29udGVudFR5cGUgPSBUeXBlPHt9PiB8IFRlbXBsYXRlUmVmPGFueT47XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBNb2RhbFNlcnZpY2Uge1xuICAgIC8qKiBEZWZhdWx0cyB0byBmYWxzZS4gUmVzdHJpY3RzIG11bHRpcGxlIG1vZGFscyBmcm9tIGJlaW5nIG9wZW5lZCBvbiB0b3Agb2YgZWFjaCBvdGhlclxuICAgICAqIChhbiBlcnJvciB3aWxsIGJlIHRocm93biBpZiBhdHRlbXB0ZWQpLiBJdCdzIGdlbmVyYWxseSBjb25zaWRlcmVkIGJhZCBwcmFjdGljZSB0byBvcGVuIG11bHRpcGxlXG4gICAgICogbW9kZWxzIGF0IG9uY2UsIHNvIG9ubHkgY2hhbmdlIHRoaXMgd2l0aCBnb29kIHJlYXNvbi5cbiAgICAgKi9cbiAgICBhbGxvd011bHRpcGxlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvLyBzdGFydCBhdCAyMDAwIChyZXNlcnZlZCByYW5nZSBmb3IgbW9kYWxzLCBzZWUgX3ZhcmlhYmxlcy5zY3NzKVxuICAgIHByaXZhdGUgX3pJbmRleENvdW50ZXIgPSAyMDAwO1xuICAgIHByaXZhdGUgX3JlbmRlcmVyOiBSZW5kZXJlcjI7XG4gICAgcHJpdmF0ZSBfbW9kYWxzT3BlbjogbnVtYmVyID0gMDtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIF9jb21wb25lbnRGYWN0b3J5OiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgICAgIHByaXZhdGUgX2luamVjdG9yOiBJbmplY3RvcixcbiAgICAgICAgcHJpdmF0ZSBfYXBwbGljYXRpb25SZWY6IEFwcGxpY2F0aW9uUmVmLFxuICAgICAgICBfcmVuZGVyZXJGYWN0b3J5OiBSZW5kZXJlckZhY3RvcnkyXG4gICAgKSB7XG4gICAgICAgIHRoaXMuX3JlbmRlcmVyID0gX3JlbmRlcmVyRmFjdG9yeS5jcmVhdGVSZW5kZXJlcihudWxsLCBudWxsKTtcbiAgICB9XG5cbiAgICAvKiogT3BlbnMgYSBuZXcgbW9kYWwgZWl0aGVyIGZyb20gYSBDb21wb25lbnQgb3IgYSBUZW1wbGF0ZVJlZiB3aXRoIHRoZSBvcHRpb25zIHNwZWNpZmllZCBpbiBNb2RhbE9wdGlvbnNcbiAgICAgKiBJbiBvcmRlciB0byB1c2UgYSBjb21wb25lbnQsIGl0IG11c3QgYmUgc3BlY2lmaWVkIGluIHlvdXIgbW9kdWxlJ3MgRW50cnlDb21wb25lbnRzLlxuICAgICAqL1xuICAgIG9wZW48VD4obW9kYWxDb250ZW50OiBNb2RhbENvbnRlbnRUeXBlLCBtb2RhbE9wdGlvbnM/OiBNb2RhbE9wdGlvbnMpOiBIY01vZGFsPFQ+IHtcbiAgICAgICAgaWYgKCF0aGlzLmFsbG93TXVsdGlwbGUgJiYgdGhpcy5fbW9kYWxzT3BlbiAhPT0gMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNdWx0aXBsZSBtb2RhbHMgbWF5IG5vdCBiZSBvcGVuZWQgYXQgdGhlIHNhbWUgdGltZVxuICAgICAgICAgICAgICAgIHdoZW4gdGhlIGFsbG93TXVsdGlwbGUgcHJvcGVydHkgb24gTW9kYWxTZXJ2aWNlIGlzIHNldCB0byBmYWxzZS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdib2R5JykgYXMgSFRNTEVsZW1lbnQ7XG5cbiAgICAgICAgY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gICAgICAgICAgICBjb250YWluZXIsXG4gICAgICAgICAgICBkYXRhOiB7fSxcbiAgICAgICAgICAgIGlnbm9yZUVzY2FwZUtleTogZmFsc2UsXG4gICAgICAgICAgICBzaXplOiAnYXV0bycsXG4gICAgICAgICAgICBpZ25vcmVPdmVybGF5Q2xpY2s6IGZhbHNlXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7Li4uZGVmYXVsdE9wdGlvbnMsIC4uLm1vZGFsT3B0aW9uc307XG4gICAgICAgIGlmIChvcHRpb25zLmNvbnRhaW5lcikge1xuICAgICAgICAgICAgY29udGFpbmVyID0gb3B0aW9ucy5jb250YWluZXI7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWNvbnRhaW5lcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNb2RhbCByZXF1aXJlcyB0aGF0IGEgY29udGFpbmVyIGJlIHNldCBpbiB0aGUgbW9kYWwgb3B0aW9ucycpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVE9ETzogSGNNb2RhbCBhbmQgQWN0aXZlTW9kYWwgZXNzZW50aWFsbHkgYXJlIHRoZSBzYW1lIG9iamVjdCB3aXRoIEhjTW9kYWwgaGF2aW5nIHJlZnMuIE1pZ2h0IGFzIHdlbGwgbWVyZ2UgdGhlbSB0byBzaW1wbGlmeVxuICAgICAgICBsZXQgbW9kYWwgPSBuZXcgSGNNb2RhbDxUPigpO1xuICAgICAgICBsZXQgYWN0aXZlTW9kYWxSZWYgPSBuZXcgQWN0aXZlTW9kYWwoKTtcbiAgICAgICAgbW9kYWwuZGF0YSA9IG9wdGlvbnMuZGF0YTtcbiAgICAgICAgYWN0aXZlTW9kYWxSZWYuZGF0YSA9IG9wdGlvbnMuZGF0YTtcblxuICAgICAgICBjb25zdCBtb2RhbEluamVjdG9yID0gSW5qZWN0b3IuY3JlYXRlKHtcbiAgICAgICAgICAgIHByb3ZpZGVyczogW3twcm92aWRlOiBBY3RpdmVNb2RhbCwgdXNlVmFsdWU6IGFjdGl2ZU1vZGFsUmVmfV0sXG4gICAgICAgICAgICBwYXJlbnQ6IHRoaXMuX2luamVjdG9yXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIGRpc2FibGUgc2Nyb2xsaW5nIHdoZW4gb3ZlcmxheSBpcyBwcmVzZW50XG4gICAgICAgIHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKGNvbnRhaW5lciwgJ2hjLW1vZGFsLW9wZW4nKTtcbiAgICAgICAgbW9kYWwuX3JlbW92ZU9wZW5DbGFzcyA9ICgpID0+IHRoaXMuX3JlbmRlcmVyLnJlbW92ZUNsYXNzKGNvbnRhaW5lciwgJ2hjLW1vZGFsLW9wZW4nKTtcblxuICAgICAgICAvLyBDcmVhdGUsIGF0dGFjaCwgYW5kIGFwcGVuZCBvdmVybGF5IHRvIGNvbnRhaW5lclxuICAgICAgICBsZXQgb3ZlcmxheSA9IHRoaXMuX2NvbXBvbmVudEZhY3RvcnkucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoTW9kYWxPdmVybGF5Q29tcG9uZW50KS5jcmVhdGUobW9kYWxJbmplY3Rvcik7XG4gICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFN0eWxlKG92ZXJsYXkubG9jYXRpb24ubmF0aXZlRWxlbWVudCwgJ3otaW5kZXgnLCB0aGlzLl96SW5kZXhDb3VudGVyKTtcbiAgICAgICAgb3ZlcmxheS5pbnN0YW5jZS5faWdub3JlRXNjYXBlS2V5ID0gb3B0aW9ucy5pZ25vcmVFc2NhcGVLZXk7XG5cbiAgICAgICAgdGhpcy5fYXBwbGljYXRpb25SZWYuYXR0YWNoVmlldyhvdmVybGF5Lmhvc3RWaWV3KTtcbiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKG92ZXJsYXkubG9jYXRpb24ubmF0aXZlRWxlbWVudCk7XG4gICAgICAgIG1vZGFsLm92ZXJsYXkgPSBvdmVybGF5O1xuXG4gICAgICAgIC8vIENyZWF0ZSBhbmQgYXR0YWNoIGNvbnRlbnQgdmlld3M7IHByZXBhcmUgbm9kZXMgdG8gYmVcbiAgICAgICAgLy8gdHJhbnNjbHVkZWQgd2l0aCB0aGUgd2luZG93IENvbXBvbmVudFJlZlxuICAgICAgICBsZXQgcHJvamVjdGFibGVOb2RlcztcbiAgICAgICAgaWYgKG1vZGFsQ29udGVudCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmKSB7XG4gICAgICAgICAgICBjb25zdCBlbWJlZGRlZFZpZXdSZWYgPSBtb2RhbENvbnRlbnQuY3JlYXRlRW1iZWRkZWRWaWV3KGFjdGl2ZU1vZGFsUmVmKTtcbiAgICAgICAgICAgIHRoaXMuX2FwcGxpY2F0aW9uUmVmLmF0dGFjaFZpZXcoZW1iZWRkZWRWaWV3UmVmKTtcbiAgICAgICAgICAgIHByb2plY3RhYmxlTm9kZXMgPSBbZW1iZWRkZWRWaWV3UmVmLnJvb3ROb2Rlc107XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnRSZWYgPSB0aGlzLl9jb21wb25lbnRGYWN0b3J5LnJlc29sdmVDb21wb25lbnRGYWN0b3J5KG1vZGFsQ29udGVudCkuY3JlYXRlKG1vZGFsSW5qZWN0b3IpO1xuXG4gICAgICAgICAgICAvLyBTZXQgaG9zdCBjb21wb25lbnQgc3R5bGUgdG8gMTAwJSB0byBhbGxvdyBjb2xsYXBzaW5nIG9mIGJvZHkgYnV0IG5vdCBoZWFkZXIvZm9vdGVyXG4gICAgICAgICAgICB0aGlzLl9yZW5kZXJlci5hZGRDbGFzcyhjb21wb25lbnRSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudCwgJ2hjLW1vZGFsLWNlbnRlci1jb21wb25lbnQnKTtcbiAgICAgICAgICAgIHRoaXMuX2FwcGxpY2F0aW9uUmVmLmF0dGFjaFZpZXcoY29tcG9uZW50UmVmLmhvc3RWaWV3KTtcbiAgICAgICAgICAgIG1vZGFsLmNvbXBvbmVudFJlZiA9IDxDb21wb25lbnRSZWY8VD4+Y29tcG9uZW50UmVmO1xuICAgICAgICAgICAgcHJvamVjdGFibGVOb2RlcyA9IFtbY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnRdXTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSwgYXR0YWNoLCBhbmQgYXBwZW5kIFdpbmRvdyB0byBjb250YWluZXJcbiAgICAgICAgLy8gQXBwbHkgb3B0aW9uc1xuICAgICAgICBsZXQgd2luZG93ID0gdGhpcy5fY29tcG9uZW50RmFjdG9yeS5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShNb2RhbFdpbmRvd0NvbXBvbmVudCkuY3JlYXRlKG1vZGFsSW5qZWN0b3IsIHByb2plY3RhYmxlTm9kZXMpO1xuICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRTdHlsZSh3aW5kb3cubG9jYXRpb24ubmF0aXZlRWxlbWVudCwgJ3otaW5kZXgnLCB0aGlzLl96SW5kZXhDb3VudGVyICsgMSk7XG4gICAgICAgIHdpbmRvdy5pbnN0YW5jZS5fc2l6ZSA9IG9wdGlvbnMuc2l6ZSBhcyBNb2RhbFNpemU7XG4gICAgICAgIHdpbmRvdy5pbnN0YW5jZS5faWdub3JlT3ZlcmxheUNsaWNrID0gb3B0aW9ucy5pZ25vcmVPdmVybGF5Q2xpY2s7XG5cbiAgICAgICAgdGhpcy5fYXBwbGljYXRpb25SZWYuYXR0YWNoVmlldyh3aW5kb3cuaG9zdFZpZXcpO1xuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQod2luZG93LmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgICBtb2RhbC53aW5kb3cgPSB3aW5kb3c7XG5cbiAgICAgICAgYWN0aXZlTW9kYWxSZWYuY2xvc2UgPSAocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICAgIG1vZGFsLmNsb3NlKHJlc3VsdCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgYWN0aXZlTW9kYWxSZWYuZGlzbWlzcyA9ICgpID0+IG1vZGFsLmRpc21pc3MoKTtcblxuICAgICAgICB0aGlzLl9tb2RhbHNPcGVuKys7XG4gICAgICAgIG1vZGFsLl9tb2RhbENsb3NlLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9tb2RhbHNPcGVuLS07XG4gICAgICAgICAgICBtb2RhbC5fbW9kYWxDbG9zZS51bnN1YnNjcmliZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl96SW5kZXhDb3VudGVyICs9IDI7XG4gICAgICAgIHJldHVybiBtb2RhbDtcbiAgICB9XG59XG4iXX0=