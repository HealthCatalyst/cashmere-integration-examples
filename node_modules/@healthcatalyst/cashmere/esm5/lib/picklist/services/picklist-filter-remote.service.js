/**
 * @fileoverview added by tsickle
 * Generated from: lib/picklist/services/picklist-filter-remote.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { from, of, Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { Injectable } from '@angular/core';
import { PicklistStateService } from './picklist-state.service';
import { PicklistRemoteQueryOptions } from '../picklist.model';
var PicklistFilterRemoteService = /** @class */ (function () {
    function PicklistFilterRemoteService(stateService) {
        this.stateService = stateService;
        this.currentValuePage = 1;
        this.currentValueSetPage = 1;
        this.cancelSearch = new Subject();
        this.options$ = from([]);
    }
    Object.defineProperty(PicklistFilterRemoteService.prototype, "valueList", {
        get: /**
         * @return {?}
         */
        function () {
            return this.stateService.valueList;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PicklistFilterRemoteService.prototype, "valueSetList", {
        get: /**
         * @return {?}
         */
        function () {
            return this.stateService.valueSetList;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PicklistFilterRemoteService.prototype, "searchTerm", {
        get: /**
         * @return {?}
         */
        function () {
            return this.filterService ? this.filterService.searchTerm : '';
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PicklistFilterRemoteService.prototype, "cancelSearch$", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this.cancelSearch.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?} filterService
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.reset = /**
     * @param {?} filterService
     * @return {?}
     */
    function (filterService) {
        this.filterService = filterService;
        this.currentValuePage = 1;
        this.currentValueSetPage = 1;
    };
    /**
     * @param {?=} type
     * @param {?=} shouldAppend
     * @param {?=} selectAllCount
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.filter = /**
     * @param {?=} type
     * @param {?=} shouldAppend
     * @param {?=} selectAllCount
     * @return {?}
     */
    function (type, shouldAppend, selectAllCount) {
        var _this = this;
        if (type === void 0) { type = 'both'; }
        if (shouldAppend === void 0) { shouldAppend = false; }
        if (selectAllCount === void 0) { selectAllCount = null; }
        if (!this.stateService.optionsSource.getOptions) {
            console.warn('Remote query callback not provided for this picklist.');
            return from([]).subscribe();
        }
        if (this.options$) {
            this.cancelSearch.next();
        }
        /** @type {?} */
        var params = this.buildRemoteQueryParams(type, selectAllCount);
        if (!shouldAppend) {
            this.clearFilteredOptions(type);
        }
        this.resetPagingForSelectAllIfNeeded(selectAllCount);
        this.options$ = this.stateService.optionsSource.getOptions(params).pipe(takeUntil(this.cancelSearch$));
        return this.options$.subscribe((/**
         * @param {?} options
         * @return {?}
         */
        function (options) {
            _this.processIncomingRemoteOptions(options, type, shouldAppend);
        }), (/**
         * @return {?}
         */
        function () {
            console.warn('Unable to filter options');
            _this.clearLists('both');
            return of({});
        }), (/**
         * @return {?}
         */
        function () {
            _this.options$ = of({});
        }));
    };
    /**
     * @private
     * @param {?} options
     * @param {?=} type
     * @param {?=} shouldAppend
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.processIncomingRemoteOptions = /**
     * @private
     * @param {?} options
     * @param {?=} type
     * @param {?=} shouldAppend
     * @return {?}
     */
    function (options, type, shouldAppend) {
        if (type === void 0) { type = 'both'; }
        if (shouldAppend === void 0) { shouldAppend = false; }
        if (!shouldAppend) {
            this.clearLists(type);
        }
        if (this.stateService.optionsSource.isPaged) {
            if (options.pagedValues) {
                this.processPagedValues(options.pagedValues);
            }
            if (options.pagedValueSets) {
                this.processPagedValueSets(options.pagedValueSets);
            }
        }
        else {
            if (options.values) {
                this.stateService.updateValueList(options.values);
            }
            if (options.valueSets) {
                this.stateService.updateValueSetList(options.valueSets);
            }
            this.valueList.additionalRemoteOptions = 0;
            this.valueSetList.additionalRemoteOptions = 0;
        }
    };
    /**
     * @private
     * @param {?} pagedValues
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.processPagedValues = /**
     * @private
     * @param {?} pagedValues
     * @return {?}
     */
    function (pagedValues) {
        this.stateService.updateValueList(pagedValues.values);
        this.valueList.additionalRemoteOptions = pagedValues.totalItems - this.valueList.options.size;
    };
    /**
     * @private
     * @param {?} pagedValueSets
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.processPagedValueSets = /**
     * @private
     * @param {?} pagedValueSets
     * @return {?}
     */
    function (pagedValueSets) {
        this.stateService.updateValueSetList(pagedValueSets.values);
        this.valueSetList.additionalRemoteOptions = pagedValueSets.totalItems - this.valueSetList.options.size;
    };
    /**
     * @private
     * @param {?} type
     * @param {?=} selectAllCount
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.buildRemoteQueryParams = /**
     * @private
     * @param {?} type
     * @param {?=} selectAllCount
     * @return {?}
     */
    function (type, selectAllCount) {
        if (selectAllCount === void 0) { selectAllCount = null; }
        /** @type {?} */
        var params = new PicklistRemoteQueryOptions(this.stateService.picklist, this.searchTerm, type);
        if (type === 'values' || type === 'both') {
            params.valuePageSettings = this.buildPageSettings(this.currentValuePage, selectAllCount);
        }
        if (type === 'valuesets' || type === 'both') {
            params.valueSetPageSettings = this.buildPageSettings(this.currentValueSetPage, selectAllCount);
        }
        return params;
    };
    /**
     * @private
     * @param {?} currentPage
     * @param {?} selectAllCount
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.buildPageSettings = /**
     * @private
     * @param {?} currentPage
     * @param {?} selectAllCount
     * @return {?}
     */
    function (currentPage, selectAllCount) {
        /** @type {?} */
        var pagerSettings = { currentPage: 1, itemsPerPage: this.stateService.optionsSource.pageSize };
        pagerSettings.currentPage = selectAllCount ? 1 : currentPage;
        pagerSettings.itemsPerPage = selectAllCount || pagerSettings.itemsPerPage;
        return pagerSettings;
    };
    /**
     * @private
     * @param {?=} selectAllCount
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.resetPagingForSelectAllIfNeeded = /**
     * @private
     * @param {?=} selectAllCount
     * @return {?}
     */
    function (selectAllCount) {
        if (selectAllCount === void 0) { selectAllCount = null; }
        if (selectAllCount) {
            this.currentValuePage = Math.floor(selectAllCount / this.stateService.optionsSource.pageSize);
        }
    };
    /**
     * @private
     * @param {?} type
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.clearLists = /**
     * @private
     * @param {?} type
     * @return {?}
     */
    function (type) {
        if (type === 'both' || type === 'values') {
            this.stateService.clearList(this.valueList);
        }
        if (type === 'both' || type === 'valuesets') {
            this.stateService.clearList(this.valueSetList);
        }
    };
    /**
     * @private
     * @param {?} type
     * @return {?}
     */
    PicklistFilterRemoteService.prototype.clearFilteredOptions = /**
     * @private
     * @param {?} type
     * @return {?}
     */
    function (type) {
        if (type === 'both' || type === 'values') {
            this.valueList.filteredOptions.length = 0;
        }
        if (type === 'both' || type === 'valuesets') {
            this.valueSetList.filteredOptions.length = 0;
        }
    };
    PicklistFilterRemoteService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    PicklistFilterRemoteService.ctorParameters = function () { return [
        { type: PicklistStateService }
    ]; };
    return PicklistFilterRemoteService;
}());
export { PicklistFilterRemoteService };
if (false) {
    /** @type {?} */
    PicklistFilterRemoteService.prototype.filterService;
    /** @type {?} */
    PicklistFilterRemoteService.prototype.currentValuePage;
    /** @type {?} */
    PicklistFilterRemoteService.prototype.currentValueSetPage;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterRemoteService.prototype.cancelSearch;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterRemoteService.prototype.options$;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterRemoteService.prototype.stateService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlja2xpc3QtZmlsdGVyLXJlbW90ZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGhlYWx0aGNhdGFseXN0L2Nhc2htZXJlLyIsInNvdXJjZXMiOlsibGliL3BpY2tsaXN0L3NlcnZpY2VzL3BpY2tsaXN0LWZpbHRlci1yZW1vdGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxJQUFJLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBZSxNQUFNLE1BQU0sQ0FBQztBQUVqRSxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDekMsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUd6QyxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUU5RCxPQUFPLEVBS0gsMEJBQTBCLEVBRTdCLE1BQU0sbUJBQW1CLENBQUM7QUFFM0I7SUFvQkkscUNBQTJCLFlBQWtDO1FBQWxDLGlCQUFZLEdBQVosWUFBWSxDQUFzQjtRQVJ0RCxxQkFBZ0IsR0FBRyxDQUFDLENBQUM7UUFDckIsd0JBQW1CLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUluQyxhQUFRLEdBQTZDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUVOLENBQUM7SUFqQmpFLHNCQUFXLGtEQUFTOzs7O1FBQXBCO1lBQ0ksT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztRQUN2QyxDQUFDOzs7T0FBQTtJQUNELHNCQUFXLHFEQUFZOzs7O1FBQXZCO1lBQ0ksT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQztRQUMxQyxDQUFDOzs7T0FBQTtJQUNELHNCQUFXLG1EQUFVOzs7O1FBQXJCO1lBQ0ksT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxD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QUMsU0FBUyxDQUFDLENBQUM7U0FDL0M7UUFDRCxJQUFJLElBQUksS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLFdBQVcsRUFBRTtZQUN6QyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDbEQ7SUFDTCxDQUFDOzs7Ozs7SUFFTywwREFBb0I7Ozs7O0lBQTVCLFVBQTZCLElBQXVCO1FBQ2hELElBQUksSUFBSSxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQ3RDLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7U0FDN0M7UUFDRCxJQUFJLElBQUksS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLFdBQVcsRUFBRTtZQUN6QyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1NBQ2hEO0lBQ0wsQ0FBQzs7Z0JBdElKLFVBQVU7Ozs7Z0JBWEgsb0JBQW9COztJQWtKNUIsa0NBQUM7Q0FBQSxBQXZJRCxJQXVJQztTQXRJWSwyQkFBMkI7OztJQUNwQyxvREFBNkM7O0lBVTdDLHVEQUE0Qjs7SUFDNUIsMERBQStCOzs7OztJQUMvQixtREFBMkM7Ozs7O0lBSTNDLCtDQUFzRTs7Ozs7SUFFbkQsbURBQTBDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtmcm9tLCBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCwgU3Vic2NyaXB0aW9ufSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHt0YWtlVW50aWx9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7UGlja2xpc3RGaWx0ZXJTZXJ2aWNlfSBmcm9tICcuL3BpY2tsaXN0LWZpbHRlci5zZXJ2aWNlJztcbmltcG9ydCB7UGlja2xpc3RTdGF0ZVNlcnZpY2V9IGZyb20gJy4vcGlja2xpc3Qtc3RhdGUuc2VydmljZSc7XG5pbXBvcnQge0ZpbHRlcmFibGVTZWxlY3RMaXN0LCBWYWx1ZUxpc3RPcHRpb24sIFZhbHVlU2V0TGlzdE9wdGlvbn0gZnJvbSAnLi4vcGFuZS9waWNrbGlzdC1wYW5lLm1vZGVsJztcbmltcG9ydCB7XG4gICAgSVBhZ2VkQ29sbGVjdGlvbixcbiAgICBJUGlja2xpc3RSZW1vdGVRdWVyeVJlc3BvbnNlLFxuICAgIElWYWx1ZU9wdGlvbixcbiAgICBJVmFsdWVTZXRPcHRpb24sXG4gICAgUGlja2xpc3RSZW1vdGVRdWVyeU9wdGlvbnMsXG4gICAgUGlja2xpc3RWYWx1ZVR5cGVcbn0gZnJvbSAnLi4vcGlja2xpc3QubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGlja2xpc3RGaWx0ZXJSZW1vdGVTZXJ2aWNlIHtcbiAgICBwdWJsaWMgZmlsdGVyU2VydmljZT86IFBpY2tsaXN0RmlsdGVyU2VydmljZTtcbiAgICBwdWJsaWMgZ2V0IHZhbHVlTGlzdCgpOiBGaWx0ZXJhYmxlU2VsZWN0TGlzdDxWYWx1ZUxpc3RPcHRpb24+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGVTZXJ2aWNlLnZhbHVlTGlzdDtcbiAgICB9XG4gICAgcHVibGljIGdldCB2YWx1ZVNldExpc3QoKTogRmlsdGVyYWJsZVNlbGVjdExpc3Q8VmFsdWVTZXRMaXN0T3B0aW9uPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlU2VydmljZS52YWx1ZVNldExpc3Q7XG4gICAgfVxuICAgIHB1YmxpYyBnZXQgc2VhcmNoVGVybSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXJTZXJ2aWNlID8gdGhpcy5maWx0ZXJTZXJ2aWNlLnNlYXJjaFRlcm0gOiAnJztcbiAgICB9XG4gICAgcHVibGljIGN1cnJlbnRWYWx1ZVBhZ2UgPSAxO1xuICAgIHB1YmxpYyBjdXJyZW50VmFsdWVTZXRQYWdlID0gMTtcbiAgICBwcml2YXRlIGNhbmNlbFNlYXJjaCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gICAgcHJpdmF0ZSBnZXQgY2FuY2VsU2VhcmNoJCgpOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuY2VsU2VhcmNoLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cbiAgICBwcml2YXRlIG9wdGlvbnMkOiBPYnNlcnZhYmxlPElQaWNrbGlzdFJlbW90ZVF1ZXJ5UmVzcG9uc2U+ID0gZnJvbShbXSk7XG5cbiAgICBwdWJsaWMgY29uc3RydWN0b3IocHJpdmF0ZSBzdGF0ZVNlcnZpY2U6IFBpY2tsaXN0U3RhdGVTZXJ2aWNlKSB7fVxuXG4gICAgcHVibGljIHJlc2V0KGZpbHRlclNlcnZpY2U6IFBpY2tsaXN0RmlsdGVyU2VydmljZSkge1xuICAgICAgICB0aGlzLmZpbHRlclNlcnZpY2UgPSBmaWx0ZXJTZXJ2aWNlO1xuICAgICAgICB0aGlzLmN1cnJlbnRWYWx1ZVBhZ2UgPSAxO1xuICAgICAgICB0aGlzLmN1cnJlbnRWYWx1ZVNldFBhZ2UgPSAxO1xuICAgIH1cblxuICAgIHB1YmxpYyBmaWx0ZXIodHlwZTogUGlja2xpc3RWYWx1ZVR5cGUgPSAnYm90aCcsIHNob3VsZEFwcGVuZCA9IGZhbHNlLCBzZWxlY3RBbGxDb3VudDogbnVtYmVyIHwgbnVsbCA9IG51bGwpOiBTdWJzY3JpcHRpb24ge1xuICAgICAgICBpZiAoIXRoaXMuc3RhdGVTZXJ2aWNlLm9wdGlvbnNTb3VyY2UuZ2V0T3B0aW9ucykge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdSZW1vdGUgcXVlcnkgY2FsbGJhY2sgbm90IHByb3ZpZGVkIGZvciB0aGlzIHBpY2tsaXN0LicpO1xuICAgICAgICAgICAgcmV0dXJuIGZyb20oW10pLnN1YnNjcmliZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucyQpIHtcbiAgICAgICAgICAgIHRoaXMuY2FuY2VsU2VhcmNoLm5leHQoKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmJ1aWxkUmVtb3RlUXVlcnlQYXJhbXModHlwZSwgc2VsZWN0QWxsQ291bnQpO1xuICAgICAgICBpZiAoIXNob3VsZEFwcGVuZCkge1xuICAgICAgICAgICAgdGhpcy5jbGVhckZpbHRlcmVkT3B0aW9ucyh0eXBlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlc2V0UGFnaW5nRm9yU2VsZWN0QWxsSWZOZWVkZWQoc2VsZWN0QWxsQ291bnQpO1xuICAgICAgICB0aGlzLm9wdGlvbnMkID0gdGhpcy5zdGF0ZVNlcnZpY2Uub3B0aW9uc1NvdXJjZS5nZXRPcHRpb25zKHBhcmFtcykucGlwZSh0YWtlVW50aWwodGhpcy5jYW5jZWxTZWFyY2gkKSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucyQuc3Vic2NyaWJlKFxuICAgICAgICAgICAgb3B0aW9ucyA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW5jb21pbmdSZW1vdGVPcHRpb25zKG9wdGlvbnMsIHR5cGUsIHNob3VsZEFwcGVuZCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignVW5hYmxlIHRvIGZpbHRlciBvcHRpb25zJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5jbGVhckxpc3RzKCdib3RoJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKHt9KTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zJCA9IG9mKHt9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3NJbmNvbWluZ1JlbW90ZU9wdGlvbnMob3B0aW9uczogSVBpY2tsaXN0UmVtb3RlUXVlcnlSZXNwb25zZSwgdHlwZTogUGlja2xpc3RWYWx1ZVR5cGUgPSAnYm90aCcsIHNob3VsZEFwcGVuZCA9IGZhbHNlKSB7XG4gICAgICAgIGlmICghc2hvdWxkQXBwZW5kKSB7XG4gICAgICAgICAgICB0aGlzLmNsZWFyTGlzdHModHlwZSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5zdGF0ZVNlcnZpY2Uub3B0aW9uc1NvdXJjZS5pc1BhZ2VkKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5wYWdlZFZhbHVlcykge1xuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1BhZ2VkVmFsdWVzKG9wdGlvbnMucGFnZWRWYWx1ZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFnZWRWYWx1ZVNldHMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NQYWdlZFZhbHVlU2V0cyhvcHRpb25zLnBhZ2VkVmFsdWVTZXRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnZhbHVlcykge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVTZXJ2aWNlLnVwZGF0ZVZhbHVlTGlzdChvcHRpb25zLnZhbHVlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0aW9ucy52YWx1ZVNldHMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlU2VydmljZS51cGRhdGVWYWx1ZVNldExpc3Qob3B0aW9ucy52YWx1ZVNldHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy52YWx1ZUxpc3QuYWRkaXRpb25hbFJlbW90ZU9wdGlvbnMgPSAwO1xuICAgICAgICAgICAgdGhpcy52YWx1ZVNldExpc3QuYWRkaXRpb25hbFJlbW90ZU9wdGlvbnMgPSAwO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzUGFnZWRWYWx1ZXMocGFnZWRWYWx1ZXM6IElQYWdlZENvbGxlY3Rpb248SVZhbHVlT3B0aW9uPikge1xuICAgICAgICB0aGlzLnN0YXRlU2VydmljZS51cGRhdGVWYWx1ZUxpc3QocGFnZWRWYWx1ZXMudmFsdWVzKTtcbiAgICAgICAgdGhpcy52YWx1ZUxpc3QuYWRkaXRpb25hbFJlbW90ZU9wdGlvbnMgPSBwYWdlZFZhbHVlcy50b3RhbEl0ZW1zIC0gdGhpcy52YWx1ZUxpc3Qub3B0aW9ucy5zaXplO1xuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2Vzc1BhZ2VkVmFsdWVTZXRzKHBhZ2VkVmFsdWVTZXRzOiBJUGFnZWRDb2xsZWN0aW9uPElWYWx1ZVNldE9wdGlvbj4pIHtcbiAgICAgICAgdGhpcy5zdGF0ZVNlcnZpY2UudXBkYXRlVmFsdWVTZXRMaXN0KHBhZ2VkVmFsdWVTZXRzLnZhbHVlcyk7XG4gICAgICAgIHRoaXMudmFsdWVTZXRMaXN0LmFkZGl0aW9uYWxSZW1vdGVPcHRpb25zID0gcGFnZWRWYWx1ZVNldHMudG90YWxJdGVtcyAtIHRoaXMudmFsdWVTZXRMaXN0Lm9wdGlvbnMuc2l6ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJ1aWxkUmVtb3RlUXVlcnlQYXJhbXModHlwZTogUGlja2xpc3RWYWx1ZVR5cGUsIHNlbGVjdEFsbENvdW50OiBudW1iZXIgfCBudWxsID0gbnVsbCk6IFBpY2tsaXN0UmVtb3RlUXVlcnlPcHRpb25zIHtcbiAgICAgICAgY29uc3QgcGFyYW1zID0gbmV3IFBpY2tsaXN0UmVtb3RlUXVlcnlPcHRpb25zKHRoaXMuc3RhdGVTZXJ2aWNlLnBpY2tsaXN0LCB0aGlzLnNlYXJjaFRlcm0sIHR5cGUpO1xuICAgICAgICBpZiAodHlwZSA9PT0gJ3ZhbHVlcycgfHwgdHlwZSA9PT0gJ2JvdGgnKSB7XG4gICAgICAgICAgICBwYXJhbXMudmFsdWVQYWdlU2V0dGluZ3MgPSB0aGlzLmJ1aWxkUGFnZVNldHRpbmdzKHRoaXMuY3VycmVudFZhbHVlUGFnZSwgc2VsZWN0QWxsQ291bnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGUgPT09ICd2YWx1ZXNldHMnIHx8IHR5cGUgPT09ICdib3RoJykge1xuICAgICAgICAgICAgcGFyYW1zLnZhbHVlU2V0UGFnZVNldHRpbmdzID0gdGhpcy5idWlsZFBhZ2VTZXR0aW5ncyh0aGlzLmN1cnJlbnRWYWx1ZVNldFBhZ2UsIHNlbGVjdEFsbENvdW50KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcGFyYW1zO1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRQYWdlU2V0dGluZ3MoY3VycmVudFBhZ2U6IG51bWJlciwgc2VsZWN0QWxsQ291bnQ6IG51bWJlciB8IG51bGwpIHtcbiAgICAgICAgY29uc3QgcGFnZXJTZXR0aW5ncyA9IHtjdXJyZW50UGFnZTogMSwgaXRlbXNQZXJQYWdlOiB0aGlzLnN0YXRlU2VydmljZS5vcHRpb25zU291cmNlLnBhZ2VTaXplfTtcbiAgICAgICAgcGFnZXJTZXR0aW5ncy5jdXJyZW50UGFnZSA9IHNlbGVjdEFsbENvdW50ID8gMSA6IGN1cnJlbnRQYWdlO1xuICAgICAgICBwYWdlclNldHRpbmdzLml0ZW1zUGVyUGFnZSA9IHNlbGVjdEFsbENvdW50IHx8IHBhZ2VyU2V0dGluZ3MuaXRlbXNQZXJQYWdlO1xuICAgICAgICByZXR1cm4gcGFnZXJTZXR0aW5ncztcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlc2V0UGFnaW5nRm9yU2VsZWN0QWxsSWZOZWVkZWQoc2VsZWN0QWxsQ291bnQ6IG51bWJlciB8IG51bGwgPSBudWxsKSB7XG4gICAgICAgIGlmIChzZWxlY3RBbGxDb3VudCkge1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50VmFsdWVQYWdlID0gTWF0aC5mbG9vcihzZWxlY3RBbGxDb3VudCAvIHRoaXMuc3RhdGVTZXJ2aWNlLm9wdGlvbnNTb3VyY2UucGFnZVNpemUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjbGVhckxpc3RzKHR5cGU6IFBpY2tsaXN0VmFsdWVUeXBlKSB7XG4gICAgICAgIGlmICh0eXBlID09PSAnYm90aCcgfHwgdHlwZSA9PT0gJ3ZhbHVlcycpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGVTZXJ2aWNlLmNsZWFyTGlzdCh0aGlzLnZhbHVlTGlzdCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUgPT09ICdib3RoJyB8fCB0eXBlID09PSAndmFsdWVzZXRzJykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZVNlcnZpY2UuY2xlYXJMaXN0KHRoaXMudmFsdWVTZXRMaXN0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYXJGaWx0ZXJlZE9wdGlvbnModHlwZTogUGlja2xpc3RWYWx1ZVR5cGUpIHtcbiAgICAgICAgaWYgKHR5cGUgPT09ICdib3RoJyB8fCB0eXBlID09PSAndmFsdWVzJykge1xuICAgICAgICAgICAgdGhpcy52YWx1ZUxpc3QuZmlsdGVyZWRPcHRpb25zLmxlbmd0aCA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUgPT09ICdib3RoJyB8fCB0eXBlID09PSAndmFsdWVzZXRzJykge1xuICAgICAgICAgICAgdGhpcy52YWx1ZVNldExpc3QuZmlsdGVyZWRPcHRpb25zLmxlbmd0aCA9IDA7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=