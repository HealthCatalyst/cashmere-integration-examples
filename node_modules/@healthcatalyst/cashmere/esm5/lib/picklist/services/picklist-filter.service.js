/**
 * @fileoverview added by tsickle
 * Generated from: lib/picklist/services/picklist-filter.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { WorkTrackerService } from '../../shared/work-tracker.service';
import { PicklistFilterRemoteService } from './picklist-filter-remote.service';
import { PicklistFilterLocalService } from './picklist-filter-local.service';
import { PicklistStateService } from './picklist-state.service';
var PicklistFilterService = /** @class */ (function () {
    function PicklistFilterService(workTracker, stateService, remoteFilterService, localFilterService) {
        this.workTracker = workTracker;
        this.stateService = stateService;
        this.remoteFilterService = remoteFilterService;
        this.localFilterService = localFilterService;
        this.searchTerm = '';
    }
    Object.defineProperty(PicklistFilterService.prototype, "valueList", {
        get: /**
         * @return {?}
         */
        function () {
            return this.stateService.valueList;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PicklistFilterService.prototype, "valueSetList", {
        get: /**
         * @return {?}
         */
        function () {
            return this.stateService.valueSetList;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PicklistFilterService.prototype, "searchTokens", {
        get: /**
         * @return {?}
         */
        function () {
            return this.searchTerm
                .toLocaleLowerCase()
                .replace(/\s+/g, ' ')
                .split(' ');
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    PicklistFilterService.prototype.reset = /**
     * @return {?}
     */
    function () {
        this.remoteFilterService.reset(this);
        this.searchTerm = '';
    };
    /**
     * @param {?} searchTerm
     * @return {?}
     */
    PicklistFilterService.prototype.runFilter = /**
     * @param {?} searchTerm
     * @return {?}
     */
    function (searchTerm) {
        var _this = this;
        this.searchTerm = searchTerm;
        if (!this.stateService.optionsSource.isPaged) {
            this.localFilterService.filter(this.valueList, this.searchTokens);
            this.localFilterService.filter(this.valueSetList, this.searchTokens);
        }
        else {
            this.remoteFilterService.currentValuePage = 1;
            this.remoteFilterService.currentValueSetPage = 1;
            /** @type {?} */
            var workTracker = this.workTracker.startObservable((/**
             * @return {?}
             */
            function () { return _this.remoteFilterService.filter(); }));
            this.showListLoadingIndicators(workTracker, 'both');
        }
    };
    /**
     * @param {?=} type
     * @param {?=} shouldAppend
     * @param {?=} selectAllCount
     * @return {?}
     */
    PicklistFilterService.prototype.filterOptionsRemote = /**
     * @param {?=} type
     * @param {?=} shouldAppend
     * @param {?=} selectAllCount
     * @return {?}
     */
    function (type, shouldAppend, selectAllCount) {
        if (type === void 0) { type = 'both'; }
        if (shouldAppend === void 0) { shouldAppend = false; }
        if (selectAllCount === void 0) { selectAllCount = null; }
        return this.remoteFilterService.filter(type, shouldAppend, selectAllCount);
    };
    /**
     * @param {?=} type
     * @param {?=} autoLoadMore
     * @return {?}
     */
    PicklistFilterService.prototype.loadMore = /**
     * @param {?=} type
     * @param {?=} autoLoadMore
     * @return {?}
     */
    function (type, autoLoadMore) {
        var _this = this;
        if (type === void 0) { type = 'both'; }
        if (autoLoadMore === void 0) { autoLoadMore = false; }
        if (type === 'both' || type === 'values') {
            this.remoteFilterService.currentValuePage++;
        }
        if (type === 'both' || type === 'valuesets') {
            this.remoteFilterService.currentValueSetPage++;
        }
        /** @type {?} */
        var loading$ = this.workTracker.startObservable((/**
         * @return {?}
         */
        function () { return _this.filterOptionsRemote(type, true); }));
        this.showListLoadingIndicators(loading$, type, !autoLoadMore);
    };
    /**
     * @param {?} numberToLoad
     * @return {?}
     */
    PicklistFilterService.prototype.loadForSelectAll = /**
     * @param {?} numberToLoad
     * @return {?}
     */
    function (numberToLoad) {
        var _this = this;
        /** @type {?} */
        var loading$ = this.workTracker.startObservable((/**
         * @return {?}
         */
        function () { return _this.filterOptionsRemote('values', false, numberToLoad); }));
        this.showListLoadingIndicators(loading$, 'values');
        return loading$;
    };
    /**
     * @return {?}
     */
    PicklistFilterService.prototype.reloadIfEmpty = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var valuesNeedReload = this.valueList.options.size === 0 && this.valueList.additionalRemoteOptions > 0;
        /** @type {?} */
        var valueSetsNeedReload = this.valueSetList.options.size === 0 && this.valueSetList.additionalRemoteOptions > 0;
        if (valuesNeedReload || valueSetsNeedReload) {
            this.runFilter(this.searchTerm);
        }
    };
    /**
     * @param {?} valuesMap
     * @param {?} list
     * @return {?}
     */
    PicklistFilterService.prototype.preFilterOptionsForRemoteMode = /**
     * @param {?} valuesMap
     * @param {?} list
     * @return {?}
     */
    function (valuesMap, list) {
        var _this = this;
        // if server is handling filtering, but I want to avoid the round trip to the server when moving options
        // I need to double check that those options belong before adding them, or risk errant option counts
        valuesMap.forEach((/**
         * @param {?} v
         * @return {?}
         */
        function (v) {
            if (!_this.localFilterService.itemHasSearchTokens(list, v, _this.searchTokens)) {
                valuesMap.delete(v.code);
            }
        }));
    };
    /**
     * @param {?} workTracker
     * @param {?=} type
     * @param {?=} isAppending
     * @return {?}
     */
    PicklistFilterService.prototype.showListLoadingIndicators = /**
     * @param {?} workTracker
     * @param {?=} type
     * @param {?=} isAppending
     * @return {?}
     */
    function (workTracker, type, isAppending) {
        if (type === void 0) { type = 'both'; }
        if (isAppending === void 0) { isAppending = false; }
        if (type === 'both' || type === 'values') {
            this.showLoadingIndicatorForList(this.valueList, workTracker, isAppending);
        }
        if (type === 'both' || type === 'valuesets') {
            this.showLoadingIndicatorForList(this.valueSetList, workTracker, isAppending);
        }
    };
    /**
     * @private
     * @param {?} list
     * @param {?} tracker
     * @param {?=} isAppending
     * @return {?}
     */
    PicklistFilterService.prototype.showLoadingIndicatorForList = /**
     * @private
     * @param {?} list
     * @param {?} tracker
     * @param {?=} isAppending
     * @return {?}
     */
    function (list, tracker, isAppending) {
        if (isAppending === void 0) { isAppending = false; }
        if (isAppending) {
            list.appendingOptions = tracker;
        }
        else {
            list.loadingOptions = tracker;
        }
    };
    PicklistFilterService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    PicklistFilterService.ctorParameters = function () { return [
        { type: WorkTrackerService },
        { type: PicklistStateService },
        { type: PicklistFilterRemoteService },
        { type: PicklistFilterLocalService }
    ]; };
    return PicklistFilterService;
}());
export { PicklistFilterService };
if (false) {
    /** @type {?} */
    PicklistFilterService.prototype.searchTerm;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterService.prototype.workTracker;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterService.prototype.stateService;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterService.prototype.remoteFilterService;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterService.prototype.localFilterService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlja2xpc3QtZmlsdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaGVhbHRoY2F0YWx5c3QvY2FzaG1lcmUvIiwic291cmNlcyI6WyJsaWIvcGlja2xpc3Qvc2VydmljZXMvcGlja2xpc3QtZmlsdGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBS3pDLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLG1DQUFtQyxDQUFDO0FBQ3JFLE9BQU8sRUFBQywyQkFBMkIsRUFBQyxNQUFNLGtDQUFrQyxDQUFDO0FBQzdFLE9BQU8sRUFBQywwQkFBMEIsRUFBQyxNQUFNLGlDQUFpQyxDQUFDO0FBQzNFLE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBRTlEO0lBZ0JJLCtCQUNZLFdBQStCLEVBQy9CLFlBQWtDLEVBQ2xDLG1CQUFnRCxFQUNoRCxrQkFBOEM7UUFIOUMsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBQy9CLGlCQUFZLEdBQVosWUFBWSxDQUFzQjtRQUNsQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQTZCO1FBQ2hELHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBNEI7UUFObkQsZUFBVSxHQUFHLEVBQUUsQ0FBQztJQU9wQixDQUFDO0lBbkJKLHNCQUFXLDRDQUFTOzs7O1FBQXBCO1lBQ0ksT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztRQUN2QyxDQUFDOzs7T0FBQTtJQUNELHNCQUFXLCtDQUFZOzs7O1FBQXZCO1lBQ0ksT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQztRQUMxQyxDQUFDOzs7T0FBQTtJQUNELHNCQUFXLCtDQUFZOzs7O1FBQXZCO1lBQ0ksT0FBTyxJQUFJLENBQUMsVUFBVTtpQkFDakIsaUJBQWlCLEVBQUU7aUJBQ25CLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFD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QUEyQixDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1NBQ2pGO0lBQ0wsQ0FBQzs7Ozs7Ozs7SUFFTywyREFBMkI7Ozs7Ozs7SUFBbkMsVUFBb0MsSUFBNEMsRUFBRSxPQUE0QixFQUFFLFdBQW1CO1FBQW5CLDRCQUFBLEVBQUEsbUJBQW1CO1FBQy9ILElBQUksV0FBVyxFQUFFO1lBQ2IsSUFBSSxDQUFDLGdCQUFnQixHQUFHLE9BQU8sQ0FBQztTQUNuQzthQUFNO1lBQ0gsSUFBSSxDQUFDLGNBQWMsR0FBRyxPQUFPLENBQUM7U0FDakM7SUFDTCxDQUFDOztnQkEvRkosVUFBVTs7OztnQkFMSCxrQkFBa0I7Z0JBR2xCLG9CQUFvQjtnQkFGcEIsMkJBQTJCO2dCQUMzQiwwQkFBMEI7O0lBbUdsQyw0QkFBQztDQUFBLEFBaEdELElBZ0dDO1NBL0ZZLHFCQUFxQjs7O0lBYTlCLDJDQUF1Qjs7Ozs7SUFHbkIsNENBQXVDOzs7OztJQUN2Qyw2Q0FBMEM7Ozs7O0lBQzFDLG9EQUF3RDs7Ozs7SUFDeEQsbURBQXNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9ufSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHtGaWx0ZXJhYmxlU2VsZWN0TGlzdCwgU2VsZWN0TGlzdE9wdGlvbiwgVmFsdWVMaXN0T3B0aW9uLCBWYWx1ZVNldExpc3RPcHRpb259IGZyb20gJy4uL3BhbmUvcGlja2xpc3QtcGFuZS5tb2RlbCc7XG5pbXBvcnQge1BpY2tsaXN0VmFsdWVUeXBlfSBmcm9tICcuLi9waWNrbGlzdC5tb2RlbCc7XG5pbXBvcnQge1dvcmtUcmFja2VyU2VydmljZX0gZnJvbSAnLi4vLi4vc2hhcmVkL3dvcmstdHJhY2tlci5zZXJ2aWNlJztcbmltcG9ydCB7UGlja2xpc3RGaWx0ZXJSZW1vdGVTZXJ2aWNlfSBmcm9tICcuL3BpY2tsaXN0LWZpbHRlci1yZW1vdGUuc2VydmljZSc7XG5pbXBvcnQge1BpY2tsaXN0RmlsdGVyTG9jYWxTZXJ2aWNlfSBmcm9tICcuL3BpY2tsaXN0LWZpbHRlci1sb2NhbC5zZXJ2aWNlJztcbmltcG9ydCB7UGlja2xpc3RTdGF0ZVNlcnZpY2V9IGZyb20gJy4vcGlja2xpc3Qtc3RhdGUuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQaWNrbGlzdEZpbHRlclNlcnZpY2Uge1xuICAgIHB1YmxpYyBnZXQgdmFsdWVMaXN0KCk6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFZhbHVlTGlzdE9wdGlvbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZVNlcnZpY2UudmFsdWVMaXN0O1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0IHZhbHVlU2V0TGlzdCgpOiBGaWx0ZXJhYmxlU2VsZWN0TGlzdDxWYWx1ZVNldExpc3RPcHRpb24+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGVTZXJ2aWNlLnZhbHVlU2V0TGlzdDtcbiAgICB9XG4gICAgcHVibGljIGdldCBzZWFyY2hUb2tlbnMoKTogc3RyaW5nW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5zZWFyY2hUZXJtXG4gICAgICAgICAgICAudG9Mb2NhbGVMb3dlckNhc2UoKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xccysvZywgJyAnKVxuICAgICAgICAgICAgLnNwbGl0KCcgJyk7XG4gICAgfVxuICAgIHB1YmxpYyBzZWFyY2hUZXJtID0gJyc7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSB3b3JrVHJhY2tlcjogV29ya1RyYWNrZXJTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHN0YXRlU2VydmljZTogUGlja2xpc3RTdGF0ZVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgcmVtb3RlRmlsdGVyU2VydmljZTogUGlja2xpc3RGaWx0ZXJSZW1vdGVTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvY2FsRmlsdGVyU2VydmljZTogUGlja2xpc3RGaWx0ZXJMb2NhbFNlcnZpY2VcbiAgICApIHt9XG5cbiAgICBwdWJsaWMgcmVzZXQoKSB7XG4gICAgICAgIHRoaXMucmVtb3RlRmlsdGVyU2VydmljZS5yZXNldCh0aGlzKTtcbiAgICAgICAgdGhpcy5zZWFyY2hUZXJtID0gJyc7XG4gICAgfVxuXG4gICAgcHVibGljIHJ1bkZpbHRlcihzZWFyY2hUZXJtOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5zZWFyY2hUZXJtID0gc2VhcmNoVGVybTtcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlU2VydmljZS5vcHRpb25zU291cmNlLmlzUGFnZWQpIHtcbiAgICAgICAgICAgIHRoaXMubG9jYWxGaWx0ZXJTZXJ2aWNlLmZpbHRlcih0aGlzLnZhbHVlTGlzdCwgdGhpcy5zZWFyY2hUb2tlbnMpO1xuICAgICAgICAgICAgdGhpcy5sb2NhbEZpbHRlclNlcnZpY2UuZmlsdGVyKHRoaXMudmFsdWVTZXRMaXN0LCB0aGlzLnNlYXJjaFRva2Vucyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJlbW90ZUZpbHRlclNlcnZpY2UuY3VycmVudFZhbHVlUGFnZSA9IDE7XG4gICAgICAgICAgICB0aGlzLnJlbW90ZUZpbHRlclNlcnZpY2UuY3VycmVudFZhbHVlU2V0UGFnZSA9IDE7XG4gICAgICAgICAgICBjb25zdCB3b3JrVHJhY2tlciA9IHRoaXMud29ya1RyYWNrZXIuc3RhcnRPYnNlcnZhYmxlKCgpID0+IHRoaXMucmVtb3RlRmlsdGVyU2VydmljZS5maWx0ZXIoKSk7XG4gICAgICAgICAgICB0aGlzLnNob3dMaXN0TG9hZGluZ0luZGljYXRvcnMod29ya1RyYWNrZXIsICdib3RoJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZmlsdGVyT3B0aW9uc1JlbW90ZSh0eXBlOiBQaWNrbGlzdFZhbHVlVHlwZSA9ICdib3RoJywgc2hvdWxkQXBwZW5kID0gZmFsc2UsIHNlbGVjdEFsbENvdW50OiBudW1iZXIgfCBudWxsID0gbnVsbCk6IFN1YnNjcmlwdGlvbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlbW90ZUZpbHRlclNlcnZpY2UuZmlsdGVyKHR5cGUsIHNob3VsZEFwcGVuZCwgc2VsZWN0QWxsQ291bnQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBsb2FkTW9yZSh0eXBlOiBQaWNrbGlzdFZhbHVlVHlwZSA9ICdib3RoJywgYXV0b0xvYWRNb3JlID0gZmFsc2UpIHtcbiAgICAgICAgaWYgKHR5cGUgPT09ICdib3RoJyB8fCB0eXBlID09PSAndmFsdWVzJykge1xuICAgICAgICAgICAgdGhpcy5yZW1vdGVGaWx0ZXJTZXJ2aWNlLmN1cnJlbnRWYWx1ZVBhZ2UrKztcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZSA9PT0gJ2JvdGgnIHx8IHR5cGUgPT09ICd2YWx1ZXNldHMnKSB7XG4gICAgICAgICAgICB0aGlzLnJlbW90ZUZpbHRlclNlcnZpY2UuY3VycmVudFZhbHVlU2V0UGFnZSsrO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGxvYWRpbmckID0gdGhpcy53b3JrVHJhY2tlci5zdGFydE9ic2VydmFibGUoKCkgPT4gdGhpcy5maWx0ZXJPcHRpb25zUmVtb3RlKHR5cGUsIHRydWUpKTtcbiAgICAgICAgdGhpcy5zaG93TGlzdExvYWRpbmdJbmRpY2F0b3JzKGxvYWRpbmckLCB0eXBlLCAhYXV0b0xvYWRNb3JlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZEZvclNlbGVjdEFsbChudW1iZXJUb0xvYWQ6IG51bWJlcik6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBsb2FkaW5nJCA9IHRoaXMud29ya1RyYWNrZXIuc3RhcnRPYnNlcnZhYmxlKCgpID0+IHRoaXMuZmlsdGVyT3B0aW9uc1JlbW90ZSgndmFsdWVzJywgZmFsc2UsIG51bWJlclRvTG9hZCkpO1xuICAgICAgICB0aGlzLnNob3dMaXN0TG9hZGluZ0luZGljYXRvcnMobG9hZGluZyQsICd2YWx1ZXMnKTtcbiAgICAgICAgcmV0dXJuIGxvYWRpbmckO1xuICAgIH1cblxuICAgIHB1YmxpYyByZWxvYWRJZkVtcHR5KCkge1xuICAgICAgICBjb25zdCB2YWx1ZXNOZWVkUmVsb2FkID0gdGhpcy52YWx1ZUxpc3Qub3B0aW9ucy5zaXplID09PSAwICYmIHRoaXMudmFsdWVMaXN0LmFkZGl0aW9uYWxSZW1vdGVPcHRpb25zID4gMDtcbiAgICAgICAgY29uc3QgdmFsdWVTZXRzTmVlZFJlbG9hZCA9IHRoaXMudmFsdWVTZXRMaXN0Lm9wdGlvbnMuc2l6ZSA9PT0gMCAmJiB0aGlzLnZhbHVlU2V0TGlzdC5hZGRpdGlvbmFsUmVtb3RlT3B0aW9ucyA+IDA7XG4gICAgICAgIGlmICh2YWx1ZXNOZWVkUmVsb2FkIHx8IHZhbHVlU2V0c05lZWRSZWxvYWQpIHtcbiAgICAgICAgICAgIHRoaXMucnVuRmlsdGVyKHRoaXMuc2VhcmNoVGVybSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgcHJlRmlsdGVyT3B0aW9uc0ZvclJlbW90ZU1vZGUodmFsdWVzTWFwOiBNYXA8c3RyaW5nLCBTZWxlY3RMaXN0T3B0aW9uPiwgbGlzdDogRmlsdGVyYWJsZVNlbGVjdExpc3Q8U2VsZWN0TGlzdE9wdGlvbj4pIHtcbiAgICAgICAgLy8gaWYgc2VydmVyIGlzIGhhbmRsaW5nIGZpbHRlcmluZywgYnV0IEkgd2FudCB0byBhdm9pZCB0aGUgcm91bmQgdHJpcCB0byB0aGUgc2VydmVyIHdoZW4gbW92aW5nIG9wdGlvbnNcbiAgICAgICAgLy8gSSBuZWVkIHRvIGRvdWJsZSBjaGVjayB0aGF0IHRob3NlIG9wdGlvbnMgYmVsb25nIGJlZm9yZSBhZGRpbmcgdGhlbSwgb3IgcmlzayBlcnJhbnQgb3B0aW9uIGNvdW50c1xuICAgICAgICB2YWx1ZXNNYXAuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5sb2NhbEZpbHRlclNlcnZpY2UuaXRlbUhhc1NlYXJjaFRva2VucyhsaXN0LCB2LCB0aGlzLnNlYXJjaFRva2VucykpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZXNNYXAuZGVsZXRlKHYuY29kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBzaG93TGlzdExvYWRpbmdJbmRpY2F0b3JzKHdvcmtUcmFja2VyOiBPYnNlcnZhYmxlPGJvb2xlYW4+LCB0eXBlOiBQaWNrbGlzdFZhbHVlVHlwZSA9ICdib3RoJywgaXNBcHBlbmRpbmcgPSBmYWxzZSkge1xuICAgICAgICBpZiAodHlwZSA9PT0gJ2JvdGgnIHx8IHR5cGUgPT09ICd2YWx1ZXMnKSB7XG4gICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nSW5kaWNhdG9yRm9yTGlzdCh0aGlzLnZhbHVlTGlzdCwgd29ya1RyYWNrZXIsIGlzQXBwZW5kaW5nKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZSA9PT0gJ2JvdGgnIHx8IHR5cGUgPT09ICd2YWx1ZXNldHMnKSB7XG4gICAgICAgICAgICB0aGlzLnNob3dMb2FkaW5nSW5kaWNhdG9yRm9yTGlzdCh0aGlzLnZhbHVlU2V0TGlzdCwgd29ya1RyYWNrZXIsIGlzQXBwZW5kaW5nKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgc2hvd0xvYWRpbmdJbmRpY2F0b3JGb3JMaXN0KGxpc3Q6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFNlbGVjdExpc3RPcHRpb24+LCB0cmFja2VyOiBPYnNlcnZhYmxlPGJvb2xlYW4+LCBpc0FwcGVuZGluZyA9IGZhbHNlKSB7XG4gICAgICAgIGlmIChpc0FwcGVuZGluZykge1xuICAgICAgICAgICAgbGlzdC5hcHBlbmRpbmdPcHRpb25zID0gdHJhY2tlcjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxpc3QubG9hZGluZ09wdGlvbnMgPSB0cmFja2VyO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19