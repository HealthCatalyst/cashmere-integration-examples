/**
 * @fileoverview added by tsickle
 * Generated from: lib/modal/modal.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ModalWindowComponent } from './modal-window.component';
import { ModalOverlayComponent } from './modal-overlay.component';
import { HcModal } from './modal';
import { ApplicationRef, ComponentFactoryResolver, Injectable, Injector, RendererFactory2, TemplateRef } from '@angular/core';
import { ActiveModal } from './active-modal';
export class ModalService {
    /**
     * @param {?} _componentFactory
     * @param {?} _injector
     * @param {?} _applicationRef
     * @param {?} _rendererFactory
     */
    constructor(_componentFactory, _injector, _applicationRef, _rendererFactory) {
        this._componentFactory = _componentFactory;
        this._injector = _injector;
        this._applicationRef = _applicationRef;
        /**
         * Defaults to false. Restricts multiple modals from being opened on top of each other
         * (an error will be thrown if attempted). It's generally considered bad practice to open multiple
         * models at once, so only change this with good reason.
         */
        this.allowMultiple = false;
        // start at 2000 (reserved range for modals, see _variables.scss)
        this._zIndexCounter = 2000;
        this._modalsOpen = 0;
        this._renderer = _rendererFactory.createRenderer(null, null);
    }
    /**
     * Opens a new modal either from a Component or a TemplateRef with the options specified in ModalOptions
     * In order to use a component, it must be specified in your module's EntryComponents.
     * @template T
     * @param {?} modalContent
     * @param {?=} modalOptions
     * @return {?}
     */
    open(modalContent, modalOptions) {
        if (!this.allowMultiple && this._modalsOpen !== 0) {
            throw new Error(`Multiple modals may not be opened at the same time
                when the allowMultiple property on ModalService is set to false.`);
        }
        /** @type {?} */
        let container = (/** @type {?} */ (document.querySelector('body')));
        /** @type {?} */
        const defaultOptions = {
            container,
            data: {},
            ignoreEscapeKey: false,
            size: 'auto',
            ignoreOverlayClick: false
        };
        /** @type {?} */
        const options = Object.assign({}, defaultOptions, modalOptions);
        if (options.container) {
            container = options.container;
        }
        if (!container) {
            throw new Error('Modal requires that a container be set in the modal options');
        }
        // TODO: HcModal and ActiveModal essentially are the same object with HcModal having refs. Might as well merge them to simplify
        /** @type {?} */
        let modal = new HcModal();
        /** @type {?} */
        let activeModalRef = new ActiveModal();
        modal.data = options.data;
        activeModalRef.data = options.data;
        /** @type {?} */
        const modalInjector = Injector.create({
            providers: [{ provide: ActiveModal, useValue: activeModalRef }],
            parent: this._injector
        });
        // disable scrolling when overlay is present
        this._renderer.addClass(container, 'hc-modal-open');
        modal._removeOpenClass = (/**
         * @return {?}
         */
        () => this._renderer.removeClass(container, 'hc-modal-open'));
        // Create, attach, and append overlay to container
        /** @type {?} */
        let overlay = this._componentFactory.resolveComponentFactory(ModalOverlayComponent).create(modalInjector);
        this._renderer.setStyle(overlay.location.nativeElement, 'z-index', this._zIndexCounter);
        overlay.instance._ignoreEscapeKey = options.ignoreEscapeKey;
        this._applicationRef.attachView(overlay.hostView);
        container.appendChild(overlay.location.nativeElement);
        modal.overlay = overlay;
        // Create and attach content views; prepare nodes to be
        // transcluded with the window ComponentRef
        /** @type {?} */
        let projectableNodes;
        if (modalContent instanceof TemplateRef) {
            /** @type {?} */
            const embeddedViewRef = modalContent.createEmbeddedView(activeModalRef);
            this._applicationRef.attachView(embeddedViewRef);
            projectableNodes = [embeddedViewRef.rootNodes];
        }
        else {
            /** @type {?} */
            const componentRef = this._componentFactory.resolveComponentFactory(modalContent).create(modalInjector);
            // Set host component style to 100% to allow collapsing of body but not header/footer
            this._renderer.addClass(componentRef.location.nativeElement, 'hc-modal-center-component');
            this._applicationRef.attachView(componentRef.hostView);
            modal.componentRef = (/** @type {?} */ (componentRef));
            projectableNodes = [[componentRef.location.nativeElement]];
        }
        // Create, attach, and append Window to container
        // Apply options
        /** @type {?} */
        let window = this._componentFactory.resolveComponentFactory(ModalWindowComponent).create(modalInjector, projectableNodes);
        this._renderer.setStyle(window.location.nativeElement, 'z-index', this._zIndexCounter + 1);
        window.instance._size = (/** @type {?} */ (options.size));
        window.instance._ignoreOverlayClick = options.ignoreOverlayClick;
        this._applicationRef.attachView(window.hostView);
        container.appendChild(window.location.nativeElement);
        modal.window = window;
        activeModalRef.close = (/**
         * @param {?} result
         * @return {?}
         */
        (result) => {
            modal.close(result);
        });
        activeModalRef.dismiss = (/**
         * @return {?}
         */
        () => modal.dismiss());
        this._modalsOpen++;
        modal._modalClose.subscribe((/**
         * @return {?}
         */
        () => {
            this._modalsOpen--;
            modal._modalClose.unsubscribe();
        }));
        this._zIndexCounter += 2;
        return modal;
    }
}
ModalService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ModalService.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: Injector },
    { type: ApplicationRef },
    { type: RendererFactory2 }
];
if (false) {
    /**
     * Defaults to false. Restricts multiple modals from being opened on top of each other
     * (an error will be thrown if attempted). It's generally considered bad practice to open multiple
     * models at once, so only change this with good reason.
     * @type {?}
     */
    ModalService.prototype.allowMultiple;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._zIndexCounter;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._renderer;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._modalsOpen;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._componentFactory;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._injector;
    /**
     * @type {?}
     * @private
     */
    ModalService.prototype._applicationRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kYWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BoZWFsdGhjYXRhbHlzdC9jYXNobWVyZS8iLCJzb3VyY2VzIjpbImxpYi9tb2RhbC9tb2RhbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFDOUQsT0FBTyxFQUFDLHFCQUFxQixFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFDaEUsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQ0gsY0FBYyxFQUNkLHdCQUF3QixFQUV4QixVQUFVLEVBQ1YsUUFBUSxFQUVSLGdCQUFnQixFQUNoQixXQUFXLEVBRWQsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBSzNDLE1BQU0sT0FBTyxZQUFZOzs7Ozs7O0lBWXJCLFlBQ1ksaUJBQTJDLEVBQzNDLFNBQW1CLEVBQ25CLGVBQStCLEVBQ3ZDLGdCQUFrQztRQUgxQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQTBCO1FBQzNDLGNBQVMsR0FBVCxTQUFTLENBQVU7UUFDbkIsb0JBQWUsR0FBZixlQUFlLENBQWdCOzs7Ozs7UUFWM0Msa0JBQWEsR0FBWSxLQUFLLENBQUM7O1FBR3ZCLG1CQUFjLEdBQUcsSUFBSSxDQUFDO1FBRXRCLGdCQUFXLEdBQVcsQ0FBQyxDQUFDO1FBUTVCLElBQUksQ0FBQyxTQUFTLEdBQUcsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNqRSxDQUFDOzs7Ozs7Ozs7SUFLRCxJQUFJLENBQUksWUFBOEIsRUFBRSxZQUEyQjtRQUMvRCxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsV0FBVyxLQUFLLENBQUMsRUFBRTtZQUMvQyxNQUFNLElBQUksS0FBSyxDQUFDO2lGQUNx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QUFDLGNBQWMsSUFBSSxDQUFDLENBQUM7UUFDekIsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQzs7O1lBbkhKLFVBQVU7Ozs7WUFkUCx3QkFBd0I7WUFHeEIsUUFBUTtZQUpSLGNBQWM7WUFNZCxnQkFBZ0I7Ozs7Ozs7OztJQWVoQixxQ0FBK0I7Ozs7O0lBRy9CLHNDQUE4Qjs7Ozs7SUFDOUIsaUNBQTZCOzs7OztJQUM3QixtQ0FBZ0M7Ozs7O0lBRzVCLHlDQUFtRDs7Ozs7SUFDbkQsaUNBQTJCOzs7OztJQUMzQix1Q0FBdUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge01vZGFsV2luZG93Q29tcG9uZW50fSBmcm9tICcuL21vZGFsLXdpbmRvdy5jb21wb25lbnQnO1xuaW1wb3J0IHtNb2RhbE92ZXJsYXlDb21wb25lbnR9IGZyb20gJy4vbW9kYWwtb3ZlcmxheS5jb21wb25lbnQnO1xuaW1wb3J0IHtIY01vZGFsfSBmcm9tICcuL21vZGFsJztcbmltcG9ydCB7XG4gICAgQXBwbGljYXRpb25SZWYsXG4gICAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIENvbXBvbmVudFJlZixcbiAgICBJbmplY3RhYmxlLFxuICAgIEluamVjdG9yLFxuICAgIFJlbmRlcmVyMixcbiAgICBSZW5kZXJlckZhY3RvcnkyLFxuICAgIFRlbXBsYXRlUmVmLFxuICAgIFR5cGVcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge01vZGFsT3B0aW9ucywgTW9kYWxTaXplfSBmcm9tICcuL21vZGFsLW9wdGlvbnMnO1xuaW1wb3J0IHtBY3RpdmVNb2RhbH0gZnJvbSAnLi9hY3RpdmUtbW9kYWwnO1xuXG5leHBvcnQgdHlwZSBNb2RhbENvbnRlbnRUeXBlID0gVHlwZTx7fT4gfCBUZW1wbGF0ZVJlZjxhbnk+O1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTW9kYWxTZXJ2aWNlIHtcbiAgICAvKiogRGVmYXVsdHMgdG8gZmFsc2UuIFJlc3RyaWN0cyBtdWx0aXBsZSBtb2RhbHMgZnJvbSBiZWluZyBvcGVuZWQgb24gdG9wIG9mIGVhY2ggb3RoZXJcbiAgICAgKiAoYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24gaWYgYXR0ZW1wdGVkKS4gSXQncyBnZW5lcmFsbHkgY29uc2lkZXJlZCBiYWQgcHJhY3RpY2UgdG8gb3BlbiBtdWx0aXBsZVxuICAgICAqIG1vZGVscyBhdCBvbmNlLCBzbyBvbmx5IGNoYW5nZSB0aGlzIHdpdGggZ29vZCByZWFzb24uXG4gICAgICovXG4gICAgYWxsb3dNdWx0aXBsZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLy8gc3RhcnQgYXQgMjAwMCAocmVzZXJ2ZWQgcmFuZ2UgZm9yIG1vZGFscywgc2VlIF92YXJpYWJsZXMuc2NzcylcbiAgICBwcml2YXRlIF96SW5kZXhDb3VudGVyID0gMjAwMDtcbiAgICBwcml2YXRlIF9yZW5kZXJlcjogUmVuZGVyZXIyO1xuICAgIHByaXZhdGUgX21vZGFsc09wZW46IG51bWJlciA9IDA7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBfY29tcG9uZW50RmFjdG9yeTogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgICAgICBwcml2YXRlIF9pbmplY3RvcjogSW5qZWN0b3IsXG4gICAgICAgIHByaXZhdGUgX2FwcGxpY2F0aW9uUmVmOiBBcHBsaWNhdGlvblJlZixcbiAgICAgICAgX3JlbmRlcmVyRmFjdG9yeTogUmVuZGVyZXJGYWN0b3J5MlxuICAgICkge1xuICAgICAgICB0aGlzLl9yZW5kZXJlciA9IF9yZW5kZXJlckZhY3RvcnkuY3JlYXRlUmVuZGVyZXIobnVsbCwgbnVsbCk7XG4gICAgfVxuXG4gICAgLyoqIE9wZW5zIGEgbmV3IG1vZGFsIGVpdGhlciBmcm9tIGEgQ29tcG9uZW50IG9yIGEgVGVtcGxhdGVSZWYgd2l0aCB0aGUgb3B0aW9ucyBzcGVjaWZpZWQgaW4gTW9kYWxPcHRpb25zXG4gICAgICogSW4gb3JkZXIgdG8gdXNlIGEgY29tcG9uZW50LCBpdCBtdXN0IGJlIHNwZWNpZmllZCBpbiB5b3VyIG1vZHVsZSdzIEVudHJ5Q29tcG9uZW50cy5cbiAgICAgKi9cbiAgICBvcGVuPFQ+KG1vZGFsQ29udGVudDogTW9kYWxDb250ZW50VHlwZSwgbW9kYWxPcHRpb25zPzogTW9kYWxPcHRpb25zKTogSGNNb2RhbDxUPiB7XG4gICAgICAgIGlmICghdGhpcy5hbGxvd011bHRpcGxlICYmIHRoaXMuX21vZGFsc09wZW4gIT09IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTXVsdGlwbGUgbW9kYWxzIG1heSBub3QgYmUgb3BlbmVkIGF0IHRoZSBzYW1lIHRpbWVcbiAgICAgICAgICAgICAgICB3aGVuIHRoZSBhbGxvd011bHRpcGxlIHByb3BlcnR5IG9uIE1vZGFsU2VydmljZSBpcyBzZXQgdG8gZmFsc2UuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpIGFzIEhUTUxFbGVtZW50O1xuXG4gICAgICAgIGNvbnN0IGRlZmF1bHRPcHRpb25zID0ge1xuICAgICAgICAgICAgY29udGFpbmVyLFxuICAgICAgICAgICAgZGF0YToge30sXG4gICAgICAgICAgICBpZ25vcmVFc2NhcGVLZXk6IGZhbHNlLFxuICAgICAgICAgICAgc2l6ZTogJ2F1dG8nLFxuICAgICAgICAgICAgaWdub3JlT3ZlcmxheUNsaWNrOiBmYWxzZVxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBvcHRpb25zID0gey4uLmRlZmF1bHRPcHRpb25zLCAuLi5tb2RhbE9wdGlvbnN9O1xuICAgICAgICBpZiAob3B0aW9ucy5jb250YWluZXIpIHtcbiAgICAgICAgICAgIGNvbnRhaW5lciA9IG9wdGlvbnMuY29udGFpbmVyO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjb250YWluZXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTW9kYWwgcmVxdWlyZXMgdGhhdCBhIGNvbnRhaW5lciBiZSBzZXQgaW4gdGhlIG1vZGFsIG9wdGlvbnMnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRPRE86IEhjTW9kYWwgYW5kIEFjdGl2ZU1vZGFsIGVzc2VudGlhbGx5IGFyZSB0aGUgc2FtZSBvYmplY3Qgd2l0aCBIY01vZGFsIGhhdmluZyByZWZzLiBNaWdodCBhcyB3ZWxsIG1lcmdlIHRoZW0gdG8gc2ltcGxpZnlcbiAgICAgICAgbGV0IG1vZGFsID0gbmV3IEhjTW9kYWw8VD4oKTtcbiAgICAgICAgbGV0IGFjdGl2ZU1vZGFsUmVmID0gbmV3IEFjdGl2ZU1vZGFsKCk7XG4gICAgICAgIG1vZGFsLmRhdGEgPSBvcHRpb25zLmRhdGE7XG4gICAgICAgIGFjdGl2ZU1vZGFsUmVmLmRhdGEgPSBvcHRpb25zLmRhdGE7XG5cbiAgICAgICAgY29uc3QgbW9kYWxJbmplY3RvciA9IEluamVjdG9yLmNyZWF0ZSh7XG4gICAgICAgICAgICBwcm92aWRlcnM6IFt7cHJvdmlkZTogQWN0aXZlTW9kYWwsIHVzZVZhbHVlOiBhY3RpdmVNb2RhbFJlZn1dLFxuICAgICAgICAgICAgcGFyZW50OiB0aGlzLl9pbmplY3RvclxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBkaXNhYmxlIHNjcm9sbGluZyB3aGVuIG92ZXJsYXkgaXMgcHJlc2VudFxuICAgICAgICB0aGlzLl9yZW5kZXJlci5hZGRDbGFzcyhjb250YWluZXIsICdoYy1tb2RhbC1vcGVuJyk7XG4gICAgICAgIG1vZGFsLl9yZW1vdmVPcGVuQ2xhc3MgPSAoKSA9PiB0aGlzLl9yZW5kZXJlci5yZW1vdmVDbGFzcyhjb250YWluZXIsICdoYy1tb2RhbC1vcGVuJyk7XG5cbiAgICAgICAgLy8gQ3JlYXRlLCBhdHRhY2gsIGFuZCBhcHBlbmQgb3ZlcmxheSB0byBjb250YWluZXJcbiAgICAgICAgbGV0IG92ZXJsYXkgPSB0aGlzLl9jb21wb25lbnRGYWN0b3J5LnJlc29sdmVDb21wb25lbnRGYWN0b3J5KE1vZGFsT3ZlcmxheUNvbXBvbmVudCkuY3JlYXRlKG1vZGFsSW5qZWN0b3IpO1xuICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRTdHlsZShvdmVybGF5LmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQsICd6LWluZGV4JywgdGhpcy5fekluZGV4Q291bnRlcik7XG4gICAgICAgIG92ZXJsYXkuaW5zdGFuY2UuX2lnbm9yZUVzY2FwZUtleSA9IG9wdGlvbnMuaWdub3JlRXNjYXBlS2V5O1xuXG4gICAgICAgIHRoaXMuX2FwcGxpY2F0aW9uUmVmLmF0dGFjaFZpZXcob3ZlcmxheS5ob3N0Vmlldyk7XG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChvdmVybGF5LmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgICBtb2RhbC5vdmVybGF5ID0gb3ZlcmxheTtcblxuICAgICAgICAvLyBDcmVhdGUgYW5kIGF0dGFjaCBjb250ZW50IHZpZXdzOyBwcmVwYXJlIG5vZGVzIHRvIGJlXG4gICAgICAgIC8vIHRyYW5zY2x1ZGVkIHdpdGggdGhlIHdpbmRvdyBDb21wb25lbnRSZWZcbiAgICAgICAgbGV0IHByb2plY3RhYmxlTm9kZXM7XG4gICAgICAgIGlmIChtb2RhbENvbnRlbnQgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZikge1xuICAgICAgICAgICAgY29uc3QgZW1iZWRkZWRWaWV3UmVmID0gbW9kYWxDb250ZW50LmNyZWF0ZUVtYmVkZGVkVmlldyhhY3RpdmVNb2RhbFJlZik7XG4gICAgICAgICAgICB0aGlzLl9hcHBsaWNhdGlvblJlZi5hdHRhY2hWaWV3KGVtYmVkZGVkVmlld1JlZik7XG4gICAgICAgICAgICBwcm9qZWN0YWJsZU5vZGVzID0gW2VtYmVkZGVkVmlld1JlZi5yb290Tm9kZXNdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgY29tcG9uZW50UmVmID0gdGhpcy5fY29tcG9uZW50RmFjdG9yeS5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShtb2RhbENvbnRlbnQpLmNyZWF0ZShtb2RhbEluamVjdG9yKTtcblxuICAgICAgICAgICAgLy8gU2V0IGhvc3QgY29tcG9uZW50IHN0eWxlIHRvIDEwMCUgdG8gYWxsb3cgY29sbGFwc2luZyBvZiBib2R5IGJ1dCBub3QgaGVhZGVyL2Zvb3RlclxuICAgICAgICAgICAgdGhpcy5fcmVuZGVyZXIuYWRkQ2xhc3MoY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQsICdoYy1tb2RhbC1jZW50ZXItY29tcG9uZW50Jyk7XG4gICAgICAgICAgICB0aGlzLl9hcHBsaWNhdGlvblJlZi5hdHRhY2hWaWV3KGNvbXBvbmVudFJlZi5ob3N0Vmlldyk7XG4gICAgICAgICAgICBtb2RhbC5jb21wb25lbnRSZWYgPSA8Q29tcG9uZW50UmVmPFQ+PmNvbXBvbmVudFJlZjtcbiAgICAgICAgICAgIHByb2plY3RhYmxlTm9kZXMgPSBbW2NvbXBvbmVudFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50XV07XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDcmVhdGUsIGF0dGFjaCwgYW5kIGFwcGVuZCBXaW5kb3cgdG8gY29udGFpbmVyXG4gICAgICAgIC8vIEFwcGx5IG9wdGlvbnNcbiAgICAgICAgbGV0IHdpbmRvdyA9IHRoaXMuX2NvbXBvbmVudEZhY3RvcnkucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoTW9kYWxXaW5kb3dDb21wb25lbnQpLmNyZWF0ZShtb2RhbEluamVjdG9yLCBwcm9qZWN0YWJsZU5vZGVzKTtcbiAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0U3R5bGUod2luZG93LmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQsICd6LWluZGV4JywgdGhpcy5fekluZGV4Q291bnRlciArIDEpO1xuICAgICAgICB3aW5kb3cuaW5zdGFuY2UuX3NpemUgPSBvcHRpb25zLnNpemUgYXMgTW9kYWxTaXplO1xuICAgICAgICB3aW5kb3cuaW5zdGFuY2UuX2lnbm9yZU92ZXJsYXlDbGljayA9IG9wdGlvbnMuaWdub3JlT3ZlcmxheUNsaWNrO1xuXG4gICAgICAgIHRoaXMuX2FwcGxpY2F0aW9uUmVmLmF0dGFjaFZpZXcod2luZG93Lmhvc3RWaWV3KTtcbiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHdpbmRvdy5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcbiAgICAgICAgbW9kYWwud2luZG93ID0gd2luZG93O1xuXG4gICAgICAgIGFjdGl2ZU1vZGFsUmVmLmNsb3NlID0gKHJlc3VsdDogYW55KSA9PiB7XG4gICAgICAgICAgICBtb2RhbC5jbG9zZShyZXN1bHQpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGFjdGl2ZU1vZGFsUmVmLmRpc21pc3MgPSAoKSA9PiBtb2RhbC5kaXNtaXNzKCk7XG5cbiAgICAgICAgdGhpcy5fbW9kYWxzT3BlbisrO1xuICAgICAgICBtb2RhbC5fbW9kYWxDbG9zZS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbW9kYWxzT3Blbi0tO1xuICAgICAgICAgICAgbW9kYWwuX21vZGFsQ2xvc2UudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fekluZGV4Q291bnRlciArPSAyO1xuICAgICAgICByZXR1cm4gbW9kYWw7XG4gICAgfVxufVxuIl19