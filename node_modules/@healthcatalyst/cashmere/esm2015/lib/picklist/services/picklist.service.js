/**
 * @fileoverview added by tsickle
 * Generated from: lib/picklist/services/picklist.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { WorkTrackerService } from '../../shared/work-tracker.service';
import { PicklistFilterService } from './picklist-filter.service';
import { PicklistValuesetMovingService } from './picklist-valueset-moving.service';
import { PicklistFilterLocalService } from './picklist-filter-local.service';
import { PicklistStateService } from './picklist-state.service';
import { PicklistValueOptions, ValueListOption } from '../pane/picklist-pane.model';
/**
 * Handles loading + moving items to/from list
 */
export class PicklistService {
    /**
     * @param {?} workTracker
     * @param {?} filterService
     * @param {?} localFilterService
     * @param {?} valuesetMovingService
     * @param {?} stateService
     */
    constructor(workTracker, filterService, localFilterService, valuesetMovingService, stateService) {
        this.workTracker = workTracker;
        this.filterService = filterService;
        this.localFilterService = localFilterService;
        this.valuesetMovingService = valuesetMovingService;
        this.stateService = stateService;
    }
    /**
     * @return {?}
     */
    get pane() {
        return this.stateService.pane;
    }
    /**
     * @return {?}
     */
    get picklist() {
        return this.stateService.picklist;
    }
    /**
     * @return {?}
     */
    get optionsSource() {
        return this.stateService.optionsSource;
    }
    /**
     * @return {?}
     */
    get valueList() {
        return this.stateService.valueList;
    }
    /**
     * @return {?}
     */
    get valueSetList() {
        return this.stateService.valueSetList;
    }
    /**
     * @return {?}
     */
    get totalValuesCount() {
        return this.valueList.options.size + this.valueList.additionalRemoteOptions;
    }
    /**
     * @return {?}
     */
    get totalValueSetsCount() {
        return this.valueSetList.options.size + this.valueSetList.additionalRemoteOptions;
    }
    /**
     * @param {?} settings
     * @param {?} optionsSource
     * @param {?} pane
     * @return {?}
     */
    reset(settings, optionsSource, pane) {
        this.stateService.reset(settings, optionsSource, pane);
        this.filterService.reset();
        if (this.optionsSource.optionsAreLocal()) {
            this.stateService.updateValueList(this.optionsSource.values);
            this.stateService.updateValueSetList(this.optionsSource.valueSets);
            this.localFilterService.filter(this.valueList, this.filterService.searchTokens);
            this.localFilterService.filter(this.valueSetList, this.filterService.searchTokens);
        }
        else {
            /** @type {?} */
            const loading$ = this.workTracker.startObservable((/**
             * @return {?}
             */
            () => this.filterService.filterOptionsRemote()));
            this.valueList.loadingOptions = loading$;
            this.valueSetList.loadingOptions = loading$;
        }
    }
    /**
     * @param {?} listOptions
     * @return {?}
     */
    addOptions(listOptions) {
        if (!this.optionsSource.optionsAreLocal()) {
            this.filterService.preFilterOptionsForRemoteMode(listOptions.values, this.valueList);
            this.filterService.preFilterOptionsForRemoteMode(listOptions.valueSets, this.valueSetList);
        }
        listOptions.values.forEach((/**
         * @param {?} o
         * @return {?}
         */
        o => {
            this.valueList.options.set(o.code, o);
        }));
        listOptions.valueSets.forEach((/**
         * @param {?} o
         * @return {?}
         */
        o => {
            this.valueSetList.options.set(o.code, o);
        }));
        this.localFilterService.filter(this.valueList, this.filterService.searchTokens);
        this.localFilterService.filter(this.valueSetList, this.filterService.searchTokens);
        this.pane.selectNone();
    }
    /**
     * @param {?=} shouldBreakValuesets
     * @return {?}
     */
    moveOutSelectedOptions(shouldBreakValuesets = false) {
        /** @type {?} */
        let optionsToMove = new PicklistValueOptions();
        this.valueList.selectedOptions.forEach((/**
         * @param {?} o
         * @return {?}
         */
        o => {
            optionsToMove.values.set(o.code, o);
            this.valueList.options.delete(o.code);
        }));
        this.valuesetMovingService.moveOutValuesets(optionsToMove, this.pane, shouldBreakValuesets);
        this.localFilterService.filter(this.valueList, this.filterService.searchTokens);
        this.localFilterService.filter(this.valueSetList, this.filterService.searchTokens);
        this.pane.selectNone();
        return optionsToMove;
    }
    /**
     * @param {?} valueset
     * @return {?}
     */
    loadValuesForValueset(valueset) {
        valueset.loadingValues = true;
        if (!this.optionsSource.getValuesForValueset) {
            return;
        }
        this.optionsSource.getValuesForValueset(valueset.option.code).subscribe((/**
         * @param {?} values
         * @return {?}
         */
        values => {
            valueset.subValuesSelectList.filteredOptions.length = 0;
            values.forEach((/**
             * @param {?} v
             * @return {?}
             */
            v => {
                valueset.subValuesSelectList.filteredOptions.push(new ValueListOption(v, v.code));
            }));
        }), (/**
         * @return {?}
         */
        () => {
            console.warn('Unable to load values for valueset');
            valueset.showValues = false;
        }), (/**
         * @return {?}
         */
        () => {
            valueset.loadingValues = false;
        }));
    }
}
PicklistService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PicklistService.ctorParameters = () => [
    { type: WorkTrackerService },
    { type: PicklistFilterService },
    { type: PicklistFilterLocalService },
    { type: PicklistValuesetMovingService },
    { type: PicklistStateService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    PicklistService.prototype.workTracker;
    /**
     * @type {?}
     * @private
     */
    PicklistService.prototype.filterService;
    /**
     * @type {?}
     * @private
     */
    PicklistService.prototype.localFilterService;
    /**
     * @type {?}
     * @private
     */
    PicklistService.prototype.valuesetMovingService;
    /**
     * @type {?}
     * @private
     */
    PicklistService.prototype.stateService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlja2xpc3Quc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BoZWFsdGhjYXRhbHlzdC9jYXNobWVyZS8iLCJzb3VyY2VzIjpbImxpYi9waWNrbGlzdC9zZXJ2aWNlcy9waWNrbGlzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUV6QyxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxtQ0FBbUMsQ0FBQztBQUNyRSxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUNoRSxPQUFPLEVBQUMsNkJBQTZCLEVBQUMsTUFBTSxvQ0FBb0MsQ0FBQztBQUNqRixPQUFPLEVBQUMsMEJBQTBCLEVBQUMsTUFBTSxpQ0FBaUMsQ0FBQztBQUMzRSxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUc5RCxPQUFPLEVBQXVCLG9CQUFvQixFQUFFLGVBQWUsRUFBcUIsTUFBTSw2QkFBNkIsQ0FBQzs7OztBQU01SCxNQUFNLE9BQU8sZUFBZTs7Ozs7Ozs7SUF1QnhCLFlBQ1ksV0FBK0IsRUFDL0IsYUFBb0MsRUFDcEMsa0JBQThDLEVBQzlDLHFCQUFvRCxFQUNwRCxZQUFrQztRQUpsQyxnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFDL0Isa0JBQWEsR0FBYixhQUFhLENBQXVCO1FBQ3BDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBNEI7UUFDOUMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUErQjtRQUNwRCxpQkFBWSxHQUFaLFlBQVksQ0FBc0I7SUFDM0MsQ0FBQzs7OztJQTVCSixJQUFXLElBQUk7UUFDWCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDO0lBQ2xDLENBQUM7Ozs7SUFDRCxJQUFXLFFBQVE7UUFDZixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO0lBQ3RDLENBQUM7Ozs7SUFDRCxJ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QUFJLENBQUMsYUFBYSxDQUFDLG9CQUFvQixFQUFFO1lBQzFDLE9BQU87U0FDVjtRQUNELElBQUksQ0FBQyxhQUFhLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTOzs7O1FBQ25FLE1BQU0sQ0FBQyxFQUFFO1lBQ0wsUUFBUSxDQUFDLG1CQUFtQixDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ3hELE1BQU0sQ0FBQyxPQUFPOzs7O1lBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2YsUUFBUSxDQUFDLG1CQUFtQixDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxlQUFlLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3RGLENBQUMsRUFBQyxDQUFDO1FBQ1AsQ0FBQzs7O1FBQ0QsR0FBRyxFQUFFO1lBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1lBQ25ELFFBQVEsQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ2hDLENBQUM7OztRQUNELEdBQUcsRUFBRTtZQUNELFFBQVEsQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO1FBQ25DLENBQUMsRUFDSixDQUFDO0lBQ04sQ0FBQzs7O1lBcEdKLFVBQVU7Ozs7WUFaSCxrQkFBa0I7WUFDbEIscUJBQXFCO1lBRXJCLDBCQUEwQjtZQUQxQiw2QkFBNkI7WUFFN0Isb0JBQW9COzs7Ozs7O0lBaUNwQixzQ0FBdUM7Ozs7O0lBQ3ZDLHdDQUE0Qzs7Ozs7SUFDNUMsNkNBQXNEOzs7OztJQUN0RCxnREFBNEQ7Ozs7O0lBQzVELHVDQUEwQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7V29ya1RyYWNrZXJTZXJ2aWNlfSBmcm9tICcuLi8uLi9zaGFyZWQvd29yay10cmFja2VyLnNlcnZpY2UnO1xuaW1wb3J0IHtQaWNrbGlzdEZpbHRlclNlcnZpY2V9IGZyb20gJy4vcGlja2xpc3QtZmlsdGVyLnNlcnZpY2UnO1xuaW1wb3J0IHtQaWNrbGlzdFZhbHVlc2V0TW92aW5nU2VydmljZX0gZnJvbSAnLi9waWNrbGlzdC12YWx1ZXNldC1tb3Zpbmcuc2VydmljZSc7XG5pbXBvcnQge1BpY2tsaXN0RmlsdGVyTG9jYWxTZXJ2aWNlfSBmcm9tICcuL3BpY2tsaXN0LWZpbHRlci1sb2NhbC5zZXJ2aWNlJztcbmltcG9ydCB7UGlja2xpc3RTdGF0ZVNlcnZpY2V9IGZyb20gJy4vcGlja2xpc3Qtc3RhdGUuc2VydmljZSc7XG5pbXBvcnQge1BpY2tsaXN0UGFuZUNvbXBvbmVudH0gZnJvbSAnLi4vcGFuZS9waWNrbGlzdC1wYW5lLmNvbXBvbmVudCc7XG5pbXBvcnQge1BpY2tsaXN0T3B0aW9uc1NvdXJjZSwgUGlja2xpc3RTZXR0aW5nc30gZnJvbSAnLi4vcGlja2xpc3QubW9kZWwnO1xuaW1wb3J0IHtGaWx0ZXJhYmxlU2VsZWN0TGlzdCwgUGlja2xpc3RWYWx1ZU9wdGlvbnMsIFZhbHVlTGlzdE9wdGlvbiwgVmFsdWVTZXRMaXN0T3B0aW9ufSBmcm9tICcuLi9wYW5lL3BpY2tsaXN0LXBhbmUubW9kZWwnO1xuXG4vKipcbiAqIEhhbmRsZXMgbG9hZGluZyArIG1vdmluZyBpdGVtcyB0by9mcm9tIGxpc3RcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBpY2tsaXN0U2VydmljZSB7XG4gICAgcHVibGljIGdldCBwYW5lKCk6IFBpY2tsaXN0UGFuZUNvbXBvbmVudCB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlU2VydmljZS5wYW5lO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0IHBpY2tsaXN0KCk6IFBpY2tsaXN0U2V0dGluZ3Mge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZVNlcnZpY2UucGlja2xpc3Q7XG4gICAgfVxuICAgIHB1YmxpYyBnZXQgb3B0aW9uc1NvdXJjZSgpOiBQaWNrbGlzdE9wdGlvbnNTb3VyY2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZVNlcnZpY2Uub3B0aW9uc1NvdXJjZTtcbiAgICB9XG4gICAgcHVibGljIGdldCB2YWx1ZUxpc3QoKTogRmlsdGVyYWJsZVNlbGVjdExpc3Q8VmFsdWVMaXN0T3B0aW9uPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlU2VydmljZS52YWx1ZUxpc3Q7XG4gICAgfVxuICAgIHB1YmxpYyBnZXQgdmFsdWVTZXRMaXN0KCk6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFZhbHVlU2V0TGlzdE9wdGlvbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZVNlcnZpY2UudmFsdWVTZXRMaXN0O1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0IHRvdGFsVmFsdWVzQ291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVMaXN0Lm9wdGlvbnMuc2l6ZSArIHRoaXMudmFsdWVMaXN0LmFkZGl0aW9uYWxSZW1vdGVPcHRpb25zO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0IHRvdGFsVmFsdWVTZXRzQ291bnQoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVTZXRMaXN0Lm9wdGlvbnMuc2l6ZSArIHRoaXMudmFsdWVTZXRMaXN0LmFkZGl0aW9uYWxSZW1vdGVPcHRpb25zO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHdvcmtUcmFja2VyOiBXb3JrVHJhY2tlclNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZmlsdGVyU2VydmljZTogUGlja2xpc3RGaWx0ZXJTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGxvY2FsRmlsdGVyU2VydmljZTogUGlja2xpc3RGaWx0ZXJMb2NhbFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdmFsdWVzZXRNb3ZpbmdTZXJ2aWNlOiBQaWNrbGlzdFZhbHVlc2V0TW92aW5nU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBzdGF0ZVNlcnZpY2U6IFBpY2tsaXN0U3RhdGVTZXJ2aWNlXG4gICAgKSB7fVxuXG4gICAgcHVibGljIHJlc2V0KHNldHRpbmdzOiBQaWNrbGlzdFNldHRpbmdzLCBvcHRpb25zU291cmNlOiBQaWNrbGlzdE9wdGlvbnNTb3VyY2UsIHBhbmU6IFBpY2tsaXN0UGFuZUNvbXBvbmVudCkge1xuICAgICAgICB0aGlzLnN0YXRlU2VydmljZS5yZXNldChzZXR0aW5ncywgb3B0aW9uc1NvdXJjZSwgcGFuZSk7XG4gICAgICAgIHRoaXMuZmlsdGVyU2VydmljZS5yZXNldCgpO1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnNTb3VyY2Uub3B0aW9uc0FyZUxvY2FsKCkpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGVTZXJ2aWNlLnVwZGF0ZVZhbHVlTGlzdCh0aGlzLm9wdGlvbnNTb3VyY2UudmFsdWVzKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGVTZXJ2aWNlLnVwZGF0ZVZhbHVlU2V0TGlzdCh0aGlzLm9wdGlvbnNTb3VyY2UudmFsdWVTZXRzKTtcbiAgICAgICAgICAgIHRoaXMubG9jYWxGaWx0ZXJTZXJ2aWNlLmZpbHRlcih0aGlzLnZhbHVlTGlzdCwgdGhpcy5maWx0ZXJTZXJ2aWNlLnNlYXJjaFRva2Vucyk7XG4gICAgICAgICAgICB0aGlzLmxvY2FsRmlsdGVyU2VydmljZS5maWx0ZXIodGhpcy52YWx1ZVNldExpc3QsIHRoaXMuZmlsdGVyU2VydmljZS5zZWFyY2hUb2tlbnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgbG9hZGluZyQgPSB0aGlzLndvcmtUcmFja2VyLnN0YXJ0T2JzZXJ2YWJsZSgoKSA9PiB0aGlzLmZpbHRlclNlcnZpY2UuZmlsdGVyT3B0aW9uc1JlbW90ZSgpKTtcbiAgICAgICAgICAgIHRoaXMudmFsdWVMaXN0LmxvYWRpbmdPcHRpb25zID0gbG9hZGluZyQ7XG4gICAgICAgICAgICB0aGlzLnZhbHVlU2V0TGlzdC5sb2FkaW5nT3B0aW9ucyA9IGxvYWRpbmckO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFkZE9wdGlvbnMobGlzdE9wdGlvbnM6IFBpY2tsaXN0VmFsdWVPcHRpb25zKSB7XG4gICAgICAgIGlmICghdGhpcy5vcHRpb25zU291cmNlLm9wdGlvbnNBcmVMb2NhbCgpKSB7XG4gICAgICAgICAgICB0aGlzLmZpbHRlclNlcnZpY2UucHJlRmlsdGVyT3B0aW9uc0ZvclJlbW90ZU1vZGUobGlzdE9wdGlvbnMudmFsdWVzLCB0aGlzLnZhbHVlTGlzdCk7XG4gICAgICAgICAgICB0aGlzLmZpbHRlclNlcnZpY2UucHJlRmlsdGVyT3B0aW9uc0ZvclJlbW90ZU1vZGUobGlzdE9wdGlvbnMudmFsdWVTZXRzLCB0aGlzLnZhbHVlU2V0TGlzdCk7XG4gICAgICAgIH1cblxuICAgICAgICBsaXN0T3B0aW9ucy52YWx1ZXMuZm9yRWFjaChvID0+IHtcbiAgICAgICAgICAgIHRoaXMudmFsdWVMaXN0Lm9wdGlvbnMuc2V0KG8uY29kZSwgbyk7XG4gICAgICAgIH0pO1xuICAgICAgICBsaXN0T3B0aW9ucy52YWx1ZVNldHMuZm9yRWFjaChvID0+IHtcbiAgICAgICAgICAgIHRoaXMudmFsdWVTZXRMaXN0Lm9wdGlvbnMuc2V0KG8uY29kZSwgbyk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmxvY2FsRmlsdGVyU2VydmljZS5maWx0ZXIodGhpcy52YWx1ZUxpc3QsIHRoaXMuZmlsdGVyU2VydmljZS5zZWFyY2hUb2tlbnMpO1xuICAgICAgICB0aGlzLmxvY2FsRmlsdGVyU2VydmljZS5maWx0ZXIodGhpcy52YWx1ZVNldExpc3QsIHRoaXMuZmlsdGVyU2VydmljZS5zZWFyY2hUb2tlbnMpO1xuICAgICAgICB0aGlzLnBhbmUuc2VsZWN0Tm9uZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBtb3ZlT3V0U2VsZWN0ZWRPcHRpb25zKHNob3VsZEJyZWFrVmFsdWVzZXRzOiBib29sZWFuID0gZmFsc2UpOiBQaWNrbGlzdFZhbHVlT3B0aW9ucyB7XG4gICAgICAgIGxldCBvcHRpb25zVG9Nb3ZlID0gbmV3IFBpY2tsaXN0VmFsdWVPcHRpb25zKCk7XG4gICAgICAgIHRoaXMudmFsdWVMaXN0LnNlbGVjdGVkT3B0aW9ucy5mb3JFYWNoKG8gPT4ge1xuICAgICAgICAgICAgb3B0aW9uc1RvTW92ZS52YWx1ZXMuc2V0KG8uY29kZSwgbyk7XG4gICAgICAgICAgICB0aGlzLnZhbHVlTGlzdC5vcHRpb25zLmRlbGV0ZShvLmNvZGUpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZhbHVlc2V0TW92aW5nU2VydmljZS5tb3ZlT3V0VmFsdWVzZXRzKG9wdGlvbnNUb01vdmUsIHRoaXMucGFuZSwgc2hvdWxkQnJlYWtWYWx1ZXNldHMpO1xuXG4gICAgICAgIHRoaXMubG9jYWxGaWx0ZXJTZXJ2aWNlLmZpbHRlcih0aGlzLnZhbHVlTGlzdCwgdGhpcy5maWx0ZXJTZXJ2aWNlLnNlYXJjaFRva2Vucyk7XG4gICAgICAgIHRoaXMubG9jYWxGaWx0ZXJTZXJ2aWNlLmZpbHRlcih0aGlzLnZhbHVlU2V0TGlzdCwgdGhpcy5maWx0ZXJTZXJ2aWNlLnNlYXJjaFRva2Vucyk7XG4gICAgICAgIHRoaXMucGFuZS5zZWxlY3ROb25lKCk7XG4gICAgICAgIHJldHVybiBvcHRpb25zVG9Nb3ZlO1xuICAgIH1cblxuICAgIHB1YmxpYyBsb2FkVmFsdWVzRm9yVmFsdWVzZXQodmFsdWVzZXQ6IFZhbHVlU2V0TGlzdE9wdGlvbikge1xuICAgICAgICB2YWx1ZXNldC5sb2FkaW5nVmFsdWVzID0gdHJ1ZTtcbiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnNTb3VyY2UuZ2V0VmFsdWVzRm9yVmFsdWVzZXQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm9wdGlvbnNTb3VyY2UuZ2V0VmFsdWVzRm9yVmFsdWVzZXQodmFsdWVzZXQub3B0aW9uLmNvZGUpLnN1YnNjcmliZShcbiAgICAgICAgICAgIHZhbHVlcyA9PiB7XG4gICAgICAgICAgICAgICAgdmFsdWVzZXQuc3ViVmFsdWVzU2VsZWN0TGlzdC5maWx0ZXJlZE9wdGlvbnMubGVuZ3RoID0gMDtcbiAgICAgICAgICAgICAgICB2YWx1ZXMuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVzZXQuc3ViVmFsdWVzU2VsZWN0TGlzdC5maWx0ZXJlZE9wdGlvbnMucHVzaChuZXcgVmFsdWVMaXN0T3B0aW9uKHYsIHYuY29kZSkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ1VuYWJsZSB0byBsb2FkIHZhbHVlcyBmb3IgdmFsdWVzZXQnKTtcbiAgICAgICAgICAgICAgICB2YWx1ZXNldC5zaG93VmFsdWVzID0gZmFsc2U7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhbHVlc2V0LmxvYWRpbmdWYWx1ZXMgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=