/**
 * @fileoverview added by tsickle
 * Generated from: lib/picklist/services/picklist-filter-remote.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { from, of, Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { Injectable } from '@angular/core';
import { PicklistStateService } from './picklist-state.service';
import { PicklistRemoteQueryOptions } from '../picklist.model';
export class PicklistFilterRemoteService {
    /**
     * @param {?} stateService
     */
    constructor(stateService) {
        this.stateService = stateService;
        this.currentValuePage = 1;
        this.currentValueSetPage = 1;
        this.cancelSearch = new Subject();
        this.options$ = from([]);
    }
    /**
     * @return {?}
     */
    get valueList() {
        return this.stateService.valueList;
    }
    /**
     * @return {?}
     */
    get valueSetList() {
        return this.stateService.valueSetList;
    }
    /**
     * @return {?}
     */
    get searchTerm() {
        return this.filterService ? this.filterService.searchTerm : '';
    }
    /**
     * @private
     * @return {?}
     */
    get cancelSearch$() {
        return this.cancelSearch.asObservable();
    }
    /**
     * @param {?} filterService
     * @return {?}
     */
    reset(filterService) {
        this.filterService = filterService;
        this.currentValuePage = 1;
        this.currentValueSetPage = 1;
    }
    /**
     * @param {?=} type
     * @param {?=} shouldAppend
     * @param {?=} selectAllCount
     * @return {?}
     */
    filter(type = 'both', shouldAppend = false, selectAllCount = null) {
        if (!this.stateService.optionsSource.getOptions) {
            console.warn('Remote query callback not provided for this picklist.');
            return from([]).subscribe();
        }
        if (this.options$) {
            this.cancelSearch.next();
        }
        /** @type {?} */
        const params = this.buildRemoteQueryParams(type, selectAllCount);
        if (!shouldAppend) {
            this.clearFilteredOptions(type);
        }
        this.resetPagingForSelectAllIfNeeded(selectAllCount);
        this.options$ = this.stateService.optionsSource.getOptions(params).pipe(takeUntil(this.cancelSearch$));
        return this.options$.subscribe((/**
         * @param {?} options
         * @return {?}
         */
        options => {
            this.processIncomingRemoteOptions(options, type, shouldAppend);
        }), (/**
         * @return {?}
         */
        () => {
            console.warn('Unable to filter options');
            this.clearLists('both');
            return of({});
        }), (/**
         * @return {?}
         */
        () => {
            this.options$ = of({});
        }));
    }
    /**
     * @private
     * @param {?} options
     * @param {?=} type
     * @param {?=} shouldAppend
     * @return {?}
     */
    processIncomingRemoteOptions(options, type = 'both', shouldAppend = false) {
        if (!shouldAppend) {
            this.clearLists(type);
        }
        if (this.stateService.optionsSource.isPaged) {
            if (options.pagedValues) {
                this.processPagedValues(options.pagedValues);
            }
            if (options.pagedValueSets) {
                this.processPagedValueSets(options.pagedValueSets);
            }
        }
        else {
            if (options.values) {
                this.stateService.updateValueList(options.values);
            }
            if (options.valueSets) {
                this.stateService.updateValueSetList(options.valueSets);
            }
            this.valueList.additionalRemoteOptions = 0;
            this.valueSetList.additionalRemoteOptions = 0;
        }
    }
    /**
     * @private
     * @param {?} pagedValues
     * @return {?}
     */
    processPagedValues(pagedValues) {
        this.stateService.updateValueList(pagedValues.values);
        this.valueList.additionalRemoteOptions = pagedValues.totalItems - this.valueList.options.size;
    }
    /**
     * @private
     * @param {?} pagedValueSets
     * @return {?}
     */
    processPagedValueSets(pagedValueSets) {
        this.stateService.updateValueSetList(pagedValueSets.values);
        this.valueSetList.additionalRemoteOptions = pagedValueSets.totalItems - this.valueSetList.options.size;
    }
    /**
     * @private
     * @param {?} type
     * @param {?=} selectAllCount
     * @return {?}
     */
    buildRemoteQueryParams(type, selectAllCount = null) {
        /** @type {?} */
        const params = new PicklistRemoteQueryOptions(this.stateService.picklist, this.searchTerm, type);
        if (type === 'values' || type === 'both') {
            params.valuePageSettings = this.buildPageSettings(this.currentValuePage, selectAllCount);
        }
        if (type === 'valuesets' || type === 'both') {
            params.valueSetPageSettings = this.buildPageSettings(this.currentValueSetPage, selectAllCount);
        }
        return params;
    }
    /**
     * @private
     * @param {?} currentPage
     * @param {?} selectAllCount
     * @return {?}
     */
    buildPageSettings(currentPage, selectAllCount) {
        /** @type {?} */
        const pagerSettings = { currentPage: 1, itemsPerPage: this.stateService.optionsSource.pageSize };
        pagerSettings.currentPage = selectAllCount ? 1 : currentPage;
        pagerSettings.itemsPerPage = selectAllCount || pagerSettings.itemsPerPage;
        return pagerSettings;
    }
    /**
     * @private
     * @param {?=} selectAllCount
     * @return {?}
     */
    resetPagingForSelectAllIfNeeded(selectAllCount = null) {
        if (selectAllCount) {
            this.currentValuePage = Math.floor(selectAllCount / this.stateService.optionsSource.pageSize);
        }
    }
    /**
     * @private
     * @param {?} type
     * @return {?}
     */
    clearLists(type) {
        if (type === 'both' || type === 'values') {
            this.stateService.clearList(this.valueList);
        }
        if (type === 'both' || type === 'valuesets') {
            this.stateService.clearList(this.valueSetList);
        }
    }
    /**
     * @private
     * @param {?} type
     * @return {?}
     */
    clearFilteredOptions(type) {
        if (type === 'both' || type === 'values') {
            this.valueList.filteredOptions.length = 0;
        }
        if (type === 'both' || type === 'valuesets') {
            this.valueSetList.filteredOptions.length = 0;
        }
    }
}
PicklistFilterRemoteService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PicklistFilterRemoteService.ctorParameters = () => [
    { type: PicklistStateService }
];
if (false) {
    /** @type {?} */
    PicklistFilterRemoteService.prototype.filterService;
    /** @type {?} */
    PicklistFilterRemoteService.prototype.currentValuePage;
    /** @type {?} */
    PicklistFilterRemoteService.prototype.currentValueSetPage;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterRemoteService.prototype.cancelSearch;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterRemoteService.prototype.options$;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterRemoteService.prototype.stateService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlja2xpc3QtZmlsdGVyLXJlbW90ZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGhlYWx0aGNhdGFseXN0L2Nhc2htZXJlLyIsInNvdXJjZXMiOlsibGliL3BpY2tsaXN0L3NlcnZpY2VzL3BpY2tsaXN0LWZpbHRlci1yZW1vdGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxJQUFJLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBZSxNQUFNLE1BQU0sQ0FBQztBQUVqRSxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDekMsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUd6QyxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUU5RCxPQUFPLEVBS0gsMEJBQTBCLEVBRTdCLE1BQU0sbUJBQW1CLENBQUM7QUFHM0IsTUFBTSxPQUFPLDJCQUEyQjs7OztJQW1CcEMsWUFBMkIsWUFBa0M7UUFBbEMsaUJBQVksR0FBWixZQUFZLENBQXNCO1FBUnRELHFCQUFnQixHQUFHLENBQUMsQ0FBQztRQUNyQix3QkFBbUIsR0FBRyxDQUFDLENBQUM7UUFDdkIsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBSW5DLGFBQVEsR0FBNkMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRU4sQ0FBQzs7OztJQWpCakUsSUFBVyxTQUFTO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUM7SUFDdkMsQ0FBQzs7OztJQUNELElBQVcsWUFBWTtRQUNuQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDO0lBQzFDLENBQUM7Ozs7SUFDRCxJQUFXLFVBQVU7UUFDakIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxD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QUMsU0FBUyxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1NBQzdDO1FBQ0QsSUFBSSxJQUFJLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxXQUFXLEVBQUU7WUFDekMsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztTQUNoRDtJQUNMLENBQUM7OztZQXRJSixVQUFVOzs7O1lBWEgsb0JBQW9COzs7O0lBYXhCLG9EQUE2Qzs7SUFVN0MsdURBQTRCOztJQUM1QiwwREFBK0I7Ozs7O0lBQy9CLG1EQUEyQzs7Ozs7SUFJM0MsK0NBQXNFOzs7OztJQUVuRCxtREFBMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2Zyb20sIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0LCBTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge3Rha2VVbnRpbH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtQaWNrbGlzdEZpbHRlclNlcnZpY2V9IGZyb20gJy4vcGlja2xpc3QtZmlsdGVyLnNlcnZpY2UnO1xuaW1wb3J0IHtQaWNrbGlzdFN0YXRlU2VydmljZX0gZnJvbSAnLi9waWNrbGlzdC1zdGF0ZS5zZXJ2aWNlJztcbmltcG9ydCB7RmlsdGVyYWJsZVNlbGVjdExpc3QsIFZhbHVlTGlzdE9wdGlvbiwgVmFsdWVTZXRMaXN0T3B0aW9ufSBmcm9tICcuLi9wYW5lL3BpY2tsaXN0LXBhbmUubW9kZWwnO1xuaW1wb3J0IHtcbiAgICBJUGFnZWRDb2xsZWN0aW9uLFxuICAgIElQaWNrbGlzdFJlbW90ZVF1ZXJ5UmVzcG9uc2UsXG4gICAgSVZhbHVlT3B0aW9uLFxuICAgIElWYWx1ZVNldE9wdGlvbixcbiAgICBQaWNrbGlzdFJlbW90ZVF1ZXJ5T3B0aW9ucyxcbiAgICBQaWNrbGlzdFZhbHVlVHlwZVxufSBmcm9tICcuLi9waWNrbGlzdC5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQaWNrbGlzdEZpbHRlclJlbW90ZVNlcnZpY2Uge1xuICAgIHB1YmxpYyBmaWx0ZXJTZXJ2aWNlPzogUGlja2xpc3RGaWx0ZXJTZXJ2aWNlO1xuICAgIHB1YmxpYyBnZXQgdmFsdWVMaXN0KCk6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFZhbHVlTGlzdE9wdGlvbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZVNlcnZpY2UudmFsdWVMaXN0O1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0IHZhbHVlU2V0TGlzdCgpOiBGaWx0ZXJhYmxlU2VsZWN0TGlzdDxWYWx1ZVNldExpc3RPcHRpb24+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGVTZXJ2aWNlLnZhbHVlU2V0TGlzdDtcbiAgICB9XG4gICAgcHVibGljIGdldCBzZWFyY2hUZXJtKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmZpbHRlclNlcnZpY2UgPyB0aGlzLmZpbHRlclNlcnZpY2Uuc2VhcmNoVGVybSA6ICcnO1xuICAgIH1cbiAgICBwdWJsaWMgY3VycmVudFZhbHVlUGFnZSA9IDE7XG4gICAgcHVibGljIGN1cnJlbnRWYWx1ZVNldFBhZ2UgPSAxO1xuICAgIHByaXZhdGUgY2FuY2VsU2VhcmNoID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgICBwcml2YXRlIGdldCBjYW5jZWxTZWFyY2gkKCk6IE9ic2VydmFibGU8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jYW5jZWxTZWFyY2guYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuICAgIHByaXZhdGUgb3B0aW9ucyQ6IE9ic2VydmFibGU8SVBpY2tsaXN0UmVtb3RlUXVlcnlSZXNwb25zZT4gPSBmcm9tKFtdKTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIHN0YXRlU2VydmljZTogUGlja2xpc3RTdGF0ZVNlcnZpY2UpIHt9XG5cbiAgICBwdWJsaWMgcmVzZXQoZmlsdGVyU2VydmljZTogUGlja2xpc3RGaWx0ZXJTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuZmlsdGVyU2VydmljZSA9IGZpbHRlclNlcnZpY2U7XG4gICAgICAgIHRoaXMuY3VycmVudFZhbHVlUGFnZSA9IDE7XG4gICAgICAgIHRoaXMuY3VycmVudFZhbHVlU2V0UGFnZSA9IDE7XG4gICAgfVxuXG4gICAgcHVibGljIGZpbHRlcih0eXBlOiBQaWNrbGlzdFZhbHVlVHlwZSA9ICdib3RoJywgc2hvdWxkQXBwZW5kID0gZmFsc2UsIHNlbGVjdEFsbENvdW50OiBudW1iZXIgfCBudWxsID0gbnVsbCk6IFN1YnNjcmlwdGlvbiB7XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZVNlcnZpY2Uub3B0aW9uc1NvdXJjZS5nZXRPcHRpb25zKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ1JlbW90ZSBxdWVyeSBjYWxsYmFjayBub3QgcHJvdmlkZWQgZm9yIHRoaXMgcGlja2xpc3QuJyk7XG4gICAgICAgICAgICByZXR1cm4gZnJvbShbXSkuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zJCkge1xuICAgICAgICAgICAgdGhpcy5jYW5jZWxTZWFyY2gubmV4dCgpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuYnVpbGRSZW1vdGVRdWVyeVBhcmFtcyh0eXBlLCBzZWxlY3RBbGxDb3VudCk7XG4gICAgICAgIGlmICghc2hvdWxkQXBwZW5kKSB7XG4gICAgICAgICAgICB0aGlzLmNsZWFyRmlsdGVyZWRPcHRpb25zKHR5cGUpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVzZXRQYWdpbmdGb3JTZWxlY3RBbGxJZk5lZWRlZChzZWxlY3RBbGxDb3VudCk7XG4gICAgICAgIHRoaXMub3B0aW9ucyQgPSB0aGlzLnN0YXRlU2VydmljZS5vcHRpb25zU291cmNlLmdldE9wdGlvbnMocGFyYW1zKS5waXBlKHRha2VVbnRpbCh0aGlzLmNhbmNlbFNlYXJjaCQpKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zJC5zdWJzY3JpYmUoXG4gICAgICAgICAgICBvcHRpb25zID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NJbmNvbWluZ1JlbW90ZU9wdGlvbnMob3B0aW9ucywgdHlwZSwgc2hvdWxkQXBwZW5kKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdVbmFibGUgdG8gZmlsdGVyIG9wdGlvbnMnKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyTGlzdHMoJ2JvdGgnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2Yoe30pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMkID0gb2Yoe30pO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2Vzc0luY29taW5nUmVtb3RlT3B0aW9ucyhvcHRpb25zOiBJUGlja2xpc3RSZW1vdGVRdWVyeVJlc3BvbnNlLCB0eXBlOiBQaWNrbGlzdFZhbHVlVHlwZSA9ICdib3RoJywgc2hvdWxkQXBwZW5kID0gZmFsc2UpIHtcbiAgICAgICAgaWYgKCFzaG91bGRBcHBlbmQpIHtcbiAgICAgICAgICAgIHRoaXMuY2xlYXJMaXN0cyh0eXBlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnN0YXRlU2VydmljZS5vcHRpb25zU291cmNlLmlzUGFnZWQpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnBhZ2VkVmFsdWVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzUGFnZWRWYWx1ZXMob3B0aW9ucy5wYWdlZFZhbHVlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5wYWdlZFZhbHVlU2V0cykge1xuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc1BhZ2VkVmFsdWVTZXRzKG9wdGlvbnMucGFnZWRWYWx1ZVNldHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMudmFsdWVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0ZVNlcnZpY2UudXBkYXRlVmFsdWVMaXN0KG9wdGlvbnMudmFsdWVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvcHRpb25zLnZhbHVlU2V0cykge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdGVTZXJ2aWNlLnVwZGF0ZVZhbHVlU2V0TGlzdChvcHRpb25zLnZhbHVlU2V0cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnZhbHVlTGlzdC5hZGRpdGlvbmFsUmVtb3RlT3B0aW9ucyA9IDA7XG4gICAgICAgICAgICB0aGlzLnZhbHVlU2V0TGlzdC5hZGRpdGlvbmFsUmVtb3RlT3B0aW9ucyA9IDA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3NQYWdlZFZhbHVlcyhwYWdlZFZhbHVlczogSVBhZ2VkQ29sbGVjdGlvbjxJVmFsdWVPcHRpb24+KSB7XG4gICAgICAgIHRoaXMuc3RhdGVTZXJ2aWNlLnVwZGF0ZVZhbHVlTGlzdChwYWdlZFZhbHVlcy52YWx1ZXMpO1xuICAgICAgICB0aGlzLnZhbHVlTGlzdC5hZGRpdGlvbmFsUmVtb3RlT3B0aW9ucyA9IHBhZ2VkVmFsdWVzLnRvdGFsSXRlbXMgLSB0aGlzLnZhbHVlTGlzdC5vcHRpb25zLnNpemU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzUGFnZWRWYWx1ZVNldHMocGFnZWRWYWx1ZVNldHM6IElQYWdlZENvbGxlY3Rpb248SVZhbHVlU2V0T3B0aW9uPikge1xuICAgICAgICB0aGlzLnN0YXRlU2VydmljZS51cGRhdGVWYWx1ZVNldExpc3QocGFnZWRWYWx1ZVNldHMudmFsdWVzKTtcbiAgICAgICAgdGhpcy52YWx1ZVNldExpc3QuYWRkaXRpb25hbFJlbW90ZU9wdGlvbnMgPSBwYWdlZFZhbHVlU2V0cy50b3RhbEl0ZW1zIC0gdGhpcy52YWx1ZVNldExpc3Qub3B0aW9ucy5zaXplO1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRSZW1vdGVRdWVyeVBhcmFtcyh0eXBlOiBQaWNrbGlzdFZhbHVlVHlwZSwgc2VsZWN0QWxsQ291bnQ6IG51bWJlciB8IG51bGwgPSBudWxsKTogUGlja2xpc3RSZW1vdGVRdWVyeU9wdGlvbnMge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSBuZXcgUGlja2xpc3RSZW1vdGVRdWVyeU9wdGlvbnModGhpcy5zdGF0ZVNlcnZpY2UucGlja2xpc3QsIHRoaXMuc2VhcmNoVGVybSwgdHlwZSk7XG4gICAgICAgIGlmICh0eXBlID09PSAndmFsdWVzJyB8fCB0eXBlID09PSAnYm90aCcpIHtcbiAgICAgICAgICAgIHBhcmFtcy52YWx1ZVBhZ2VTZXR0aW5ncyA9IHRoaXMuYnVpbGRQYWdlU2V0dGluZ3ModGhpcy5jdXJyZW50VmFsdWVQYWdlLCBzZWxlY3RBbGxDb3VudCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZSA9PT0gJ3ZhbHVlc2V0cycgfHwgdHlwZSA9PT0gJ2JvdGgnKSB7XG4gICAgICAgICAgICBwYXJhbXMudmFsdWVTZXRQYWdlU2V0dGluZ3MgPSB0aGlzLmJ1aWxkUGFnZVNldHRpbmdzKHRoaXMuY3VycmVudFZhbHVlU2V0UGFnZSwgc2VsZWN0QWxsQ291bnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwYXJhbXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBidWlsZFBhZ2VTZXR0aW5ncyhjdXJyZW50UGFnZTogbnVtYmVyLCBzZWxlY3RBbGxDb3VudDogbnVtYmVyIHwgbnVsbCkge1xuICAgICAgICBjb25zdCBwYWdlclNldHRpbmdzID0ge2N1cnJlbnRQYWdlOiAxLCBpdGVtc1BlclBhZ2U6IHRoaXMuc3RhdGVTZXJ2aWNlLm9wdGlvbnNTb3VyY2UucGFnZVNpemV9O1xuICAgICAgICBwYWdlclNldHRpbmdzLmN1cnJlbnRQYWdlID0gc2VsZWN0QWxsQ291bnQgPyAxIDogY3VycmVudFBhZ2U7XG4gICAgICAgIHBhZ2VyU2V0dGluZ3MuaXRlbXNQZXJQYWdlID0gc2VsZWN0QWxsQ291bnQgfHwgcGFnZXJTZXR0aW5ncy5pdGVtc1BlclBhZ2U7XG4gICAgICAgIHJldHVybiBwYWdlclNldHRpbmdzO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVzZXRQYWdpbmdGb3JTZWxlY3RBbGxJZk5lZWRlZChzZWxlY3RBbGxDb3VudDogbnVtYmVyIHwgbnVsbCA9IG51bGwpIHtcbiAgICAgICAgaWYgKHNlbGVjdEFsbENvdW50KSB7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRWYWx1ZVBhZ2UgPSBNYXRoLmZsb29yKHNlbGVjdEFsbENvdW50IC8gdGhpcy5zdGF0ZVNlcnZpY2Uub3B0aW9uc1NvdXJjZS5wYWdlU2l6ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNsZWFyTGlzdHModHlwZTogUGlja2xpc3RWYWx1ZVR5cGUpIHtcbiAgICAgICAgaWYgKHR5cGUgPT09ICdib3RoJyB8fCB0eXBlID09PSAndmFsdWVzJykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZVNlcnZpY2UuY2xlYXJMaXN0KHRoaXMudmFsdWVMaXN0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZSA9PT0gJ2JvdGgnIHx8IHR5cGUgPT09ICd2YWx1ZXNldHMnKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlU2VydmljZS5jbGVhckxpc3QodGhpcy52YWx1ZVNldExpc3QpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjbGVhckZpbHRlcmVkT3B0aW9ucyh0eXBlOiBQaWNrbGlzdFZhbHVlVHlwZSkge1xuICAgICAgICBpZiAodHlwZSA9PT0gJ2JvdGgnIHx8IHR5cGUgPT09ICd2YWx1ZXMnKSB7XG4gICAgICAgICAgICB0aGlzLnZhbHVlTGlzdC5maWx0ZXJlZE9wdGlvbnMubGVuZ3RoID0gMDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZSA9PT0gJ2JvdGgnIHx8IHR5cGUgPT09ICd2YWx1ZXNldHMnKSB7XG4gICAgICAgICAgICB0aGlzLnZhbHVlU2V0TGlzdC5maWx0ZXJlZE9wdGlvbnMubGVuZ3RoID0gMDtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==