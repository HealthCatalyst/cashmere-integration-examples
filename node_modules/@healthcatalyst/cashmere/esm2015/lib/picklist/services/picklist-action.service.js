/**
 * @fileoverview added by tsickle
 * Generated from: lib/picklist/services/picklist-action.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { isSubList } from '../pane/picklist-pane.model';
import { PicklistService } from './picklist.service';
export class PicklistActionService {
    /**
     * @param {?} listService
     */
    constructor(listService) {
        this.listService = listService;
    }
    /**
     * @return {?}
     */
    get valueList() {
        return this.listService.valueList;
    }
    /**
     * @return {?}
     */
    get valueSetList() {
        return this.listService.valueSetList;
    }
    /**
     * @template T
     * @param {?} event
     * @param {?} index
     * @param {?} list
     * @param {?} item
     * @return {?}
     */
    onItemClicked(event, index, list, item) {
        if (event.shiftKey && list.lastClickedOption && !(item.code === list.lastClickedOption.code)) {
            this.shiftClick(index, list, item, list.lastClickedOption);
        }
        else if (event.ctrlKey) {
            this.ctrlClick(list, item);
        }
        else {
            // regular click
            this.selectNone();
            this.selectItem(list, item);
            list.lastClickedOption = item;
        }
    }
    /**
     * @template T
     * @param {?} event
     * @param {?} list
     * @param {?} item
     * @return {?}
     */
    onItemDoubleClicked(event, list, item) {
        this.selectNone();
        this.selectItem(list, item);
    }
    /**
     * @param {?} event
     * @param {?} valueset
     * @return {?}
     */
    onValuesetCaretClicked(event, valueset) {
        if (!valueset.showValues && valueset.subValuesSelectList.filteredOptions.length === 0) {
            this.listService.loadValuesForValueset(valueset);
        }
        valueset.showValues = !valueset.showValues;
    }
    /**
     * @return {?}
     */
    selectAll() {
        this.valueSetList.filteredOptions.forEach((/**
         * @param {?} v
         * @return {?}
         */
        v => {
            this.clearListSelection(v.subValuesSelectList);
        })); // deselect sublist items
        this.selectAllInList(this.valueList);
        this.selectAllInList(this.valueSetList);
    }
    /**
     * @return {?}
     */
    selectNone() {
        this.valueSetList.filteredOptions.forEach((/**
         * @param {?} v
         * @return {?}
         */
        v => {
            this.clearListSelection(v.subValuesSelectList);
        }));
        this.clearListSelection(this.valueList);
        this.clearListSelection(this.valueSetList);
    }
    /**
     * @template T
     * @param {?} list
     * @return {?}
     */
    selectAllInList(list) {
        if (!list.isActive) {
            return;
        }
        list.selectedOptions.clear();
        list.lastClickedOption = null;
        list.filteredOptions.forEach((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            item.selected = true;
            list.selectedOptions.set(item.code, item);
        }));
    }
    /**
     * @private
     * @template T
     * @param {?} list
     * @return {?}
     */
    clearListSelection(list) {
        list.selectedOptions.clear();
        list.lastClickedOption = null;
        list.filteredOptions.forEach((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            item.selected = false;
        }));
    }
    /**
     * @private
     * @template T
     * @param {?} index
     * @param {?} list
     * @param {?} item
     * @param {?} lastClickedItem
     * @return {?}
     */
    shiftClick(index, list, item, lastClickedItem) {
        /** @type {?} */
        const lastIndex = list.filteredOptions.indexOf(lastClickedItem);
        /** @type {?} */
        let largeIndex = Math.max(index, lastIndex);
        /** @type {?} */
        let smallIndex = Math.min(index, lastIndex);
        /** @type {?} */
        const formerLastClicked = list.lastClickedOption;
        this.selectNone();
        list.lastClickedOption = formerLastClicked;
        for (let i = smallIndex; i <= largeIndex; i++) {
            this.selectItem(list, list.filteredOptions[i]);
        }
    }
    /**
     * @private
     * @template T
     * @param {?} list
     * @param {?} item
     * @return {?}
     */
    ctrlClick(list, item) {
        // if ctrl clicking a sub value of a valueset that is selected (such that all subvalues appear selected)
        if (isSubList(list) && list.parentValueSet.selected) {
            this.selectAllInList(list);
            this.deselectItem(this.valueSetList, list.parentValueSet);
            this.deselectItem(list, item);
        }
        else {
            this.toggleItemSelection(list, item);
        }
        list.lastClickedOption = item;
    }
    /**
     * @private
     * @template T
     * @param {?} list
     * @param {?} item
     * @return {?}
     */
    deselectItem(list, item) {
        item.selected = false;
        list.selectedOptions.delete(item.code);
    }
    /**
     * @private
     * @template T
     * @param {?} list
     * @param {?} item
     * @return {?}
     */
    selectItem(list, item) {
        item.selected = true;
        list.selectedOptions.set(item.code, item);
    }
    /**
     * @private
     * @template T
     * @param {?} list
     * @param {?} item
     * @return {?}
     */
    toggleItemSelection(list, item) {
        if (item.selected) {
            this.deselectItem(list, item);
        }
        else {
            this.selectItem(list, item);
        }
    }
}
PicklistActionService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PicklistActionService.ctorParameters = () => [
    { type: PicklistService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    PicklistActionService.prototype.listService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlja2xpc3QtYWN0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaGVhbHRoY2F0YWx5c3QvY2FzaG1lcmUvIiwic291cmNlcyI6WyJsaWIvcGlja2xpc3Qvc2VydmljZXMvcGlja2xpc3QtYWN0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBdUIsU0FBUyxFQUF3RCxNQUFNLDZCQUE2QixDQUFDO0FBQ25JLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUduRCxNQUFNLE9BQU8scUJBQXFCOzs7O0lBTzlCLFlBQTJCLFdBQTRCO1FBQTVCLGdCQUFXLEdBQVgsV0FBVyxDQUFpQjtJQUFHLENBQUM7Ozs7SUFOM0QsSUFBVyxTQUFTO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUM7SUFDdEMsQ0FBQzs7OztJQUNELElBQVcsWUFBWTtRQUNuQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDO0lBQ3pDLENBQUM7Ozs7Ozs7OztJQUdNLGFBQWEsQ0FBNkIsS0FBaUIsRUFBRSxLQUFhLEVBQUUsSUFBNkIsRUFBRSxJQUFPO1FBQ3JILElBQUksS0FBSyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsaUJBQWlCLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzFGLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7U0FDOUQ7YUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDOUI7YUFBTTtZ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QztJQUMzQyxDQUFDOzs7Ozs7OztJQUVPLFVBQVUsQ0FBNkIsSUFBNkIsRUFBRSxJQUFPO1FBQ2pGLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQzs7Ozs7Ozs7SUFFTyxtQkFBbUIsQ0FBNkIsSUFBNkIsRUFBRSxJQUFPO1FBQzFGLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNmLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ2pDO2FBQU07WUFDSCxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztTQUMvQjtJQUNMLENBQUM7OztZQXJISixVQUFVOzs7O1lBRkgsZUFBZTs7Ozs7OztJQVVBLDRDQUFvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0ZpbHRlcmFibGVTZWxlY3RMaXN0LCBpc1N1Ykxpc3QsIFNlbGVjdExpc3RPcHRpb24sIFZhbHVlTGlzdE9wdGlvbiwgVmFsdWVTZXRMaXN0T3B0aW9ufSBmcm9tICcuLi9wYW5lL3BpY2tsaXN0LXBhbmUubW9kZWwnO1xuaW1wb3J0IHtQaWNrbGlzdFNlcnZpY2V9IGZyb20gJy4vcGlja2xpc3Quc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQaWNrbGlzdEFjdGlvblNlcnZpY2Uge1xuICAgIHB1YmxpYyBnZXQgdmFsdWVMaXN0KCk6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFZhbHVlTGlzdE9wdGlvbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5saXN0U2VydmljZS52YWx1ZUxpc3Q7XG4gICAgfVxuICAgIHB1YmxpYyBnZXQgdmFsdWVTZXRMaXN0KCk6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFZhbHVlU2V0TGlzdE9wdGlvbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5saXN0U2VydmljZS52YWx1ZVNldExpc3Q7XG4gICAgfVxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIGxpc3RTZXJ2aWNlOiBQaWNrbGlzdFNlcnZpY2UpIHt9XG5cbiAgICBwdWJsaWMgb25JdGVtQ2xpY2tlZDxUIGV4dGVuZHMgU2VsZWN0TGlzdE9wdGlvbj4oZXZlbnQ6IE1vdXNlRXZlbnQsIGluZGV4OiBudW1iZXIsIGxpc3Q6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFQ+LCBpdGVtOiBUKSB7XG4gICAgICAgIGlmIChldmVudC5zaGlmdEtleSAmJiBsaXN0Lmxhc3RDbGlja2VkT3B0aW9uICYmICEoaXRlbS5jb2RlID09PSBsaXN0Lmxhc3RDbGlja2VkT3B0aW9uLmNvZGUpKSB7XG4gICAgICAgICAgICB0aGlzLnNoaWZ0Q2xpY2soaW5kZXgsIGxpc3QsIGl0ZW0sIGxpc3QubGFzdENsaWNrZWRPcHRpb24pO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmN0cmxLZXkpIHtcbiAgICAgICAgICAgIHRoaXMuY3RybENsaWNrKGxpc3QsIGl0ZW0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gcmVndWxhciBjbGlja1xuICAgICAgICAgICAgdGhpcy5zZWxlY3ROb25lKCk7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdEl0ZW0obGlzdCwgaXRlbSk7XG4gICAgICAgICAgICBsaXN0Lmxhc3RDbGlja2VkT3B0aW9uID0gaXRlbTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBvbkl0ZW1Eb3VibGVDbGlja2VkPFQgZXh0ZW5kcyBTZWxlY3RMaXN0T3B0aW9uPihldmVudDogTW91c2VFdmVudCwgbGlzdDogRmlsdGVyYWJsZVNlbGVjdExpc3Q8VD4sIGl0ZW06IFQpIHtcbiAgICAgICAgdGhpcy5zZWxlY3ROb25lKCk7XG4gICAgICAgIHRoaXMuc2VsZWN0SXRlbShsaXN0LCBpdGVtKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25WYWx1ZXNldENhcmV0Q2xpY2tlZChldmVudDogTW91c2VFdmVudCwgdmFsdWVzZXQ6IFZhbHVlU2V0TGlzdE9wdGlvbikge1xuICAgICAgICBpZiAoIXZhbHVlc2V0LnNob3dWYWx1ZXMgJiYgdmFsdWVzZXQuc3ViVmFsdWVzU2VsZWN0TGlzdC5maWx0ZXJlZE9wdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLmxpc3RTZXJ2aWNlLmxvYWRWYWx1ZXNGb3JWYWx1ZXNldCh2YWx1ZXNldCk7XG4gICAgICAgIH1cbiAgICAgICAgdmFsdWVzZXQuc2hvd1ZhbHVlcyA9ICF2YWx1ZXNldC5zaG93VmFsdWVzO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZWxlY3RBbGwoKSB7XG4gICAgICAgIHRoaXMudmFsdWVTZXRMaXN0LmZpbHRlcmVkT3B0aW9ucy5mb3JFYWNoKHYgPT4ge1xuICAgICAgICAgICAgdGhpcy5jbGVhckxpc3RTZWxlY3Rpb24odi5zdWJWYWx1ZXNTZWxlY3RMaXN0KTtcbiAgICAgICAgfSk7IC8vIGRlc2VsZWN0IHN1Ymxpc3QgaXRlbXNcbiAgICAgICAgdGhpcy5zZWxlY3RBbGxJbkxpc3QodGhpcy52YWx1ZUxpc3QpO1xuICAgICAgICB0aGlzLnNlbGVjdEFsbEluTGlzdCh0aGlzLnZhbHVlU2V0TGlzdCk7XG4gICAgfVxuXG4gICAgcHVibGljIHNlbGVjdE5vbmUoKSB7XG4gICAgICAgIHRoaXMudmFsdWVTZXRMaXN0LmZpbHRlcmVkT3B0aW9ucy5mb3JFYWNoKHYgPT4ge1xuICAgICAgICAgICAgdGhpcy5jbGVhckxpc3RTZWxlY3Rpb24odi5zdWJWYWx1ZXNTZWxlY3RMaXN0KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY2xlYXJMaXN0U2VsZWN0aW9uKHRoaXMudmFsdWVMaXN0KTtcbiAgICAgICAgdGhpcy5jbGVhckxpc3RTZWxlY3Rpb24odGhpcy52YWx1ZVNldExpc3QpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZWxlY3RBbGxJbkxpc3Q8VCBleHRlbmRzIFNlbGVjdExpc3RPcHRpb24+KGxpc3Q6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFQ+KSB7XG4gICAgICAgIGlmICghbGlzdC5pc0FjdGl2ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbGlzdC5zZWxlY3RlZE9wdGlvbnMuY2xlYXIoKTtcbiAgICAgICAgbGlzdC5sYXN0Q2xpY2tlZE9wdGlvbiA9IG51bGw7XG5cbiAgICAgICAgbGlzdC5maWx0ZXJlZE9wdGlvbnMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgICAgIGl0ZW0uc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgbGlzdC5zZWxlY3RlZE9wdGlvbnMuc2V0KGl0ZW0uY29kZSwgaXRlbSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYXJMaXN0U2VsZWN0aW9uPFQgZXh0ZW5kcyBTZWxlY3RMaXN0T3B0aW9uPihsaXN0OiBGaWx0ZXJhYmxlU2VsZWN0TGlzdDxUPikge1xuICAgICAgICBsaXN0LnNlbGVjdGVkT3B0aW9ucy5jbGVhcigpO1xuICAgICAgICBsaXN0Lmxhc3RDbGlja2VkT3B0aW9uID0gbnVsbDtcblxuICAgICAgICBsaXN0LmZpbHRlcmVkT3B0aW9ucy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICAgICAgaXRlbS5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNoaWZ0Q2xpY2s8VCBleHRlbmRzIFNlbGVjdExpc3RPcHRpb24+KGluZGV4OiBudW1iZXIsIGxpc3Q6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFQ+LCBpdGVtOiBULCBsYXN0Q2xpY2tlZEl0ZW06IFQpIHtcbiAgICAgICAgY29uc3QgbGFzdEluZGV4ID0gbGlzdC5maWx0ZXJlZE9wdGlvbnMuaW5kZXhPZihsYXN0Q2xpY2tlZEl0ZW0pO1xuICAgICAgICBsZXQgbGFyZ2VJbmRleCA9IE1hdGgubWF4KGluZGV4LCBsYXN0SW5kZXgpO1xuICAgICAgICBsZXQgc21hbGxJbmRleCA9IE1hdGgubWluKGluZGV4LCBsYXN0SW5kZXgpO1xuXG4gICAgICAgIGNvbnN0IGZvcm1lckxhc3RDbGlja2VkID0gbGlzdC5sYXN0Q2xpY2tlZE9wdGlvbjtcbiAgICAgICAgdGhpcy5zZWxlY3ROb25lKCk7XG4gICAgICAgIGxpc3QubGFzdENsaWNrZWRPcHRpb24gPSBmb3JtZXJMYXN0Q2xpY2tlZDtcblxuICAgICAgICBmb3IgKGxldCBpID0gc21hbGxJbmRleDsgaSA8PSBsYXJnZUluZGV4OyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0SXRlbShsaXN0LCBsaXN0LmZpbHRlcmVkT3B0aW9uc1tpXSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGN0cmxDbGljazxUIGV4dGVuZHMgU2VsZWN0TGlzdE9wdGlvbj4obGlzdDogRmlsdGVyYWJsZVNlbGVjdExpc3Q8VD4sIGl0ZW06IFQpIHtcbiAgICAgICAgLy8gaWYgY3RybCBjbGlja2luZyBhIHN1YiB2YWx1ZSBvZiBhIHZhbHVlc2V0IHRoYXQgaXMgc2VsZWN0ZWQgKHN1Y2ggdGhhdCBhbGwgc3VidmFsdWVzIGFwcGVhciBzZWxlY3RlZClcbiAgICAgICAgaWYgKGlzU3ViTGlzdChsaXN0KSAmJiBsaXN0LnBhcmVudFZhbHVlU2V0LnNlbGVjdGVkKSB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdEFsbEluTGlzdDxWYWx1ZUxpc3RPcHRpb24+KGxpc3QpO1xuICAgICAgICAgICAgdGhpcy5kZXNlbGVjdEl0ZW0odGhpcy52YWx1ZVNldExpc3QsIGxpc3QucGFyZW50VmFsdWVTZXQpO1xuICAgICAgICAgICAgdGhpcy5kZXNlbGVjdEl0ZW08VmFsdWVMaXN0T3B0aW9uPihsaXN0LCBpdGVtKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlSXRlbVNlbGVjdGlvbihsaXN0LCBpdGVtKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxpc3QubGFzdENsaWNrZWRPcHRpb24gPSBpdGVtO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGVzZWxlY3RJdGVtPFQgZXh0ZW5kcyBTZWxlY3RMaXN0T3B0aW9uPihsaXN0OiBGaWx0ZXJhYmxlU2VsZWN0TGlzdDxUPiwgaXRlbTogVCkge1xuICAgICAgICBpdGVtLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICAgIGxpc3Quc2VsZWN0ZWRPcHRpb25zLmRlbGV0ZShpdGVtLmNvZGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2VsZWN0SXRlbTxUIGV4dGVuZHMgU2VsZWN0TGlzdE9wdGlvbj4obGlzdDogRmlsdGVyYWJsZVNlbGVjdExpc3Q8VD4sIGl0ZW06IFQpIHtcbiAgICAgICAgaXRlbS5zZWxlY3RlZCA9IHRydWU7XG4gICAgICAgIGxpc3Quc2VsZWN0ZWRPcHRpb25zLnNldChpdGVtLmNvZGUsIGl0ZW0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgdG9nZ2xlSXRlbVNlbGVjdGlvbjxUIGV4dGVuZHMgU2VsZWN0TGlzdE9wdGlvbj4obGlzdDogRmlsdGVyYWJsZVNlbGVjdExpc3Q8VD4sIGl0ZW06IFQpIHtcbiAgICAgICAgaWYgKGl0ZW0uc2VsZWN0ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGVzZWxlY3RJdGVtKGxpc3QsIGl0ZW0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RJdGVtKGxpc3QsIGl0ZW0pO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19