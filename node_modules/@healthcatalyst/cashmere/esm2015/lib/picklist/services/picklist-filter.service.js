/**
 * @fileoverview added by tsickle
 * Generated from: lib/picklist/services/picklist-filter.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { WorkTrackerService } from '../../shared/work-tracker.service';
import { PicklistFilterRemoteService } from './picklist-filter-remote.service';
import { PicklistFilterLocalService } from './picklist-filter-local.service';
import { PicklistStateService } from './picklist-state.service';
export class PicklistFilterService {
    /**
     * @param {?} workTracker
     * @param {?} stateService
     * @param {?} remoteFilterService
     * @param {?} localFilterService
     */
    constructor(workTracker, stateService, remoteFilterService, localFilterService) {
        this.workTracker = workTracker;
        this.stateService = stateService;
        this.remoteFilterService = remoteFilterService;
        this.localFilterService = localFilterService;
        this.searchTerm = '';
    }
    /**
     * @return {?}
     */
    get valueList() {
        return this.stateService.valueList;
    }
    /**
     * @return {?}
     */
    get valueSetList() {
        return this.stateService.valueSetList;
    }
    /**
     * @return {?}
     */
    get searchTokens() {
        return this.searchTerm
            .toLocaleLowerCase()
            .replace(/\s+/g, ' ')
            .split(' ');
    }
    /**
     * @return {?}
     */
    reset() {
        this.remoteFilterService.reset(this);
        this.searchTerm = '';
    }
    /**
     * @param {?} searchTerm
     * @return {?}
     */
    runFilter(searchTerm) {
        this.searchTerm = searchTerm;
        if (!this.stateService.optionsSource.isPaged) {
            this.localFilterService.filter(this.valueList, this.searchTokens);
            this.localFilterService.filter(this.valueSetList, this.searchTokens);
        }
        else {
            this.remoteFilterService.currentValuePage = 1;
            this.remoteFilterService.currentValueSetPage = 1;
            /** @type {?} */
            const workTracker = this.workTracker.startObservable((/**
             * @return {?}
             */
            () => this.remoteFilterService.filter()));
            this.showListLoadingIndicators(workTracker, 'both');
        }
    }
    /**
     * @param {?=} type
     * @param {?=} shouldAppend
     * @param {?=} selectAllCount
     * @return {?}
     */
    filterOptionsRemote(type = 'both', shouldAppend = false, selectAllCount = null) {
        return this.remoteFilterService.filter(type, shouldAppend, selectAllCount);
    }
    /**
     * @param {?=} type
     * @param {?=} autoLoadMore
     * @return {?}
     */
    loadMore(type = 'both', autoLoadMore = false) {
        if (type === 'both' || type === 'values') {
            this.remoteFilterService.currentValuePage++;
        }
        if (type === 'both' || type === 'valuesets') {
            this.remoteFilterService.currentValueSetPage++;
        }
        /** @type {?} */
        const loading$ = this.workTracker.startObservable((/**
         * @return {?}
         */
        () => this.filterOptionsRemote(type, true)));
        this.showListLoadingIndicators(loading$, type, !autoLoadMore);
    }
    /**
     * @param {?} numberToLoad
     * @return {?}
     */
    loadForSelectAll(numberToLoad) {
        /** @type {?} */
        const loading$ = this.workTracker.startObservable((/**
         * @return {?}
         */
        () => this.filterOptionsRemote('values', false, numberToLoad)));
        this.showListLoadingIndicators(loading$, 'values');
        return loading$;
    }
    /**
     * @return {?}
     */
    reloadIfEmpty() {
        /** @type {?} */
        const valuesNeedReload = this.valueList.options.size === 0 && this.valueList.additionalRemoteOptions > 0;
        /** @type {?} */
        const valueSetsNeedReload = this.valueSetList.options.size === 0 && this.valueSetList.additionalRemoteOptions > 0;
        if (valuesNeedReload || valueSetsNeedReload) {
            this.runFilter(this.searchTerm);
        }
    }
    /**
     * @param {?} valuesMap
     * @param {?} list
     * @return {?}
     */
    preFilterOptionsForRemoteMode(valuesMap, list) {
        // if server is handling filtering, but I want to avoid the round trip to the server when moving options
        // I need to double check that those options belong before adding them, or risk errant option counts
        valuesMap.forEach((/**
         * @param {?} v
         * @return {?}
         */
        v => {
            if (!this.localFilterService.itemHasSearchTokens(list, v, this.searchTokens)) {
                valuesMap.delete(v.code);
            }
        }));
    }
    /**
     * @param {?} workTracker
     * @param {?=} type
     * @param {?=} isAppending
     * @return {?}
     */
    showListLoadingIndicators(workTracker, type = 'both', isAppending = false) {
        if (type === 'both' || type === 'values') {
            this.showLoadingIndicatorForList(this.valueList, workTracker, isAppending);
        }
        if (type === 'both' || type === 'valuesets') {
            this.showLoadingIndicatorForList(this.valueSetList, workTracker, isAppending);
        }
    }
    /**
     * @private
     * @param {?} list
     * @param {?} tracker
     * @param {?=} isAppending
     * @return {?}
     */
    showLoadingIndicatorForList(list, tracker, isAppending = false) {
        if (isAppending) {
            list.appendingOptions = tracker;
        }
        else {
            list.loadingOptions = tracker;
        }
    }
}
PicklistFilterService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PicklistFilterService.ctorParameters = () => [
    { type: WorkTrackerService },
    { type: PicklistStateService },
    { type: PicklistFilterRemoteService },
    { type: PicklistFilterLocalService }
];
if (false) {
    /** @type {?} */
    PicklistFilterService.prototype.searchTerm;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterService.prototype.workTracker;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterService.prototype.stateService;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterService.prototype.remoteFilterService;
    /**
     * @type {?}
     * @private
     */
    PicklistFilterService.prototype.localFilterService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGlja2xpc3QtZmlsdGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaGVhbHRoY2F0YWx5c3QvY2FzaG1lcmUvIiwic291cmNlcyI6WyJsaWIvcGlja2xpc3Qvc2VydmljZXMvcGlja2xpc3QtZmlsdGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBS3pDLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLG1DQUFtQyxDQUFDO0FBQ3JFLE9BQU8sRUFBQywyQkFBMkIsRUFBQyxNQUFNLGtDQUFrQyxDQUFDO0FBQzdFLE9BQU8sRUFBQywwQkFBMEIsRUFBQyxNQUFNLGlDQUFpQyxDQUFDO0FBQzNFLE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBRzlELE1BQU0sT0FBTyxxQkFBcUI7Ozs7Ozs7SUFlOUIsWUFDWSxXQUErQixFQUMvQixZQUFrQyxFQUNsQyxtQkFBZ0QsRUFDaEQsa0JBQThDO1FBSDlDLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUMvQixpQkFBWSxHQUFaLFlBQVksQ0FBc0I7UUFDbEMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUE2QjtRQUNoRCx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQTRCO1FBTm5ELGVBQVUsR0FBRyxFQUFFLENBQUM7SUFPcEIsQ0FBQzs7OztJQW5CSixJQUFXLFNBQVM7UUFDaEIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztJQUN2QyxDQUFDOzs7O0lBQ0QsSUFBVyxZQUFZO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUM7SUFDMUMsQ0FBQzs7OztJQUNELElBQVcsWUFBWTtRQUNuQixPQUFPLElBQUksQ0FBQyxVQUFVO2FBQ2pCLGlCQUFpQixFQUFFO2FBQ25CLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDO2FBQ3BCLEtBQUssQ0FB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O1lBR2xCLG9CQUFvQjtZQUZwQiwyQkFBMkI7WUFDM0IsMEJBQTBCOzs7O0lBaUI5QiwyQ0FBdUI7Ozs7O0lBR25CLDRDQUF1Qzs7Ozs7SUFDdkMsNkNBQTBDOzs7OztJQUMxQyxvREFBd0Q7Ozs7O0lBQ3hELG1EQUFzRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge09ic2VydmFibGUsIFN1YnNjcmlwdGlvbn0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7RmlsdGVyYWJsZVNlbGVjdExpc3QsIFNlbGVjdExpc3RPcHRpb24sIFZhbHVlTGlzdE9wdGlvbiwgVmFsdWVTZXRMaXN0T3B0aW9ufSBmcm9tICcuLi9wYW5lL3BpY2tsaXN0LXBhbmUubW9kZWwnO1xuaW1wb3J0IHtQaWNrbGlzdFZhbHVlVHlwZX0gZnJvbSAnLi4vcGlja2xpc3QubW9kZWwnO1xuaW1wb3J0IHtXb3JrVHJhY2tlclNlcnZpY2V9IGZyb20gJy4uLy4uL3NoYXJlZC93b3JrLXRyYWNrZXIuc2VydmljZSc7XG5pbXBvcnQge1BpY2tsaXN0RmlsdGVyUmVtb3RlU2VydmljZX0gZnJvbSAnLi9waWNrbGlzdC1maWx0ZXItcmVtb3RlLnNlcnZpY2UnO1xuaW1wb3J0IHtQaWNrbGlzdEZpbHRlckxvY2FsU2VydmljZX0gZnJvbSAnLi9waWNrbGlzdC1maWx0ZXItbG9jYWwuc2VydmljZSc7XG5pbXBvcnQge1BpY2tsaXN0U3RhdGVTZXJ2aWNlfSBmcm9tICcuL3BpY2tsaXN0LXN0YXRlLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGlja2xpc3RGaWx0ZXJTZXJ2aWNlIHtcbiAgICBwdWJsaWMgZ2V0IHZhbHVlTGlzdCgpOiBGaWx0ZXJhYmxlU2VsZWN0TGlzdDxWYWx1ZUxpc3RPcHRpb24+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGVTZXJ2aWNlLnZhbHVlTGlzdDtcbiAgICB9XG4gICAgcHVibGljIGdldCB2YWx1ZVNldExpc3QoKTogRmlsdGVyYWJsZVNlbGVjdExpc3Q8VmFsdWVTZXRMaXN0T3B0aW9uPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlU2VydmljZS52YWx1ZVNldExpc3Q7XG4gICAgfVxuICAgIHB1YmxpYyBnZXQgc2VhcmNoVG9rZW5zKCk6IHN0cmluZ1tdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VhcmNoVGVybVxuICAgICAgICAgICAgLnRvTG9jYWxlTG93ZXJDYXNlKClcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXHMrL2csICcgJylcbiAgICAgICAgICAgIC5zcGxpdCgnICcpO1xuICAgIH1cbiAgICBwdWJsaWMgc2VhcmNoVGVybSA9ICcnO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgd29ya1RyYWNrZXI6IFdvcmtUcmFja2VyU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBzdGF0ZVNlcnZpY2U6IFBpY2tsaXN0U3RhdGVTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHJlbW90ZUZpbHRlclNlcnZpY2U6IFBpY2tsaXN0RmlsdGVyUmVtb3RlU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBsb2NhbEZpbHRlclNlcnZpY2U6IFBpY2tsaXN0RmlsdGVyTG9jYWxTZXJ2aWNlXG4gICAgKSB7fVxuXG4gICAgcHVibGljIHJlc2V0KCkge1xuICAgICAgICB0aGlzLnJlbW90ZUZpbHRlclNlcnZpY2UucmVzZXQodGhpcyk7XG4gICAgICAgIHRoaXMuc2VhcmNoVGVybSA9ICcnO1xuICAgIH1cblxuICAgIHB1YmxpYyBydW5GaWx0ZXIoc2VhcmNoVGVybTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuc2VhcmNoVGVybSA9IHNlYXJjaFRlcm07XG4gICAgICAgIGlmICghdGhpcy5zdGF0ZVNlcnZpY2Uub3B0aW9uc1NvdXJjZS5pc1BhZ2VkKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsRmlsdGVyU2VydmljZS5maWx0ZXIodGhpcy52YWx1ZUxpc3QsIHRoaXMuc2VhcmNoVG9rZW5zKTtcbiAgICAgICAgICAgIHRoaXMubG9jYWxGaWx0ZXJTZXJ2aWNlLmZpbHRlcih0aGlzLnZhbHVlU2V0TGlzdCwgdGhpcy5zZWFyY2hUb2tlbnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZW1vdGVGaWx0ZXJTZXJ2aWNlLmN1cnJlbnRWYWx1ZVBhZ2UgPSAxO1xuICAgICAgICAgICAgdGhpcy5yZW1vdGVGaWx0ZXJTZXJ2aWNlLmN1cnJlbnRWYWx1ZVNldFBhZ2UgPSAxO1xuICAgICAgICAgICAgY29uc3Qgd29ya1RyYWNrZXIgPSB0aGlzLndvcmtUcmFja2VyLnN0YXJ0T2JzZXJ2YWJsZSgoKSA9PiB0aGlzLnJlbW90ZUZpbHRlclNlcnZpY2UuZmlsdGVyKCkpO1xuICAgICAgICAgICAgdGhpcy5zaG93TGlzdExvYWRpbmdJbmRpY2F0b3JzKHdvcmtUcmFja2VyLCAnYm90aCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGZpbHRlck9wdGlvbnNSZW1vdGUodHlwZTogUGlja2xpc3RWYWx1ZVR5cGUgPSAnYm90aCcsIHNob3VsZEFwcGVuZCA9IGZhbHNlLCBzZWxlY3RBbGxDb3VudDogbnVtYmVyIHwgbnVsbCA9IG51bGwpOiBTdWJzY3JpcHRpb24ge1xuICAgICAgICByZXR1cm4gdGhpcy5yZW1vdGVGaWx0ZXJTZXJ2aWNlLmZpbHRlcih0eXBlLCBzaG91bGRBcHBlbmQsIHNlbGVjdEFsbENvdW50KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgbG9hZE1vcmUodHlwZTogUGlja2xpc3RWYWx1ZVR5cGUgPSAnYm90aCcsIGF1dG9Mb2FkTW9yZSA9IGZhbHNlKSB7XG4gICAgICAgIGlmICh0eXBlID09PSAnYm90aCcgfHwgdHlwZSA9PT0gJ3ZhbHVlcycpIHtcbiAgICAgICAgICAgIHRoaXMucmVtb3RlRmlsdGVyU2VydmljZS5jdXJyZW50VmFsdWVQYWdlKys7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUgPT09ICdib3RoJyB8fCB0eXBlID09PSAndmFsdWVzZXRzJykge1xuICAgICAgICAgICAgdGhpcy5yZW1vdGVGaWx0ZXJTZXJ2aWNlLmN1cnJlbnRWYWx1ZVNldFBhZ2UrKztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBsb2FkaW5nJCA9IHRoaXMud29ya1RyYWNrZXIuc3RhcnRPYnNlcnZhYmxlKCgpID0+IHRoaXMuZmlsdGVyT3B0aW9uc1JlbW90ZSh0eXBlLCB0cnVlKSk7XG4gICAgICAgIHRoaXMuc2hvd0xpc3RMb2FkaW5nSW5kaWNhdG9ycyhsb2FkaW5nJCwgdHlwZSwgIWF1dG9Mb2FkTW9yZSk7XG4gICAgfVxuXG4gICAgcHVibGljIGxvYWRGb3JTZWxlY3RBbGwobnVtYmVyVG9Mb2FkOiBudW1iZXIpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgbG9hZGluZyQgPSB0aGlzLndvcmtUcmFja2VyLnN0YXJ0T2JzZXJ2YWJsZSgoKSA9PiB0aGlzLmZpbHRlck9wdGlvbnNSZW1vdGUoJ3ZhbHVlcycsIGZhbHNlLCBudW1iZXJUb0xvYWQpKTtcbiAgICAgICAgdGhpcy5zaG93TGlzdExvYWRpbmdJbmRpY2F0b3JzKGxvYWRpbmckLCAndmFsdWVzJyk7XG4gICAgICAgIHJldHVybiBsb2FkaW5nJDtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVsb2FkSWZFbXB0eSgpIHtcbiAgICAgICAgY29uc3QgdmFsdWVzTmVlZFJlbG9hZCA9IHRoaXMudmFsdWVMaXN0Lm9wdGlvbnMuc2l6ZSA9PT0gMCAmJiB0aGlzLnZhbHVlTGlzdC5hZGRpdGlvbmFsUmVtb3RlT3B0aW9ucyA+IDA7XG4gICAgICAgIGNvbnN0IHZhbHVlU2V0c05lZWRSZWxvYWQgPSB0aGlzLnZhbHVlU2V0TGlzdC5vcHRpb25zLnNpemUgPT09IDAgJiYgdGhpcy52YWx1ZVNldExpc3QuYWRkaXRpb25hbFJlbW90ZU9wdGlvbnMgPiAwO1xuICAgICAgICBpZiAodmFsdWVzTmVlZFJlbG9hZCB8fCB2YWx1ZVNldHNOZWVkUmVsb2FkKSB7XG4gICAgICAgICAgICB0aGlzLnJ1bkZpbHRlcih0aGlzLnNlYXJjaFRlcm0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHByZUZpbHRlck9wdGlvbnNGb3JSZW1vdGVNb2RlKHZhbHVlc01hcDogTWFwPHN0cmluZywgU2VsZWN0TGlzdE9wdGlvbj4sIGxpc3Q6IEZpbHRlcmFibGVTZWxlY3RMaXN0PFNlbGVjdExpc3RPcHRpb24+KSB7XG4gICAgICAgIC8vIGlmIHNlcnZlciBpcyBoYW5kbGluZyBmaWx0ZXJpbmcsIGJ1dCBJIHdhbnQgdG8gYXZvaWQgdGhlIHJvdW5kIHRyaXAgdG8gdGhlIHNlcnZlciB3aGVuIG1vdmluZyBvcHRpb25zXG4gICAgICAgIC8vIEkgbmVlZCB0byBkb3VibGUgY2hlY2sgdGhhdCB0aG9zZSBvcHRpb25zIGJlbG9uZyBiZWZvcmUgYWRkaW5nIHRoZW0sIG9yIHJpc2sgZXJyYW50IG9wdGlvbiBjb3VudHNcbiAgICAgICAgdmFsdWVzTWFwLmZvckVhY2godiA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMubG9jYWxGaWx0ZXJTZXJ2aWNlLml0ZW1IYXNTZWFyY2hUb2tlbnMobGlzdCwgdiwgdGhpcy5zZWFyY2hUb2tlbnMpKSB7XG4gICAgICAgICAgICAgICAgdmFsdWVzTWFwLmRlbGV0ZSh2LmNvZGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2hvd0xpc3RMb2FkaW5nSW5kaWNhdG9ycyh3b3JrVHJhY2tlcjogT2JzZXJ2YWJsZTxib29sZWFuPiwgdHlwZTogUGlja2xpc3RWYWx1ZVR5cGUgPSAnYm90aCcsIGlzQXBwZW5kaW5nID0gZmFsc2UpIHtcbiAgICAgICAgaWYgKHR5cGUgPT09ICdib3RoJyB8fCB0eXBlID09PSAndmFsdWVzJykge1xuICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZ0luZGljYXRvckZvckxpc3QodGhpcy52YWx1ZUxpc3QsIHdvcmtUcmFja2VyLCBpc0FwcGVuZGluZyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUgPT09ICdib3RoJyB8fCB0eXBlID09PSAndmFsdWVzZXRzJykge1xuICAgICAgICAgICAgdGhpcy5zaG93TG9hZGluZ0luZGljYXRvckZvckxpc3QodGhpcy52YWx1ZVNldExpc3QsIHdvcmtUcmFja2VyLCBpc0FwcGVuZGluZyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNob3dMb2FkaW5nSW5kaWNhdG9yRm9yTGlzdChsaXN0OiBGaWx0ZXJhYmxlU2VsZWN0TGlzdDxTZWxlY3RMaXN0T3B0aW9uPiwgdHJhY2tlcjogT2JzZXJ2YWJsZTxib29sZWFuPiwgaXNBcHBlbmRpbmcgPSBmYWxzZSkge1xuICAgICAgICBpZiAoaXNBcHBlbmRpbmcpIHtcbiAgICAgICAgICAgIGxpc3QuYXBwZW5kaW5nT3B0aW9ucyA9IHRyYWNrZXI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsaXN0LmxvYWRpbmdPcHRpb25zID0gdHJhY2tlcjtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==