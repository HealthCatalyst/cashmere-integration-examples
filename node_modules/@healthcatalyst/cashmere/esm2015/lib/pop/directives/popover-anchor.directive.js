/**
 * @fileoverview added by tsickle
 * Generated from: lib/pop/directives/popover-anchor.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, EventEmitter, Input, Output, ViewContainerRef, HostListener, HostBinding } from '@angular/core';
import { Subject, merge } from 'rxjs';
import { tap, takeUntil } from 'rxjs/operators';
import { HcPopComponent } from '../popover.component';
import { getInvalidPopoverError, getInvalidTriggerError } from '../popover.errors';
import { HcPopoverAnchoringService } from '../popover-anchoring.service';
import { VALID_TRIGGER } from '../types';
import { PopoverNotification, NotificationAction } from '../notification.service';
import { HcPopoverAccessibilityService, KEY_CODE } from '../popover-accessibility.service';
export class HcPopoverAnchorDirective {
    /**
     * @param {?} _elementRef
     * @param {?} _viewContainerRef
     * @param {?} _anchoring
     * @param {?} _accessibility
     */
    constructor(_elementRef, _viewContainerRef, _anchoring, _accessibility) {
        this._elementRef = _elementRef;
        this._viewContainerRef = _viewContainerRef;
        this._anchoring = _anchoring;
        this._accessibility = _accessibility;
        this._trigger = 'click';
        this._hasSubmenu = false;
        /**
         * Emits when the popover is opened.
         */
        this.popoverOpened = new EventEmitter();
        /**
         * Emits when the popover is closed.
         */
        this.popoverClosed = new EventEmitter();
        /**
         * Emits when the directive is destroyed.
         */
        this._onDestroy = new Subject();
    }
    /**
     * Reference to the popover instance.
     * @return {?}
     */
    get attachedPopover() {
        return this._attachedPopover;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set attachedPopover(value) {
        this._validateAttachedPopover(value);
        this._attachedPopover = value;
        // Anchor the popover to the element ref
        this._anchoring.anchor(this.attachedPopover, this._viewContainerRef, this);
    }
    /**
     * Trigger event to toggle the popover. *Defaults to `"click"`.*
     * Accepts `click`, `mousedown`, `hover`, `rightclick`, or `none`.
     * Note: if "hover" is selected, the backdrop for the popover will be disabled.
     * @return {?}
     */
    get trigger() {
        return this._trigger;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set trigger(val) {
        this._validateTrigger(val);
        if (this._trigger !== val) {
            this._trigger = val;
        }
        this._dispatchConfigNotification(new PopoverNotification(NotificationAction.UPDATE_CONFIG));
    }
    /**
     * Object or value that can be passed into the popover to customize its content
     * @return {?}
     */
    get context() {
        return this._anchoring._context;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set context(val) {
        this._anchoring._context = val;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        // Re-emit open and close events
        /** @type {?} */
        const opened$ = this._anchoring.popoverOpened.pipe(tap((/**
         * @return {?}
         */
        () => this.popoverOpened.emit())));
        /** @type {?} */
        const closed$ = this._anchoring.popoverClosed.pipe(tap((/**
         * @param {?} value
         * @return {?}
         */
        value => this.popoverClosed.emit(value))));
        merge(opened$, closed$)
            .pipe(takeUntil(this._onDestroy))
            .subscribe();
    }
    /**
     * @return {?}
     */
    ngAfterContentInit() {
        this._setupKeyboardEvents();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this._onDestroy.next();
        this._onDestroy.complete();
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    _showOrHideOnClick($event) {
        if (this._hasSubmenu && event) {
            // Prevent the popover component from auto closing on click if a submenu was selected
            event.stopPropagation();
            event.preventDefault();
        }
        if (this.trigger !== 'click') {
            return;
        }
        this._attachedPopover._offsetPos[0] = this._attachedPopover.horizontalAlign === 'mouse' ? $event.offsetX : 0;
        this._attachedPopover._offsetPos[1] = this._attachedPopover.verticalAlign === 'mouse' ? $event.offsetY : 0;
        this.togglePopover();
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    _showOrHideOnMouseOver($event) {
        if (this.trigger !== 'mousedown') {
            return;
        }
        this._attachedPopover._offsetPos[0] = this._attachedPopover.horizontalAlign === 'mouse' ? $event.offsetX : 0;
        this._attachedPopover._offsetPos[1] = this._attachedPopover.verticalAlign === 'mouse' ? $event.offsetY : 0;
        this.togglePopover();
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    _showOrHideRightClick($event) {
        if (this.trigger !== 'rightclick') {
            return true;
        }
        else {
            this._attachedPopover._offsetPos[0] = this._attachedPopover.horizontalAlign === 'mouse' ? $event.offsetX : 0;
            this._attachedPopover._offsetPos[1] = this._attachedPopover.verticalAlign === 'mouse' ? $event.offsetY : 0;
            this.togglePopover();
            return false;
        }
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    _showOnHover($event) {
        if (this.trigger !== 'hover') {
            return;
        }
        this._attachedPopover._offsetPos[0] = this._attachedPopover.horizontalAlign === 'mouse' ? $event.offsetX : 0;
        this._attachedPopover._offsetPos[1] = this._attachedPopover.verticalAlign === 'mouse' ? $event.offsetY : 0;
        this.openPopover();
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    _hideOnLeave($event) {
        if (this.trigger !== 'hover') {
            return;
        }
        this.closePopover();
    }
    /**
     * Handle keyboard navigation of a hcMenu using the arrow or tab keys
     * @param {?} event
     * @return {?}
     */
    _keyEvent(event) {
        if (this.attachedPopover.isOpen() && this.attachedPopover._menuItems.length > 0 && !this.attachedPopover._subMenuOpen) {
            if (event.keyCode === KEY_CODE.UP_ARROW || (event.keyCode === KEY_CODE.TAB && event.shiftKey)) {
                event.stopPropagation();
                event.preventDefault();
                this.attachedPopover._keyFocus(false);
            }
            else if (event.keyCode === KEY_CODE.DOWN_ARROW || (event.keyCode === KEY_CODE.TAB && !event.shiftKey)) {
                event.stopPropagation();
                event.preventDefault();
                this.attachedPopover._keyFocus(true);
            }
            else if (this.attachedPopover.parent && this.attachedPopover.parent.isOpen() && event.keyCode === KEY_CODE.LEFT_ARROW) {
                event.stopPropagation();
                event.preventDefault();
                this.closePopover();
            }
        }
        if (this._hasSubmenu && this._elementRef.nativeElement === document.activeElement && event.keyCode === KEY_CODE.RIGHT_ARROW) {
            event.stopPropagation();
            event.preventDefault();
            this.openPopover();
            this.attachedPopover._keyFocus(true);
        }
    }
    /**
     * Gets whether the popover is presently open.
     * @return {?}
     */
    isPopoverOpen() {
        return this._anchoring.isPopoverOpen();
    }
    /**
     * Toggles the popover between the open and closed states.
     * @return {?}
     */
    togglePopover() {
        this._anchoring.togglePopover();
    }
    /**
     * Opens the popover.
     * @param {?=} options
     * @return {?}
     */
    openPopover(options = {}) {
        this._anchoring.openPopover(options);
    }
    /**
     * Closes the popover.
     * @param {?=} value
     * @param {?=} neighborSubMenusAreOpen
     * @return {?}
     */
    closePopover(value, neighborSubMenusAreOpen = false) {
        this._anchoring.closePopover(value, neighborSubMenusAreOpen);
    }
    /**
     * Realign the popover to the anchor.
     * @return {?}
     */
    realignPopover() {
        this._anchoring.realignPopoverToAnchor();
    }
    /**
     * Get a reference to the anchor element.
     * @return {?}
     */
    getElement() {
        return this._elementRef;
    }
    /**
     * Throws an error if the popover instance is not provided.
     * @private
     * @param {?} popover
     * @return {?}
     */
    _validateAttachedPopover(popover) {
        if (!popover || !(popover instanceof HcPopComponent)) {
            throw getInvalidPopoverError();
        }
    }
    /**
     * Throws an error if the trigger is not a valid HcPopoverTrigger.
     * @private
     * @param {?} trig
     * @return {?}
     */
    _validateTrigger(trig) {
        if (VALID_TRIGGER.indexOf(trig) === -1) {
            throw getInvalidTriggerError(trig);
        }
    }
    /**
     * Dispatch a notification to the notification service, if possible.
     * @private
     * @param {?} notification
     * @return {?}
     */
    _dispatchConfigNotification(notification) {
        if (this._notifications) {
            this._notifications.dispatch(notification);
        }
    }
    /**
     * @private
     * @return {?}
     */
    _setupKeyboardEvents() {
        /** @type {?} */
        const notifier = {
            isOpen: false,
            nativeElement: this._elementRef.nativeElement,
            hasSubmenu: (/**
             * @return {?}
             */
            () => this._hasSubmenu),
            onKeyDown: (/**
             * @param {?} event
             * @return {?}
             */
            event => this._keyEvent(event))
        };
        this.popoverClosed.asObservable().subscribe((/**
         * @return {?}
         */
        () => (notifier.isOpen = false)));
        this.popoverOpened.asObservable().subscribe((/**
         * @return {?}
         */
        () => (notifier.isOpen = true)));
        this._accessibility.registerNotifier(notifier);
    }
}
HcPopoverAnchorDirective.decorators = [
    { type: Directive, args: [{
                selector: '[hcPop]',
                exportAs: 'hcPopAnchor',
                providers: [HcPopoverAnchoringService]
            },] }
];
/** @nocollapse */
HcPopoverAnchorDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: ViewContainerRef },
    { type: HcPopoverAnchoringService },
    { type: HcPopoverAccessibilityService }
];
HcPopoverAnchorDirective.propDecorators = {
    attachedPopover: [{ type: Input, args: ['hcPop',] }],
    trigger: [{ type: Input }],
    context: [{ type: Input }],
    _hasSubmenu: [{ type: HostBinding, args: ['class.hc-menu-item-submenu',] }],
    popoverOpened: [{ type: Output }],
    popoverClosed: [{ type: Output }],
    _showOrHideOnClick: [{ type: HostListener, args: ['click', ['$event'],] }],
    _showOrHideOnMouseOver: [{ type: HostListener, args: ['touchstart', ['$event'],] }, { type: HostListener, args: ['mousedown', ['$event'],] }],
    _showOrHideRightClick: [{ type: HostListener, args: ['contextmenu', ['$event'],] }],
    _showOnHover: [{ type: HostListener, args: ['mouseenter', ['$event'],] }],
    _hideOnLeave: [{ type: HostListener, args: ['touchend', ['$event'],] }, { type: HostListener, args: ['touchcancel', ['$event'],] }, { type: HostListener, args: ['mouseleave', ['$event'],] }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    HcPopoverAnchorDirective.prototype._attachedPopover;
    /**
     * @type {?}
     * @private
     */
    HcPopoverAnchorDirective.prototype._trigger;
    /** @type {?} */
    HcPopoverAnchorDirective.prototype._hasSubmenu;
    /**
     * Emits when the popover is opened.
     * @type {?}
     */
    HcPopoverAnchorDirective.prototype.popoverOpened;
    /**
     * Emits when the popover is closed.
     * @type {?}
     */
    HcPopoverAnchorDirective.prototype.popoverClosed;
    /**
     * Instance of notification service. Will be undefined until attached to a popover.
     * @type {?}
     */
    HcPopoverAnchorDirective.prototype._notifications;
    /**
     * Emits when the directive is destroyed.
     * @type {?}
     * @private
     */
    HcPopoverAnchorDirective.prototype._onDestroy;
    /** @type {?} */
    HcPopoverAnchorDirective.prototype._elementRef;
    /**
     * @type {?}
     * @private
     */
    HcPopoverAnchorDirective.prototype._viewContainerRef;
    /** @type {?} */
    HcPopoverAnchorDirective.prototype._anchoring;
    /**
     * @type {?}
     * @private
     */
    HcPopoverAnchorDirective.prototype._accessibility;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wb3Zlci1hbmNob3IuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGhlYWx0aGNhdGFseXN0L2Nhc2htZXJlLyIsInNvdXJjZXMiOlsibGliL3BvcC9kaXJlY3RpdmVzL3BvcG92ZXItYW5jaG9yLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFDSCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBR0wsTUFBTSxFQUNOLGdCQUFnQixFQUNoQixZQUFZLEVBQ1osV0FBVyxFQUVkLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxPQUFPLEVBQUUsS0FBSyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3BDLE9BQU8sRUFBQyxHQUFHLEVBQUUsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFOUMsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ3BELE9BQU8sRUFBQyxzQkFBc0IsRUFBRSxzQkFBc0IsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ2pGLE9BQU8sRUFBQyx5QkFBeUIsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBQ3ZFLE9BQU8sRUFBeUMsYUFBYSxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQy9FLE9BQU8sRUFBQyxtQkFBbUIsRUFBOEIsa0JBQWtCLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUM1RyxPQUFPLEVBQUMsNkJBQTZCLEVBQXlCLFFBQVEsRUFBQyxNQUFNLGtDQUFrQyxDQUFDO0FBT2hILE1BQU0sT0FBTyx3QkFBd0I7Ozs7Ozs7SUFzRGpDLFlBQ1csV0FBdUIsRUFDdEIsaUJBQW1DLEVBQ3BDLFVBQXFDLEVBQ3BDLGNBQTZDO1FBSDlDLGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBQ3RCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBa0I7UUFDcEMsZUFBVSxHQUFWLFVBQVUsQ0FBMkI7UUFDcEMsbUJBQWMsR0FBZCxjQUFjLENBQStC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QUUsQ0FBQyxRQUFRLENBQUMsY0FDckMsWUFBWSxTQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQztvQ0FVcEMsWUFBWSxTQUFDLGFBQWEsRUFBRSxDQUFDLFFBQVEsQ0FBQzsyQkFZdEMsWUFBWSxTQUFDLFlBQVksRUFBRSxDQUFDLFFBQVEsQ0FBQzsyQkFVckMsWUFBWSxTQUFDLFVBQVUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxjQUNuQyxZQUFZLFNBQUMsYUFBYSxFQUFFLENBQUMsUUFBUSxDQUFDLGNBQ3RDLFlBQVksU0FBQyxZQUFZLEVBQUUsQ0FBQyxRQUFRLENBQUM7Ozs7Ozs7SUFySHRDLG9EQUF5Qzs7Ozs7SUFnQnpDLDRDQUE2Qzs7SUFXN0MsK0NBQ29COzs7OztJQUdwQixpREFBbUQ7Ozs7O0lBR25ELGlEQUFrRDs7Ozs7SUFHbEQsa0RBQTJDOzs7Ozs7SUFHM0MsOENBQXlDOztJQUdyQywrQ0FBOEI7Ozs7O0lBQzlCLHFEQUEyQzs7SUFDM0MsOENBQTRDOzs7OztJQUM1QyxrREFBcUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIERpcmVjdGl2ZSxcbiAgICBFbGVtZW50UmVmLFxuICAgIEV2ZW50RW1pdHRlcixcbiAgICBJbnB1dCxcbiAgICBPbkluaXQsXG4gICAgT25EZXN0cm95LFxuICAgIE91dHB1dCxcbiAgICBWaWV3Q29udGFpbmVyUmVmLFxuICAgIEhvc3RMaXN0ZW5lcixcbiAgICBIb3N0QmluZGluZyxcbiAgICBBZnRlckNvbnRlbnRJbml0XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtTdWJqZWN0LCBtZXJnZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge3RhcCwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7SGNQb3BDb21wb25lbnR9IGZyb20gJy4uL3BvcG92ZXIuY29tcG9uZW50JztcbmltcG9ydCB7Z2V0SW52YWxpZFBvcG92ZXJFcnJvciwgZ2V0SW52YWxpZFRyaWdnZXJFcnJvcn0gZnJvbSAnLi4vcG9wb3Zlci5lcnJvcnMnO1xuaW1wb3J0IHtIY1BvcG92ZXJBbmNob3JpbmdTZXJ2aWNlfSBmcm9tICcuLi9wb3BvdmVyLWFuY2hvcmluZy5zZXJ2aWNlJztcbmltcG9ydCB7SGNQb3BvdmVyT3Blbk9wdGlvbnMsIEhjUG9wb3ZlclRyaWdnZXIsIFZBTElEX1RSSUdHRVJ9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7UG9wb3Zlck5vdGlmaWNhdGlvbiwgUG9wb3Zlck5vdGlmaWNhdGlvblNlcnZpY2UsIE5vdGlmaWNhdGlvbkFjdGlvbn0gZnJvbSAnLi4vbm90aWZpY2F0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHtIY1BvcG92ZXJBY2Nlc3NpYmlsaXR5U2VydmljZSwgSGNQb3BLZXlib2FyZE5vdGlmaWVyLCBLRVlfQ09ERX0gZnJvbSAnLi4vcG9wb3Zlci1hY2Nlc3NpYmlsaXR5LnNlcnZpY2UnO1xuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1toY1BvcF0nLFxuICAgIGV4cG9ydEFzOiAnaGNQb3BBbmNob3InLFxuICAgIHByb3ZpZGVyczogW0hjUG9wb3ZlckFuY2hvcmluZ1NlcnZpY2VdXG59KVxuZXhwb3J0IGNsYXNzIEhjUG9wb3ZlckFuY2hvckRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95IHtcbiAgICAvKiogUmVmZXJlbmNlIHRvIHRoZSBwb3BvdmVyIGluc3RhbmNlLiAqL1xuICAgIEBJbnB1dCgnaGNQb3AnKVxuICAgIGdldCBhdHRhY2hlZFBvcG92ZXIoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9hdHRhY2hlZFBvcG92ZXI7XG4gICAgfVxuICAgIHNldCBhdHRhY2hlZFBvcG92ZXIodmFsdWU6IEhjUG9wQ29tcG9uZW50KSB7XG4gICAgICAgIHRoaXMuX3ZhbGlkYXRlQXR0YWNoZWRQb3BvdmVyKHZhbHVlKTtcbiAgICAgICAgdGhpcy5fYXR0YWNoZWRQb3BvdmVyID0gdmFsdWU7XG4gICAgICAgIC8vIEFuY2hvciB0aGUgcG9wb3ZlciB0byB0aGUgZWxlbWVudCByZWZcbiAgICAgICAgdGhpcy5fYW5jaG9yaW5nLmFuY2hvcih0aGlzLmF0dGFjaGVkUG9wb3ZlciwgdGhpcy5fdmlld0NvbnRhaW5lclJlZiwgdGhpcyk7XG4gICAgfVxuICAgIHByaXZhdGUgX2F0dGFjaGVkUG9wb3ZlcjogSGNQb3BDb21wb25lbnQ7XG5cbiAgICAvKiogVHJpZ2dlciBldmVudCB0byB0b2dnbGUgdGhlIHBvcG92ZXIuICpEZWZhdWx0cyB0byBgXCJjbGlja1wiYC4qXG4gICAgICogQWNjZXB0cyBgY2xpY2tgLCBgbW91c2Vkb3duYCwgYGhvdmVyYCwgYHJpZ2h0Y2xpY2tgLCBvciBgbm9uZWAuXG4gICAgICogTm90ZTogaWYgXCJob3ZlclwiIGlzIHNlbGVjdGVkLCB0aGUgYmFja2Ryb3AgZm9yIHRoZSBwb3BvdmVyIHdpbGwgYmUgZGlzYWJsZWQuICovXG4gICAgQElucHV0KClcbiAgICBnZXQgdHJpZ2dlcigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3RyaWdnZXI7XG4gICAgfVxuICAgIHNldCB0cmlnZ2VyKHZhbDogSGNQb3BvdmVyVHJpZ2dlcikge1xuICAgICAgICB0aGlzLl92YWxpZGF0ZVRyaWdnZXIodmFsKTtcbiAgICAgICAgaWYgKHRoaXMuX3RyaWdnZXIgIT09IHZhbCkge1xuICAgICAgICAgICAgdGhpcy5fdHJpZ2dlciA9IHZhbDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9kaXNwYXRjaENvbmZpZ05vdGlmaWNhdGlvbihuZXcgUG9wb3Zlck5vdGlmaWNhdGlvbihOb3RpZmljYXRpb25BY3Rpb24uVVBEQVRFX0NPTkZJRykpO1xuICAgIH1cbiAgICBwcml2YXRlIF90cmlnZ2VyOiBIY1BvcG92ZXJUcmlnZ2VyID0gJ2NsaWNrJztcblxuICAgIC8qKiBPYmplY3Qgb3IgdmFsdWUgdGhhdCBjYW4gYmUgcGFzc2VkIGludG8gdGhlIHBvcG92ZXIgdG8gY3VzdG9taXplIGl0cyBjb250ZW50ICovXG4gICAgQElucHV0KClcbiAgICBnZXQgY29udGV4dCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2FuY2hvcmluZy5fY29udGV4dDtcbiAgICB9XG4gICAgc2V0IGNvbnRleHQodmFsOiBhbnkpIHtcbiAgICAgICAgdGhpcy5fYW5jaG9yaW5nLl9jb250ZXh0ID0gdmFsO1xuICAgIH1cblxuICAgIEBIb3N0QmluZGluZygnY2xhc3MuaGMtbWVudS1pdGVtLXN1Ym1lbnUnKVxuICAgIF9oYXNTdWJtZW51ID0gZmFsc2U7XG5cbiAgICAvKiogRW1pdHMgd2hlbiB0aGUgcG9wb3ZlciBpcyBvcGVuZWQuICovXG4gICAgQE91dHB1dCgpIHBvcG92ZXJPcGVuZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG5cbiAgICAvKiogRW1pdHMgd2hlbiB0aGUgcG9wb3ZlciBpcyBjbG9zZWQuICovXG4gICAgQE91dHB1dCgpIHBvcG92ZXJDbG9zZWQgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICAgIC8qKiBJbnN0YW5jZSBvZiBub3RpZmljYXRpb24gc2VydmljZS4gV2lsbCBiZSB1bmRlZmluZWQgdW50aWwgYXR0YWNoZWQgdG8gYSBwb3BvdmVyLiAqL1xuICAgIF9ub3RpZmljYXRpb25zOiBQb3BvdmVyTm90aWZpY2F0aW9uU2VydmljZTtcblxuICAgIC8qKiBFbWl0cyB3aGVuIHRoZSBkaXJlY3RpdmUgaXMgZGVzdHJveWVkLiAqL1xuICAgIHByaXZhdGUgX29uRGVzdHJveSA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHVibGljIF9lbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgICAgICBwcml2YXRlIF92aWV3Q29udGFpbmVyUmVmOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgICAgICBwdWJsaWMgX2FuY2hvcmluZzogSGNQb3BvdmVyQW5jaG9yaW5nU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBfYWNjZXNzaWJpbGl0eTogSGNQb3BvdmVyQWNjZXNzaWJpbGl0eVNlcnZpY2VcbiAgICApIHt9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgLy8gUmUtZW1pdCBvcGVuIGFuZCBjbG9zZSBldmVudHNcbiAgICAgICAgY29uc3Qgb3BlbmVkJCA9IHRoaXMuX2FuY2hvcmluZy5wb3BvdmVyT3BlbmVkLnBpcGUodGFwKCgpID0+IHRoaXMucG9wb3Zlck9wZW5lZC5lbWl0KCkpKTtcbiAgICAgICAgY29uc3QgY2xvc2VkJCA9IHRoaXMuX2FuY2hvcmluZy5wb3BvdmVyQ2xvc2VkLnBpcGUodGFwKHZhbHVlID0+IHRoaXMucG9wb3ZlckNsb3NlZC5lbWl0KHZhbHVlKSkpO1xuICAgICAgICBtZXJnZShvcGVuZWQkLCBjbG9zZWQkKVxuICAgICAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuX29uRGVzdHJveSkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgbmdBZnRlckNvbnRlbnRJbml0KCkge1xuICAgICAgICB0aGlzLl9zZXR1cEtleWJvYXJkRXZlbnRzKCk7XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuX29uRGVzdHJveS5uZXh0KCk7XG4gICAgICAgIHRoaXMuX29uRGVzdHJveS5jb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJywgWyckZXZlbnQnXSlcbiAgICBfc2hvd09ySGlkZU9uQ2xpY2soJGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLl9oYXNTdWJtZW51ICYmIGV2ZW50KSB7XG4gICAgICAgICAgICAvLyBQcmV2ZW50IHRoZSBwb3BvdmVyIGNvbXBvbmVudCBmcm9tIGF1dG8gY2xvc2luZyBvbiBjbGljayBpZiBhIHN1Ym1lbnUgd2FzIHNlbGVjdGVkXG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudHJpZ2dlciAhPT0gJ2NsaWNrJykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2F0dGFjaGVkUG9wb3Zlci5fb2Zmc2V0UG9zWzBdID0gdGhpcy5fYXR0YWNoZWRQb3BvdmVyLmhvcml6b250YWxBbGlnbiA9PT0gJ21vdXNlJyA/ICRldmVudC5vZmZzZXRYIDogMDtcbiAgICAgICAgdGhpcy5fYXR0YWNoZWRQb3BvdmVyLl9vZmZzZXRQb3NbMV0gPSB0aGlzLl9hdHRhY2hlZFBvcG92ZXIudmVydGljYWxBbGlnbiA9PT0gJ21vdXNlJyA/ICRldmVudC5vZmZzZXRZIDogMDtcbiAgICAgICAgdGhpcy50b2dnbGVQb3BvdmVyKCk7XG4gICAgfVxuXG4gICAgQEhvc3RMaXN0ZW5lcigndG91Y2hzdGFydCcsIFsnJGV2ZW50J10pXG4gICAgQEhvc3RMaXN0ZW5lcignbW91c2Vkb3duJywgWyckZXZlbnQnXSlcbiAgICBfc2hvd09ySGlkZU9uTW91c2VPdmVyKCRldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy50cmlnZ2VyICE9PSAnbW91c2Vkb3duJykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2F0dGFjaGVkUG9wb3Zlci5fb2Zmc2V0UG9zWzBdID0gdGhpcy5fYXR0YWNoZWRQb3BvdmVyLmhvcml6b250YWxBbGlnbiA9PT0gJ21vdXNlJyA/ICRldmVudC5vZmZzZXRYIDogMDtcbiAgICAgICAgdGhpcy5fYXR0YWNoZWRQb3BvdmVyLl9vZmZzZXRQb3NbMV0gPSB0aGlzLl9hdHRhY2hlZFBvcG92ZXIudmVydGljYWxBbGlnbiA9PT0gJ21vdXNlJyA/ICRldmVudC5vZmZzZXRZIDogMDtcbiAgICAgICAgdGhpcy50b2dnbGVQb3BvdmVyKCk7XG4gICAgfVxuXG4gICAgQEhvc3RMaXN0ZW5lcignY29udGV4dG1lbnUnLCBbJyRldmVudCddKVxuICAgIF9zaG93T3JIaWRlUmlnaHRDbGljaygkZXZlbnQ6IE1vdXNlRXZlbnQpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMudHJpZ2dlciAhPT0gJ3JpZ2h0Y2xpY2snKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2F0dGFjaGVkUG9wb3Zlci5fb2Zmc2V0UG9zWzBdID0gdGhpcy5fYXR0YWNoZWRQb3BvdmVyLmhvcml6b250YWxBbGlnbiA9PT0gJ21vdXNlJyA/ICRldmVudC5vZmZzZXRYIDogMDtcbiAgICAgICAgICAgIHRoaXMuX2F0dGFjaGVkUG9wb3Zlci5fb2Zmc2V0UG9zWzFdID0gdGhpcy5fYXR0YWNoZWRQb3BvdmVyLnZlcnRpY2FsQWxpZ24gPT09ICdtb3VzZScgPyAkZXZlbnQub2Zmc2V0WSA6IDA7XG4gICAgICAgICAgICB0aGlzLnRvZ2dsZVBvcG92ZXIoKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ21vdXNlZW50ZXInLCBbJyRldmVudCddKVxuICAgIF9zaG93T25Ib3ZlcigkZXZlbnQ6IE1vdXNlRXZlbnQpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMudHJpZ2dlciAhPT0gJ2hvdmVyJykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2F0dGFjaGVkUG9wb3Zlci5fb2Zmc2V0UG9zWzBdID0gdGhpcy5fYXR0YWNoZWRQb3BvdmVyLmhvcml6b250YWxBbGlnbiA9PT0gJ21vdXNlJyA/ICRldmVudC5vZmZzZXRYIDogMDtcbiAgICAgICAgdGhpcy5fYXR0YWNoZWRQb3BvdmVyLl9vZmZzZXRQb3NbMV0gPSB0aGlzLl9hdHRhY2hlZFBvcG92ZXIudmVydGljYWxBbGlnbiA9PT0gJ21vdXNlJyA/ICRldmVudC5vZmZzZXRZIDogMDtcbiAgICAgICAgdGhpcy5vcGVuUG9wb3ZlcigpO1xuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ3RvdWNoZW5kJywgWyckZXZlbnQnXSlcbiAgICBASG9zdExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIFsnJGV2ZW50J10pXG4gICAgQEhvc3RMaXN0ZW5lcignbW91c2VsZWF2ZScsIFsnJGV2ZW50J10pXG4gICAgX2hpZGVPbkxlYXZlKCRldmVudDogTW91c2VFdmVudCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy50cmlnZ2VyICE9PSAnaG92ZXInKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jbG9zZVBvcG92ZXIoKTtcbiAgICB9XG5cbiAgICAvKiogSGFuZGxlIGtleWJvYXJkIG5hdmlnYXRpb24gb2YgYSBoY01lbnUgdXNpbmcgdGhlIGFycm93IG9yIHRhYiBrZXlzICovXG4gICAgX2tleUV2ZW50KGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmF0dGFjaGVkUG9wb3Zlci5pc09wZW4oKSAmJiB0aGlzLmF0dGFjaGVkUG9wb3Zlci5fbWVudUl0ZW1zLmxlbmd0aCA+IDAgJiYgIXRoaXMuYXR0YWNoZWRQb3BvdmVyLl9zdWJNZW51T3Blbikge1xuICAgICAgICAgICAgaWYgKGV2ZW50LmtleUNvZGUgPT09IEtFWV9DT0RFLlVQX0FSUk9XIHx8IChldmVudC5rZXlDb2RlID09PSBLRVlfQ09ERS5UQUIgJiYgZXZlbnQuc2hpZnRLZXkpKSB7XG4gICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmF0dGFjaGVkUG9wb3Zlci5fa2V5Rm9jdXMoZmFsc2UpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudC5rZXlDb2RlID09PSBLRVlfQ09ERS5ET1dOX0FSUk9XIHx8IChldmVudC5rZXlDb2RlID09PSBLRVlfQ09ERS5UQUIgJiYgIWV2ZW50LnNoaWZ0S2V5KSkge1xuICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5hdHRhY2hlZFBvcG92ZXIuX2tleUZvY3VzKHRydWUpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmF0dGFjaGVkUG9wb3Zlci5wYXJlbnQgJiYgdGhpcy5hdHRhY2hlZFBvcG92ZXIucGFyZW50LmlzT3BlbigpICYmIGV2ZW50LmtleUNvZGUgPT09IEtFWV9DT0RFLkxFRlRfQVJST1cpIHtcbiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VQb3BvdmVyKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuX2hhc1N1Ym1lbnUgJiYgdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50ID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGV2ZW50LmtleUNvZGUgPT09IEtFWV9DT0RFLlJJR0hUX0FSUk9XKSB7XG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICB0aGlzLm9wZW5Qb3BvdmVyKCk7XG4gICAgICAgICAgICB0aGlzLmF0dGFjaGVkUG9wb3Zlci5fa2V5Rm9jdXModHJ1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiogR2V0cyB3aGV0aGVyIHRoZSBwb3BvdmVyIGlzIHByZXNlbnRseSBvcGVuLiAqL1xuICAgIGlzUG9wb3Zlck9wZW4oKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9hbmNob3JpbmcuaXNQb3BvdmVyT3BlbigpO1xuICAgIH1cblxuICAgIC8qKiBUb2dnbGVzIHRoZSBwb3BvdmVyIGJldHdlZW4gdGhlIG9wZW4gYW5kIGNsb3NlZCBzdGF0ZXMuICovXG4gICAgdG9nZ2xlUG9wb3ZlcigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fYW5jaG9yaW5nLnRvZ2dsZVBvcG92ZXIoKTtcbiAgICB9XG5cbiAgICAvKiogT3BlbnMgdGhlIHBvcG92ZXIuICovXG4gICAgb3BlblBvcG92ZXIob3B0aW9uczogSGNQb3BvdmVyT3Blbk9wdGlvbnMgPSB7fSk6IHZvaWQge1xuICAgICAgICB0aGlzLl9hbmNob3Jpbmcub3BlblBvcG92ZXIob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgLyoqIENsb3NlcyB0aGUgcG9wb3Zlci4gKi9cbiAgICBjbG9zZVBvcG92ZXIodmFsdWU/OiBhbnksIG5laWdoYm9yU3ViTWVudXNBcmVPcGVuOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fYW5jaG9yaW5nLmNsb3NlUG9wb3Zlcih2YWx1ZSwgbmVpZ2hib3JTdWJNZW51c0FyZU9wZW4pO1xuICAgIH1cblxuICAgIC8qKiBSZWFsaWduIHRoZSBwb3BvdmVyIHRvIHRoZSBhbmNob3IuICovXG4gICAgcmVhbGlnblBvcG92ZXIoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2FuY2hvcmluZy5yZWFsaWduUG9wb3ZlclRvQW5jaG9yKCk7XG4gICAgfVxuXG4gICAgLyoqIEdldCBhIHJlZmVyZW5jZSB0byB0aGUgYW5jaG9yIGVsZW1lbnQuICovXG4gICAgZ2V0RWxlbWVudCgpOiBFbGVtZW50UmVmIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VsZW1lbnRSZWY7XG4gICAgfVxuXG4gICAgLyoqIFRocm93cyBhbiBlcnJvciBpZiB0aGUgcG9wb3ZlciBpbnN0YW5jZSBpcyBub3QgcHJvdmlkZWQuICovXG4gICAgcHJpdmF0ZSBfdmFsaWRhdGVBdHRhY2hlZFBvcG92ZXIocG9wb3ZlcjogSGNQb3BDb21wb25lbnQpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFwb3BvdmVyIHx8ICEocG9wb3ZlciBpbnN0YW5jZW9mIEhjUG9wQ29tcG9uZW50KSkge1xuICAgICAgICAgICAgdGhyb3cgZ2V0SW52YWxpZFBvcG92ZXJFcnJvcigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIFRocm93cyBhbiBlcnJvciBpZiB0aGUgdHJpZ2dlciBpcyBub3QgYSB2YWxpZCBIY1BvcG92ZXJUcmlnZ2VyLiAqL1xuICAgIHByaXZhdGUgX3ZhbGlkYXRlVHJpZ2dlcih0cmlnOiBIY1BvcG92ZXJUcmlnZ2VyKTogdm9pZCB7XG4gICAgICAgIGlmIChWQUxJRF9UUklHR0VSLmluZGV4T2YodHJpZykgPT09IC0xKSB7XG4gICAgICAgICAgICB0aHJvdyBnZXRJbnZhbGlkVHJpZ2dlckVycm9yKHRyaWcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIERpc3BhdGNoIGEgbm90aWZpY2F0aW9uIHRvIHRoZSBub3RpZmljYXRpb24gc2VydmljZSwgaWYgcG9zc2libGUuICovXG4gICAgcHJpdmF0ZSBfZGlzcGF0Y2hDb25maWdOb3RpZmljYXRpb24obm90aWZpY2F0aW9uOiBQb3BvdmVyTm90aWZpY2F0aW9uKSB7XG4gICAgICAgIGlmICh0aGlzLl9ub3RpZmljYXRpb25zKSB7XG4gICAgICAgICAgICB0aGlzLl9ub3RpZmljYXRpb25zLmRpc3BhdGNoKG5vdGlmaWNhdGlvbik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIF9zZXR1cEtleWJvYXJkRXZlbnRzKCkge1xuICAgICAgICBjb25zdCBub3RpZmllcjogSGNQb3BLZXlib2FyZE5vdGlmaWVyID0ge1xuICAgICAgICAgICAgaXNPcGVuOiBmYWxzZSxcbiAgICAgICAgICAgIG5hdGl2ZUVsZW1lbnQ6IHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCxcbiAgICAgICAgICAgIGhhc1N1Ym1lbnU6ICgpID0+IHRoaXMuX2hhc1N1Ym1lbnUsXG4gICAgICAgICAgICBvbktleURvd246IGV2ZW50ID0+IHRoaXMuX2tleUV2ZW50KGV2ZW50KVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnBvcG92ZXJDbG9zZWQuYXNPYnNlcnZhYmxlKCkuc3Vic2NyaWJlKCgpID0+IChub3RpZmllci5pc09wZW4gPSBmYWxzZSkpO1xuICAgICAgICB0aGlzLnBvcG92ZXJPcGVuZWQuYXNPYnNlcnZhYmxlKCkuc3Vic2NyaWJlKCgpID0+IChub3RpZmllci5pc09wZW4gPSB0cnVlKSk7XG4gICAgICAgIHRoaXMuX2FjY2Vzc2liaWxpdHkucmVnaXN0ZXJOb3RpZmllcihub3RpZmllcik7XG4gICAgfVxufVxuIl19